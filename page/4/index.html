<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Learning about Rust&amp;Solana">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Learning about Rust&amp;Solana">
<meta property="og:locale">
<meta property="article:author" content="QsunOu">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/page/4/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/03/Rust-lesson-22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/03/Rust-lesson-22/" itemprop="url">Rust lesson 22 - 闭包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-11-03T20:42:54+08:00">
                2024-11-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-闭包："><a href="#What-is-闭包：" class="headerlink" title="What is 闭包："></a>What is 闭包：</h1><p>闭包（closures）是一种匿名函数，可以捕获其定义环境中的变量。匿名函数（anonymous functions）是没有名字的函数。它们通常在需要临时使用的场合下定义和使用，而不是像普通函数那样有一个固定的名称。</p>
<h2 id="闭包基本语法："><a href="#闭包基本语法：" class="headerlink" title="闭包基本语法："></a>闭包基本语法：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个函数就没有名字，就只有内容，然后可以返回值给某个变量</span></span><br><span class="line">|参数<span class="number">1</span>, 参数<span class="number">2</span>, ..., 参数N| <span class="punctuation">-&gt;</span> 返回类型 &#123; </span><br><span class="line">    <span class="comment">// 闭包体</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">add_x</span> = |y: <span class="type">i32</span>| <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; x + y &#125;; <span class="comment">//这里就捕获了环境中的变量x</span></span><br><span class="line">    <span class="comment">//let add_x = |y| x + y;  省略写法，编译器会自己推断类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">add_x</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Result: &#123;&#125;&quot;</span>, result); <span class="comment">// 输出 &quot;Result: 8&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="闭包的特点："><a href="#闭包的特点：" class="headerlink" title="闭包的特点："></a>闭包的特点：</h2><ol>
<li>匿名性：闭包没有名称，通常被赋值给变量或作为参数传递。</li>
<li>捕获环境：闭包可以捕获其定义环境中的变量。</li>
<li>类型推断：Rust 编译器可以自动推断闭包的参数类型和返回类型。</li>
<li>灵活的捕获模式：闭包可以通过三种不同的方式捕获环境中的变量：move、copy 和 borrow。</li>
</ol>
<h1 id="闭包的使用："><a href="#闭包的使用：" class="headerlink" title="闭包的使用："></a>闭包的使用：</h1><h2 id="作为函数参数："><a href="#作为函数参数：" class="headerlink" title="作为函数参数："></a>作为函数参数：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//接受一个泛型参数 `F`</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">apply_to_3</span>&lt;F&gt;(f: F) <span class="punctuation">-&gt;</span> <span class="type">i32</span> </span><br><span class="line"><span class="comment">//要求 `F` 实现 `Fn(i32) -&gt; i32`,即 `F` 必须是一个接受一个 `i32` 参数并返回一个 `i32` 的函数或闭包。</span></span><br><span class="line"><span class="keyword">where</span> F : <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line"><span class="comment">//调用传入的函数或闭包 f，并将 3 作为参数传递给它</span></span><br><span class="line">	<span class="title function_ invoke__">f</span>(<span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">double</span> = |x| x * <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,<span class="title function_ invoke__">apply_to_3</span>(double));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出6</span></span><br></pre></td></tr></table></figure>

<h2 id="捕获环境变量"><a href="#捕获环境变量" class="headerlink" title="捕获环境变量"></a>捕获环境变量</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">closure</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="comment">//x 在equal_to_x作用域外 依然被捕获</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">equal_to_x</span> = |z | z==x;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="title function_ invoke__">closure</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="闭包三种捕获方式："><a href="#闭包三种捕获方式：" class="headerlink" title="闭包三种捕获方式："></a>闭包三种捕获方式：</h1><h2 id="引用捕获："><a href="#引用捕获：" class="headerlink" title="引用捕获："></a>引用捕获：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">closure</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="comment">//x 在equal_to_x作用域外 依然被捕获</span></span><br><span class="line">    <span class="comment">//闭包 equal_to_x 内部保存了对 x 的引用，而不是复制 x 的值。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">equal_to_x</span> = |z | z==x;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">assert!</span>(<span class="title function_ invoke__">equal_to_x</span>(y));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="按可变引用捕获："><a href="#按可变引用捕获：" class="headerlink" title="按可变引用捕获："></a>按可变引用捕获：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">closure</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> =<span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">change_num</span> = |x | num += x;</span><br><span class="line">    <span class="title function_ invoke__">change_num</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;num: &#123;&#125;&quot;</span>, num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="移动（Move）捕获："><a href="#移动（Move）捕获：" class="headerlink" title="移动（Move）捕获："></a>移动（Move）捕获：</h2><p>就是所有权移动了</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">print_s</span> = <span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;s is: &#123;&#125;&quot;</span>, s);</span><br><span class="line">    <span class="title function_ invoke__">print_s</span>(); <span class="comment">// 输出 &quot;s is: hello&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面这行代码会报错，因为 s 的所有权已经被移动到闭包中</span></span><br><span class="line">    <span class="comment">// println!(&quot;s is: &#123;&#125;&quot;, s);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="Move-关键字："><a href="#Move-关键字：" class="headerlink" title="Move 关键字："></a>Move 关键字：</h1><p><code>move</code> 关键字用于强制闭包获取其捕获的环境变量的所有权，而不是仅仅借用这些变量。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">closure</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">x</span> = <span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">equal_to_x</span> = <span class="keyword">move</span> |z| z==x;</span><br><span class="line">    <span class="comment">//x 没有所有权</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;can&#x27;t use x here: &#123;:?&#125;&quot;</span>, x);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/03/Rust-lesson-21/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/03/Rust-lesson-21/" itemprop="url">Rust lesson 21 - 宏</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-11-03T17:16:46+08:00">
                2024-11-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-宏："><a href="#What-is-宏：" class="headerlink" title="What is 宏："></a>What is 宏：</h1><p>宏允许你在编译时生成或修改代码。宏提供了一种灵活的方式来扩展语言的功能，使你可以编写更简洁、更通用的代码。Rust 中的宏分为两种类型：声明式宏（declarative macros）和过程宏（procedural macros）。</p>
<h1 id="声明宏："><a href="#声明宏：" class="headerlink" title="声明宏："></a>声明宏：</h1><p>声明式宏是最常见的宏形式，使用 <code>macro_rules!</code> 定义。它们通过模式匹配来匹配和转换代码片段。声明式宏的主要特点是语法简单，但功能相对有限。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span> () &#123;</span><br><span class="line">    <span class="comment">//宏后面的括号用啥括号都可以，建议()</span></span><br><span class="line">    say_hello!();</span><br><span class="line">    say_hello![<span class="number">1</span>];</span><br><span class="line">    say_hello!&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">macro_category</span>() &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义一个宏,</span></span><br><span class="line"><span class="comment">#[macro_export]</span></span><br><span class="line"><span class="comment">macro_rules! xxx &#123;</span></span><br><span class="line"><span class="comment">    () =&gt; &#123;</span></span><br><span class="line"><span class="comment">        xxx</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">&#125;  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> say_hello &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//可增加 $x:expr 来匹配表达式</span></span><br><span class="line">    <span class="comment">//可增加多几个`() =&gt; &#123;&#125;` 来匹配多个不同参数</span></span><br><span class="line">    ($x:expr) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, $x);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fn echo对比宏，只能匹配固定数量参数，现在只能匹配一个</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">echo</span>(a: <span class="type">usize</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="过程宏："><a href="#过程宏：" class="headerlink" title="过程宏："></a>过程宏：</h1><p>过程宏通常用于生成复杂的代码逻辑或实现自定义属性和派生宏。一般很少去写，都是了解常用的，然后熟练运用。</p>
<h2 id="3种类型的过程宏"><a href="#3种类型的过程宏" class="headerlink" title="3种类型的过程宏"></a>3种类型的过程宏</h2><ol>
<li><strong>属性宏（Attribute-like macros）</strong>：用于注解模块、结构体、枚举等。</li>
<li><strong>函数样式的宏（Function-like macros）</strong>：类似于函数调用，但可以生成任意代码。</li>
<li><strong>派生宏（Derive macros）</strong>：用于自动实现某些 trait。</li>
</ol>
<h2 id="属性宏："><a href="#属性宏：" class="headerlink" title="属性宏："></a>属性宏：</h2><h3 id="常用属性宏和用途："><a href="#常用属性宏和用途：" class="headerlink" title="常用属性宏和用途："></a>常用属性宏和用途：</h3><p><strong><code>#[derive]</code></strong>:</p>
<ul>
<li><p><strong>用途</strong>: 自动为结构体或枚举实现特定的 trait。<br><strong><code>#[cfg]</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 条件编译，根据编译时的条件选择性地包含或排除代码。<br><strong><code>#[test]</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 标记一个函数为测试函数，可以在运行 <code>cargo test</code> 时执行。<br><strong><code>#[derive(Copy, Clone)]</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 自动为结构体或枚举实现 <code>Copy</code> 和 <code>Clone</code> trait。</p>
</li>
</ul>
<p><strong><code>#[derive(Serialize, Deserialize)]</code></strong>:</p>
<ul>
<li><strong>用途</strong>: 使用 <code>serde</code> 库自动为结构体或枚举实现序列化和反序列化。</li>
</ul>
<h2 id="函数样式的宏："><a href="#函数样式的宏：" class="headerlink" title="函数样式的宏："></a>函数样式的宏：</h2><h3 id="常用函数样式的宏："><a href="#常用函数样式的宏：" class="headerlink" title="常用函数样式的宏："></a>常用函数样式的宏：</h3><p><strong><code>println!</code></strong>:</p>
<ul>
<li><p><strong>用途</strong>: 打印格式化的字符串到标准输出。<br><strong><code>format!</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 创建一个格式化的字符串，但不打印，而是返回一个 <code>String</code>。<br><strong><code>vec!</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 创建一个 <code>Vec</code>。<br><strong><code>stringify!</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 将表达式转换为字符串字面量。<br><strong><code>assert!</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 断言一个布尔表达式为真，否则触发 panic。<br><strong><code>assert_eq!</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 断言两个值相等，否则触发 panic。<br><strong><code>panic!</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 触发一个 panic。<br><strong><code>env!</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 获取环境变量的值。</p>
</li>
</ul>
<h2 id="派生宏"><a href="#派生宏" class="headerlink" title="派生宏"></a>派生宏</h2><h3 id="常用派生宏："><a href="#常用派生宏：" class="headerlink" title="常用派生宏："></a>常用派生宏：</h3><p><strong><code>#[derive(Debug)]</code></strong>:</p>
<ul>
<li><strong>用途</strong>: 自动实现 <code>Debug</code> trait，用于格式化输出结构体或枚举的内容。</li>
</ul>
<p><strong><code>#[derive(PartialEq, Eq)]</code></strong>:</p>
<ul>
<li><p><strong>用途</strong>: 自动实现 <code>PartialEq</code> 和 <code>Eq</code> trait，用于比较结构体或枚举的相等性。<br><strong><code>#[derive(PartialOrd, Ord)]</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 自动实现 <code>PartialOrd</code> 和 <code>Ord</code> trait，用于比较结构体或枚举的顺序。<br><strong><code>#[derive(Copy, Clone)]</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 自动实现 <code>Copy</code> 和 <code>Clone</code> trait，用于复制结构体或枚举。<br><strong><code>#[derive(Hash)]</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 自动实现 <code>Hash</code> trait，用于将结构体或枚举哈希化。<br><strong><code>#[derive(Serialize, Deserialize)]</code></strong>:</p>
</li>
<li><p><strong>用途</strong>: 使用 <code>serde</code> 库自动实现序列化和反序列化。</p>
</li>
</ul>
<p><strong><code>#[derive(Default)]</code></strong>:</p>
<ul>
<li><strong>用途</strong>: 自动实现 <code>Default</code> trait，用于提供默认值。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/03/Rust-lesson-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/03/Rust-lesson-20/" itemprop="url">Rust lesson 20 - 特征（trait）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-11-03T17:02:55+08:00">
                2024-11-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-trait："><a href="#What-is-trait：" class="headerlink" title="What is trait："></a>What is <code>trait</code>：</h1><p><code>trait</code> 是一种定义共享行为的方法。它类似于其他编程语言中的接口（interface），但有一些独特的特点。<code>trait</code> 允许你定义一组方法签名，然后可以在具体的类型上实现这些方法。这样，你可以为不同的类型提供相同的行为，从而实现多态性和代码重用。</p>
<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><ol>
<li><p>**定义 <code>trait</code>**：</p>
<ul>
<li>使用 <code>trait</code> 关键字定义一个 <code>trait</code>，并在其中声明方法签名。</li>
<li>这些方法签名定义了该 <code>trait</code> 应该提供的行为。</li>
</ul>
</li>
<li><p>**实现 <code>trait</code>**：</p>
<ul>
<li>使用 <code>impl</code> 关键字为具体的类型实现 <code>trait</code>。</li>
<li>在实现中，你需要提供 <code>trait</code> 中声明的方法的具体实现。</li>
</ul>
</li>
<li><h2 id="使用-trait-：-通过-trait-约束泛型参数，确保泛型参数实现了特定的-trait。-使用-trait-对象（如-Box-或-dyn-Trait）来实现动态分派。"><a href="#使用-trait-：-通过-trait-约束泛型参数，确保泛型参数实现了特定的-trait。-使用-trait-对象（如-Box-或-dyn-Trait）来实现动态分派。" class="headerlink" title="**使用 trait**： - 通过 trait 约束泛型参数，确保泛型参数实现了特定的 trait。 - 使用 trait 对象（如 Box&lt;dyn Trait&gt; 或 &amp;dyn Trait）来实现动态分派。"></a>**使用 <code>trait</code>**：<br><br> - 通过 <code>trait</code> 约束泛型参数，确保泛型参数实现了特定的 <code>trait</code>。<br> - 使用 <code>trait</code> 对象（如 <code>Box&lt;dyn Trait&gt;</code> 或 <code>&amp;dyn Trait</code>）来实现动态分派。</h2></li>
</ol>
<p><strong>基础使用示例</strong>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">post</span> = Post &#123;</span><br><span class="line">        title: <span class="string">&quot;Rust&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        author: <span class="string">&quot;ou&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        content: <span class="string">&quot;Rust is great&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">weibo</span> = Weibo &#123;</span><br><span class="line">        username: <span class="string">&quot;ou&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        content: <span class="string">&quot;you should learn rust&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,post.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,weibo.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个trait</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span>  <span class="title class_">Post</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> title: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> author: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> content: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为Post实现trait中的方法</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;文章&#123;&#125;: 作者是&#123;&#125;&quot;</span>, <span class="keyword">self</span>.title, <span class="keyword">self</span>.author)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span>  <span class="keyword">struct</span>  <span class="title class_">Weibo</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> username: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> content: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为Weibo实现trait中的方法</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Weibo</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125; 发表了微博&#123;&#125;&quot;</span>, <span class="keyword">self</span>.username, <span class="keyword">self</span>.content)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="特征定义与实现的位置（孤儿规则）"><a href="#特征定义与实现的位置（孤儿规则）" class="headerlink" title="特征定义与实现的位置（孤儿规则）"></a>特征定义与实现的位置（孤儿规则）</h1><p>孤儿规则的主要目的是防止第三方库之间的冲突，确保每个库都可以独立地定义和实现自己的 trait，而不会相互干扰。</p>
<h3 id="规则的具体内容"><a href="#规则的具体内容" class="headerlink" title="规则的具体内容"></a>规则的具体内容</h3><ol>
<li><strong>本地类型</strong>：如果你正在为一个本地定义的类型实现一个外部 trait，这是允许的。</li>
<li><strong>外部类型和外部 trait</strong>：如果你正在为一个外部类型实现一个外部 trait，这是不允许的，除非你满足孤儿规则。</li>
<li><strong>外部类型和本地 trait</strong>：如果你正在为一个外部类型实现一个本地定义的 trait，这是允许的。</li>
</ol>
<p>代码示例：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Summary和post都在本作用域</span></span><br><span class="line"> <span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">            <span class="string">&quot;ok&quot;</span>.<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Post在当前作用域，Display是标准库作用域,这样是可以的</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Display</span> <span class="keyword">for</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> std::fmt::Formatter&lt;<span class="symbol">&#x27;_</span>&gt;) <span class="punctuation">-&gt;</span> std::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">       <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//impl Display for String &#123;&#125;  这样不行会报错，因为Display和String 没一个在本作用域</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h1 id="默认实现"><a href="#默认实现" class="headerlink" title="默认实现"></a>默认实现</h1><h2 id="1-其他类型无需再实现该方法，也可以选择重载该方法"><a href="#1-其他类型无需再实现该方法，也可以选择重载该方法" class="headerlink" title="1.其他类型无需再实现该方法，也可以选择重载该方法"></a>1.其他类型无需再实现该方法，也可以选择重载该方法</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个trait</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    <span class="comment">//fn summarize(&amp;self) -&gt; String;</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span>&#123;</span><br><span class="line">        <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;default&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为Post实现trait中的方法</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">    <span class="comment">//如果把这个fn删掉，那么会调用默认的实现，也就是trait里面那个</span></span><br><span class="line">    <span class="comment">//fn summarize(&amp;self) -&gt; String &#123;</span></span><br><span class="line">    <span class="comment">//    format!(&quot;文章&#123;&#125;: 作者是&#123;&#125;&quot;, self.title, self.author)</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Weibo</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125; 发表了微博&#123;&#125;&quot;</span>, <span class="keyword">self</span>.username, <span class="keyword">self</span>.content)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,post.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,weibo.<span class="title function_ invoke__">summarize</span>());</span><br></pre></td></tr></table></figure>

<h2 id="2-默认实现允许调用相同特征中的其他方法，哪怕这些方法默认没有实现。"><a href="#2-默认实现允许调用相同特征中的其他方法，哪怕这些方法默认没有实现。" class="headerlink" title="2.默认实现允许调用相同特征中的其他方法，哪怕这些方法默认没有实现。"></a>2.默认实现允许调用相同特征中的其他方法，哪怕这些方法默认没有实现。</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">	<span class="keyword">fn</span> <span class="title function_">summarize_author</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">		<span class="built_in">format!</span>(<span class="string">&quot;Read more from &#123;&#125;...&quot;</span>,<span class="keyword">self</span>.<span class="title function_ invoke__">summarize_author</span>())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Weibo</span> &#123;</span><br><span class="line">	<span class="keyword">fn</span> <span class="title function_">summarize_author</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">		<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,<span class="keyword">self</span>.username)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;1 new weibo: &#123;&#125;&quot;</span>, weibo.<span class="title function_ invoke__">summarize</span>());</span><br></pre></td></tr></table></figure>

<h1 id="带泛型的trait"><a href="#带泛型的trait" class="headerlink" title="带泛型的trait"></a>带泛型的trait</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//泛型trait</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Convert</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">convert</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyInt</span>(<span class="type">i32</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//impl实现了两次，分别为String和i32</span></span><br><span class="line"><span class="comment">// T转String</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Convert</span>&lt;<span class="type">String</span>&gt; <span class="keyword">for</span> <span class="title class_">MyInt</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">convert</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span>.<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// T转i32</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Convert</span>&lt;<span class="type">i32</span>&gt; <span class="keyword">for</span> <span class="title class_">MyInt</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">convert</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span> <span class="keyword">as</span> <span class="type">i32</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个实现是针对任何实现了 Default trait 的类型 T</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: <span class="built_in">Default</span>&gt; Convert&lt;T&gt; <span class="keyword">for</span> <span class="title class_">MyInt</span> &#123;</span><br><span class="line">    <span class="comment">//convert 方法返回 T 类型的默认值。T::default() 调用了 Default trait 的 default 方法。</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">convert</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        T::<span class="title function_ invoke__">default</span>()    </span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">my_int</span> = <span class="title function_ invoke__">MyInt</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记得显示写String，否则会报错，因为编译器不知道要用哪个类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">output</span>: <span class="type">String</span> = my_int.<span class="title function_ invoke__">convert</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,output);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">output</span>: <span class="type">i32</span> = my_int.<span class="title function_ invoke__">convert</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,output); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="关联类型"><a href="#关联类型" class="headerlink" title="关联类型"></a>关联类型</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关联类型,用这种就是为了限制只能实现某一种类型，不能同时实现两种</span></span><br><span class="line"><span class="comment">// type xxx;</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Convert</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">convert</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>::Output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyInt</span>(<span class="type">i32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Convert</span> <span class="keyword">for</span> <span class="title class_">MyInt</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span> = <span class="type">String</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">convert</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span>.<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// type Output 只能实现一种类型，不能实现两种</span></span><br><span class="line"><span class="comment">// String 和 i32 同时存在会报错</span></span><br><span class="line"><span class="comment">/* impl Convert for MyInt &#123;</span></span><br><span class="line"><span class="comment">    type Output = i32;</span></span><br><span class="line"><span class="comment">    fn convert(&amp;self) -&gt; i32 &#123;</span></span><br><span class="line"><span class="comment">        self.0 as i32</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125; */</span> </span><br></pre></td></tr></table></figure>

<h1 id="自定义类型："><a href="#自定义类型：" class="headerlink" title="自定义类型："></a>自定义类型：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过这种方式，你可以为自定义类型提供加法操作，并且可以使用泛型函数来处理多种类型的数据。</span></span><br><span class="line"><span class="comment">//T: std::ops::Add&lt;Output = T&gt;,这个约束表示 T 必须实现了 Add trait，并且 Add trait 的 Output 类型必须是 T。</span></span><br><span class="line"><span class="comment">//Output = T 表示加法操作的结果类型必须是 T,接受任何实现了 Add trait 的类型，并返回相同类型的加法结果。</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add</span>&lt;T: std::ops::Add&lt;Output = T &gt;&gt;(a: T, b: T) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Add</span> <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="comment">//指定 Add trait 的 Output 类型为 Point</span></span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span> = Point;</span><br><span class="line">    <span class="comment">//实现 add 方法，接受另一个 Point 对象并返回一个新的 Point 对象</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(<span class="keyword">self</span>, other: Point) <span class="punctuation">-&gt;</span> Point &#123;</span><br><span class="line">        <span class="comment">//创建一个新的 Point 对象，其 x 和 y 分别是两个 Point 对象对应字段的和</span></span><br><span class="line">        Point&#123;</span><br><span class="line">            x: <span class="keyword">self</span>.x + other.x,</span><br><span class="line">            y: <span class="keyword">self</span>.y + other.y,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="使用特征作为函数参数"><a href="#使用特征作为函数参数" class="headerlink" title="使用特征作为函数参数"></a>使用特征作为函数参数</h1><h2 id="impl-Trait语法"><a href="#impl-Trait语法" class="headerlink" title="impl Trait语法"></a>impl Trait语法</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//impl Summary作为参数</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>(item: &amp;<span class="keyword">impl</span> <span class="title class_">Summary</span>) &#123;</span><br><span class="line">	<span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 还能通过 + 指定多个约束条件</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>(item: &amp;(<span class="keyword">impl</span> <span class="title class_">Summary</span> + Display)) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Trait-Bound-语法"><a href="#Trait-Bound-语法" class="headerlink" title="Trait Bound 语法"></a>Trait Bound 语法</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//impl Trait 和 trait bound作用一样，知识impl 更简化短小</span></span><br><span class="line"><span class="comment">//但trait bound 适用于更复杂场景</span></span><br><span class="line"><span class="comment">//假如有多个参数，trait bound能限制数据类型，但Impl不行</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>&lt;T: Summary&gt;(item: &amp;T) &#123;</span><br><span class="line">	<span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">notify</span>&lt;T: Summary + Display&gt;(item: &amp;T) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="where-简化trait-bound"><a href="#where-简化trait-bound" class="headerlink" title="where 简化trait bound"></a>where 简化trait bound</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//where 简化trait bound</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">notify1</span>(item1: &amp;(<span class="keyword">impl</span> <span class="title class_">Summary</span>), item2: &amp;(<span class="keyword">impl</span> <span class="title class_">Summary</span>)) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item1.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item2.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">notify2</span>&lt;T: Summary + Display&gt;(item1: &amp;T, item2: &amp;T) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item1.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item2.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//where其实就是把约束条件从fn notify3&lt;&gt;的&lt;&gt;里面，挪到外面来写，避免&lt;&gt;里面太长可读性差</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">notify3</span>&lt;T,U&gt;(item1: &amp;T, item2: &amp;U) </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    T: Summary + Display ,</span><br><span class="line">    U: Summary + Display + <span class="built_in">Debug</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item1.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Breaking news! &#123;&#125;&quot;</span>, item2.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h1 id="返回实现trait类型"><a href="#返回实现trait类型" class="headerlink" title="返回实现trait类型"></a>返回实现trait类型</h1><h2 id="impl-Trait-语法"><a href="#impl-Trait-语法" class="headerlink" title="impl Trait 语法"></a>impl Trait 语法</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回值中使用impl Trait，来返回实现了某个trait的类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">return_summarizable</span>() <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    Post &#123;</span><br><span class="line">        title: <span class="string">&quot;Rust&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        author: <span class="string">&quot;ou&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        content: <span class="string">&quot;Rust is great&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="特征对象"><a href="#特征对象" class="headerlink" title="特征对象"></a>特征对象</h2><p>指定某种指针如<code>&amp;</code>或<code>Box&lt;T&gt;</code>智能指针，还有<code>dyn</code>keyword, 以及指定相关的trait来创建trait对象。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 Box&lt;dyn Trait&gt; 允许你在运行时决定返回的具体类型，提供了更大的灵活性。</span></span><br><span class="line"><span class="comment">//封装性：隐藏了具体的类型信息，只暴露了实现的 trait，增加了代码的抽象性和封装性。</span></span><br><span class="line"><span class="comment">//Box&lt;dyn Summary&gt; 返回一个实现了 Summary trait 的动态类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">summarizeable</span>(switch: <span class="type">bool</span>) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Summary&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> switch &#123;</span><br><span class="line">       <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Post &#123;</span><br><span class="line">        title: <span class="string">&quot;Rust&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        author: <span class="string">&quot;ou&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        content: <span class="string">&quot;Rust is great&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Weibo &#123;</span><br><span class="line">            username: <span class="string">&quot;ou&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            content: <span class="string">&quot;you should learn rust&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/01/Rust-lesson-19/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/01/Rust-lesson-19/" itemprop="url">Rust lesson 19 - 智能指针 `Rc<T>`、`RefCell<T>`、`Weak<T>`</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-11-01T20:14:36+08:00">
                2024-11-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Rc："><a href="#Rc：" class="headerlink" title="Rc&lt;T&gt;："></a><code>Rc&lt;T&gt;</code>：</h1><h2 id="What-is-Rc"><a href="#What-is-Rc" class="headerlink" title="What is Rc&lt;T&gt;:"></a>What is <code>Rc&lt;T&gt;</code>:</h2><p><code>Rc&lt;T&gt;</code> 是 Rust 标准库中提供的一个智能指针类型，代表“引用计数”（Reference Counted）。它允许多个所有者共享同一数据，而无需使用互斥锁或其他同步机制。</p>
<h2 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h2><ol>
<li><p><strong>共享所有权</strong>：</p>
<ul>
<li><code>Rc&lt;T&gt;</code> 允许多个所有者共享同一数据。</li>
<li>每个 <code>Rc&lt;T&gt;</code> 实例都增加数据的引用计数。</li>
</ul>
</li>
<li><p><strong>引用计数</strong>：</p>
<ul>
<li><code>Rc&lt;T&gt;</code> 维护一个引用计数器，记录有多少个 <code>Rc&lt;T&gt;</code> 实例指向同一数据。</li>
<li>当引用计数为零时，数据会被自动释放。</li>
</ul>
</li>
<li><p><strong>不可变性</strong>：</p>
<ul>
<li>默认情况下，<code>Rc&lt;T&gt;</code> 提供的数据是不可变的。</li>
<li>如果需要内部可变性，可以结合 <code>RefCell&lt;T&gt;</code> 使用。</li>
</ul>
</li>
</ol>
<h2 id="代码示例："><a href="#代码示例：" class="headerlink" title="代码示例："></a>代码示例：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"><span class="keyword">use</span> crate::List::*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">    <span class="comment">//包含整数和指向下一个列表节点的 Rc 引用的节点。</span></span><br><span class="line">    <span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, Rc&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">study</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个包含两个节点的链表 a，节点值分别为 5 和 10</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">5</span>,Rc::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, Rc::<span class="title function_ invoke__">new</span>(Nil)))));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a: &#123;&#125;&quot;</span>,Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个新的节点 b，其值为 3，并指向 a，并共享所有权，a的引用计数加一</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">3</span>, Rc::<span class="title function_ invoke__">clone</span>(&amp;a));</span><br><span class="line">    <span class="comment">//Rc::strong_count 方法来获取关于a的 Rc 引用的强引用计数。强引用计数表示当前有多少个 Rc 引用指向同一个数据。</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b: &#123;&#125;&quot;</span>,Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个新的节点 c，其值为 4，并指向 a</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">4</span>, Rc::<span class="title function_ invoke__">clone</span>(&amp;a));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;c: &#123;&#125;&quot;</span>,Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,b);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,c);</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">study</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line">a: <span class="number">1</span>   <span class="comment">//a的引用计数是1</span></span><br><span class="line">b: <span class="number">2</span>   <span class="comment">//a的引用计数是2</span></span><br><span class="line">c: <span class="number">3</span>   <span class="comment">//a的引用计数是3</span></span><br><span class="line"><span class="title function_ invoke__">Cons</span>(<span class="number">5</span>, <span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, Nil))</span><br><span class="line"><span class="title function_ invoke__">Cons</span>(<span class="number">3</span>, <span class="title function_ invoke__">Cons</span>(<span class="number">5</span>, <span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, Nil)))</span><br><span class="line"><span class="title function_ invoke__">Cons</span>(<span class="number">4</span>, <span class="title function_ invoke__">Cons</span>(<span class="number">5</span>, <span class="title function_ invoke__">Cons</span>(<span class="number">10</span>, Nil)))</span><br></pre></td></tr></table></figure>

<h2 id="Rc-和-Box-指针的区别："><a href="#Rc-和-Box-指针的区别：" class="headerlink" title="Rc 和 Box 指针的区别："></a>Rc 和 Box 指针的区别：</h2><ol>
<li><p><strong>所有权</strong>：</p>
<ul>
<li><code>Box&lt;T&gt;</code> 是独占的，只能有一个所有者。</li>
<li><code>Rc&lt;T&gt;</code> 允许多个所有者共享同一数据。</li>
</ul>
</li>
<li><p><strong>内存管理</strong>：</p>
<ul>
<li><code>Box&lt;T&gt;</code> 在堆上分配内存，当 <code>Box&lt;T&gt;</code> 被丢弃时，其内部的数据也会被自动释放。</li>
<li><code>Rc&lt;T&gt;</code> 维护一个引用计数器，当引用计数为零时，数据会被自动释放。</li>
</ul>
</li>
<li><p><strong>使用场景</strong>：</p>
<ul>
<li><code>Box&lt;T&gt;</code> 适用于需要在堆上分配数据的情况，特别是大型数据结构。</li>
<li><code>Rc&lt;T&gt;</code> 适用于需要在多个所有者之间共享数据的情况，避免不必要的数据拷贝。</li>
</ul>
</li>
<li><p><strong>内部可变性</strong>：</p>
<ul>
<li>如果需要内部可变性，两者都可以结合 <code>RefCell&lt;T&gt;</code> 使用。</li>
</ul>
</li>
</ol>
<h1 id="RefCell"><a href="#RefCell" class="headerlink" title="RefCell&lt;T&gt;"></a><code>RefCell&lt;T&gt;</code></h1><h2 id="What-is-RefCell"><a href="#What-is-RefCell" class="headerlink" title="What is RefCell&lt;T&gt;:"></a>What is <code>RefCell&lt;T&gt;</code>:</h2><p><code>RefCell&lt;T&gt;</code> 是 Rust 标准库中提供的一个智能指针类型，用于实现内部可变性（Interior Mutability）。它允许你在编译时不可变的情况下，在运行时进行可变性检查</p>
<h2 id="特点：-1"><a href="#特点：-1" class="headerlink" title="特点："></a>特点：</h2><ol>
<li><p><strong>内部可变性</strong>：</p>
<ul>
<li><code>RefCell&lt;T&gt;</code> 允许你在不可变引用的情况下修改数据。</li>
<li>这种特性在某些情况下非常有用，例如在 <code>Rc&lt;T&gt;</code> 中存储可变数据。</li>
</ul>
</li>
<li><p><strong>运行时借用检查</strong>：</p>
<ul>
<li><code>RefCell&lt;T&gt;</code> 在运行时（不是编译时）检查借用（引用）规则，确保在同一时间只有一个可变引用或多个不可变引用。</li>
<li>如果违反了这些规则，程序会在运行时 panic。</li>
</ul>
</li>
<li><p><strong>不可变引用</strong>：</p>
<ul>
<li>使用 <code>borrow</code> 方法获取不可变引用。</li>
<li>多个不可变引用可以同时存在。</li>
</ul>
</li>
<li><p><strong>可变引用</strong>：</p>
<ul>
<li>使用 <code>borrow_mut</code> 方法获取可变引用。</li>
</ul>
</li>
</ol>
<h2 id="代码示例：-1"><a href="#代码示例：-1" class="headerlink" title="代码示例："></a>代码示例：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">study</span>() &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">data</span> = RefCell::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="comment">//获取不可变引用</span></span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">//data.borrow() 获取一个不可变引用 Ref</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">value</span> = data.<span class="title function_ invoke__">borrow</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//可变引用</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//data.borrow_mut() 获取一个可变引用 RefMut。value可以做运算。</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">value</span> = data.<span class="title function_ invoke__">borrow_mut</span>();</span><br><span class="line">        *value += <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//再次获取不可变引用</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">value</span> = data.<span class="title function_ invoke__">borrow</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h2><ol>
<li><p><strong>运行时检查</strong>：</p>
<ul>
<li><code>RefCell&lt;T&gt;</code> 在运行时检查借用规则，确保在同一时间只有一个可变引用或多个不可变引用。</li>
<li>如果违反了这些规则，程序会在运行时 panic。</li>
</ul>
</li>
<li><p><strong>性能开销</strong>：</p>
<ul>
<li><code>RefCell&lt;T&gt;</code> 在运行时进行借用检查，可能会带来一些性能开销。</li>
<li>在性能敏感的应用中，应谨慎使用 <code>RefCell&lt;T&gt;</code>。</li>
</ul>
</li>
<li><p><strong>线程安全</strong>：</p>
<ul>
<li><code>RefCell&lt;T&gt;</code> 不是线程安全的，只能在单线程环境中使用。</li>
<li>如果需要在多线程环境中实现内部可变性，应使用 <code>Mutex&lt;T&gt;</code> 或 <code>RwLock&lt;T&gt;</code>。</li>
</ul>
</li>
</ol>
<h1 id="引用循环和内存泄露："><a href="#引用循环和内存泄露：" class="headerlink" title="引用循环和内存泄露："></a>引用循环和内存泄露：</h1><h2 id="代码示例：-2"><a href="#代码示例：-2" class="headerlink" title="代码示例："></a>代码示例：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    value: <span class="type">i32</span>,</span><br><span class="line">    next: <span class="type">Option</span>&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">study</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">first</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node&#123;value:<span class="number">1</span>, next: <span class="literal">None</span>&#125;));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">second</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node&#123;value:<span class="number">2</span>, next: <span class="literal">None</span>&#125;));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建引用循环，first指second,second指first</span></span><br><span class="line">    first.<span class="title function_ invoke__">borrow_mut</span>().next = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;second));</span><br><span class="line">    second.<span class="title function_ invoke__">borrow_mut</span>().next = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;first));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打印引用计数，然后发现很正常，查不出来</span></span><br><span class="line">    <span class="comment">//因为 Rc 的强引用计数只统计强引用的数量，而弱引用计数则统计弱引用的数量。</span></span><br><span class="line">    <span class="comment">//Rc::strong_count(&amp;first) 和 Rc::strong_count(&amp;second) 分别返回 first 和 second 的强引用计数。</span></span><br><span class="line">    <span class="comment">//Rc::weak_count(&amp;first) 和 Rc::weak_count(&amp;second) 分别返回 first 和 second 的弱引用计数。    </span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;first strong: &#123;:?&#125;,first weak: &#123;:?&#125;&quot;</span>,Rc::<span class="title function_ invoke__">strong_count</span>(&amp;first), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;first));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;second strong: &#123;:?&#125;,second weak: &#123;:?&#125;&quot;</span>,Rc::<span class="title function_ invoke__">strong_count</span>(&amp;second), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;second));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//再直接打印，发现一直循环，fatal runtime error: stack overflow</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, first);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line"><span class="comment">//first 的强引用计数是 2，因为 first 自身是一个引用，另一个引用来自 second 的 next 字段。</span></span><br><span class="line"><span class="comment">//first 没有弱引用.second 同理。</span></span><br><span class="line"><span class="comment">//first strong: 2, first weak: 0 </span></span><br><span class="line"><span class="comment">//second strong: 2, second weak: 0</span></span><br></pre></td></tr></table></figure>

<h1 id="Weak："><a href="#Weak：" class="headerlink" title="Weak&lt;T&gt;："></a><code>Weak&lt;T&gt;</code>：</h1><h2 id="What-is-Weak："><a href="#What-is-Weak：" class="headerlink" title="What is Weak："></a>What is Weak：</h2><p><code>Weak&lt;T&gt;</code> 是一种智能指针类型，用于打破由 <code>Rc&lt;T&gt;</code> 或 <code>Arc&lt;T&gt;</code> 创建的引用循环。<code>Weak&lt;T&gt;</code> 不增加强引用计数，因此不会阻止对象被释放。</p>
<h2 id="特点：-2"><a href="#特点：-2" class="headerlink" title="特点："></a>特点：</h2><ol>
<li><p><strong>不增加强引用计数</strong>：</p>
<ul>
<li><code>Weak&lt;T&gt;</code> 不增加被引用对象的强引用计数。</li>
<li>因此，<code>Weak&lt;T&gt;</code> 不会阻止对象被释放。</li>
</ul>
</li>
<li><p><strong>可升级</strong>：</p>
<ul>
<li><code>Weak&lt;T&gt;</code> 可以通过 <code>upgrade</code> 方法转换为 <code>Rc&lt;T&gt;</code> 或 <code>Arc&lt;T&gt;</code>。</li>
<li>如果对象已经被释放，<code>upgrade</code> 方法会返回 <code>None</code>。</li>
</ul>
</li>
<li><p><strong>打破引用循环</strong>：</p>
<ul>
<li><code>Weak&lt;T&gt;</code> 常用于打破由 <code>Rc&lt;T&gt;</code> 或 <code>Arc&lt;T&gt;</code> 创建的引用循环，避免内存泄漏。</li>
</ul>
</li>
</ol>
<h2 id="解决循环引用代码示例"><a href="#解决循环引用代码示例" class="headerlink" title="解决循环引用代码示例:"></a>解决循环引用代码示例:</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::&#123;Rc,Weak&#125;;</span><br><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    value: <span class="type">i32</span>,</span><br><span class="line">    <span class="comment">//next：指向下一个节点的强引用。</span></span><br><span class="line">    next: <span class="type">Option</span>&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,</span><br><span class="line">    <span class="comment">//prev：指向前一个节点的弱引用</span></span><br><span class="line">    prev: <span class="type">Option</span>&lt;Weak&lt;RefCell&lt;Node&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">study</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">first</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node&#123;value:<span class="number">1</span>, next: <span class="literal">None</span>, prev: <span class="literal">None</span>&#125;));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">second</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node&#123;value:<span class="number">2</span>, next: <span class="literal">None</span>, prev: <span class="literal">None</span>&#125;));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建引用循环</span></span><br><span class="line">    first.<span class="title function_ invoke__">borrow_mut</span>().next = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;second));</span><br><span class="line">    <span class="comment">//`second` 的 `prev` 字段指向 `first`，使用 `Weak` 引用来打破循环。</span></span><br><span class="line">    <span class="comment">//Rc::downgrade 创建一个 Weak&lt;T&gt; 实例</span></span><br><span class="line">    <span class="comment">//使用weak后，first 的强引用计数器是1（自身），而不是2</span></span><br><span class="line">    second.<span class="title function_ invoke__">borrow_mut</span>().prev = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">downgrade</span>(&amp;first));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打印引用计数，然后发现很正常，查不出来</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;first strong: &#123;:?&#125;,first weak: &#123;:?&#125;&quot;</span>,Rc::<span class="title function_ invoke__">strong_count</span>(&amp;first), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;first));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;second strong: &#123;:?&#125;,second weak: &#123;:?&#125;&quot;</span>,Rc::<span class="title function_ invoke__">strong_count</span>(&amp;second), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;second));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这回就正常多了</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, first);</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果：</span></span><br><span class="line">first strong: <span class="number">1</span>,first weak: <span class="number">1</span></span><br><span class="line">second strong: <span class="number">2</span>,second weak: <span class="number">0</span></span><br><span class="line">RefCell &#123; value: Node &#123; value: <span class="number">1</span>, next: <span class="title function_ invoke__">Some</span>(RefCell &#123; value: Node &#123; value: <span class="number">2</span>, next: <span class="literal">None</span>, prev: <span class="title function_ invoke__">Some</span>((Weak)) &#125; &#125;), prev: <span class="literal">None</span> &#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// drop(first) 以后会释放强引用，first强引用为0，节点被释放。</span></span><br><span class="line"><span class="comment">//second不会被释放，因为它的强引用从 2-&gt;1,不为0.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="强引用和弱引用区别："><a href="#强引用和弱引用区别：" class="headerlink" title="强引用和弱引用区别："></a>强引用和弱引用区别：</h1><h3 id="所有权"><a href="#所有权" class="headerlink" title="所有权"></a>所有权</h3><ol>
<li><p><strong>强引用</strong>：</p>
<ul>
<li>强引用拥有对象的所有权。</li>
<li>每个强引用都会增加对象的引用计数。</li>
<li>当最后一个强引用被释放时，对象的所有权被完全释放，对象会被销毁。</li>
</ul>
</li>
<li><p><strong>弱引用</strong>：</p>
<ul>
<li>弱引用不拥有对象的所有权。</li>
<li>弱引用不会增加对象的引用计数。</li>
<li>即使所有强引用都被释放，弱引用仍然可以存在，但它们不能再访问已销毁的对象。</li>
</ul>
</li>
</ol>
<h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><ol>
<li><p><strong>强引用</strong>：</p>
<ul>
<li>强引用使用引用计数来管理对象的生命周期。</li>
<li>每次创建一个新的强引用，引用计数加一。</li>
<li>每次释放一个强引用，引用计数减一。</li>
<li>当引用计数为零时，对象被销毁。</li>
</ul>
</li>
<li><p><strong>弱引用</strong>：</p>
<ul>
<li>弱引用不直接影响引用计数。</li>
<li>弱引用的存在不会阻止对象的销毁。</li>
<li>使用 <code>upgrade</code> 方法可以尝试将弱引用转换为强引用，如果对象已经销毁，则返回 <code>None</code>。</li>
</ul>
</li>
</ol>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><ol>
<li><p><strong>强引用</strong>：</p>
<ul>
<li>强引用确保对象在至少有一个强引用存在时不会被销毁。</li>
<li>对象的内存只有在所有强引用都被释放后才会被回收。</li>
<li>强引用适用于需要确保对象在整个生命周期内始终存在的场景。</li>
</ul>
</li>
<li><p><strong>弱引用</strong>：</p>
<ul>
<li>弱引用允许对象在没有任何强引用时被销毁，即使还有弱引用存在。</li>
<li>弱引用不会阻止对象的内存回收。</li>
<li>使用弱引用来访问对象时，需要先检查对象是否还存在（通过 <code>upgrade</code> 方法）。</li>
</ul>
</li>
</ol>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ol>
<li><p><strong>强引用</strong>：</p>
<ul>
<li><strong>共享所有权</strong>：当多个部分需要共享同一个数据结构且这些部分都需要确保数据在使用期间存在时。</li>
<li><strong>多线程共享</strong>：使用 <code>Arc&lt;T&gt;</code> 在多线程环境中安全地共享不可变数据。</li>
<li><strong>资源管理</strong>：确保资源（如文件句柄、网络连接等）在不再需要时被正确释放。</li>
</ul>
</li>
<li><p><strong>弱引用</strong>：</p>
<ul>
<li><strong>避免循环引用</strong>：在有相互引用的数据结构中使用弱引用来避免内存泄漏。</li>
<li><strong>缓存</strong>：在缓存中使用弱引用来避免占用过多内存，当对象不再需要时可以自动清除。</li>
<li><strong>观察者模式</strong>：在实现观察者模式时，使用弱引用来避免观察者对象和被观察对象之间的循环引用。</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/01/Rust-lesson-18/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/11/01/Rust-lesson-18/" itemprop="url">Rust lesson 18 - 生命周期</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-11-01T17:09:40+08:00">
                2024-11-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="为什么需要生命周期注解？"><a href="#为什么需要生命周期注解？" class="headerlink" title="为什么需要生命周期注解？"></a>为什么需要生命周期注解？</h1><h2 id="引用的有效范围："><a href="#引用的有效范围：" class="headerlink" title="引用的有效范围："></a>引用的有效范围：</h2><p>当函数返回一个引用时，编译器需要确保这个引用在其生命周期内始终有效。<br>如果没有生命周期注解，编译器无法确定返回的引用 &amp;str 的生命周期与输入引用 x 和 y 的生命周期之间的关系。</p>
<h2 id="悬垂引用："><a href="#悬垂引用：" class="headerlink" title="悬垂引用："></a>悬垂引用：</h2><p>悬垂引用是指指向已经释放的内存的引用。这是非常危险的，因为它会导致未定义行为。<br>生命周期注解帮助编译器确保返回的引用在其生命周期内始终有效，从而避免悬垂引用。</p>
<h2 id="创建生命周期："><a href="#创建生命周期：" class="headerlink" title="创建生命周期："></a>创建生命周期：</h2><p>生命周期主要通过生命周期注解来创建和使用。使用显示声明，例如<code>&#39;a</code>这种单引号加字母的方式，至于字母是什么无所谓，有单引号就行。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#x27;a 是一个生命周期参数，表示 x 和 y 的生命周期至少与返回的引用的生命周期一样长</span></span><br><span class="line"><span class="comment">//x: &amp;&#x27;a str 和 y: &amp;&#x27;a str 表示 x 和 y 都是生命周期为 &#x27;a 的字符串切片</span></span><br><span class="line"><span class="comment">//-&gt; &amp;&#x27;a str 表示返回的字符串切片的生命周期也是 &#x27;a</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>()&#123;</span><br><span class="line">        x</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="生命周期类别："><a href="#生命周期类别：" class="headerlink" title="生命周期类别："></a>生命周期类别：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">example</span>&lt;<span class="symbol">&#x27;a</span>&gt;(input: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">    input</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Example</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    a: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">StringOption</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(&amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>),</span><br><span class="line">    <span class="literal">None</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt; StringOption &lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="特殊生命周期标注"><a href="#特殊生命周期标注" class="headerlink" title="特殊生命周期标注"></a>特殊生命周期标注</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//&#x27;static 是特殊的生命周期。</span></span><br><span class="line"><span class="comment">//&#x27;static 是 Rust 中最长的生命周期，表示引用在整个程序的生命周期内都是有效的。(注意整个程序)，通常用于全局变量和字符串字面量。</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span>: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SOME_COORDINATE: (<span class="type">i32</span>, <span class="type">i32</span>) = (<span class="number">7</span>, <span class="number">4</span>);</span><br><span class="line"><span class="comment">//static_reference 是一个指向 SOME_COORDINATE 的引用，具有 &#x27;static 生命周期。</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">static_reference</span>: &amp;<span class="symbol">&#x27;static</span> (<span class="type">i32</span>, <span class="type">i32</span>) = &amp;SOME_COORDINATE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Counter</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    counter: &amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="type">i32</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//impl&lt;&#x27;a&gt; Counter&lt;&#x27;a&gt; 能简写成下面这样</span></span><br><span class="line"><span class="comment">//&#x27;_&#x27; 是一个匿名生命周期参数，表示编译器会自动推断出适当的生命周期。</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Counter</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">increment</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        *<span class="keyword">self</span>.counter += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/31/Rust-lesson-17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/31/Rust-lesson-17/" itemprop="url">Rust lesson 17 - 泛型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-10-31T21:04:04+08:00">
                2024-10-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-泛型："><a href="#What-is-泛型：" class="headerlink" title="What is 泛型："></a>What is 泛型：</h1><p>泛型（Generics）是编程语言中的一种特性，允许你在编写代码时使用占位符（类型参数）来代替具体的类型。通过以下使用场景，你就能理解是干什么的了。</p>
<h1 id="泛型使用场景："><a href="#泛型使用场景：" class="headerlink" title="泛型使用场景："></a>泛型使用场景：</h1><h2 id="泛型函数减少了代码重复，一个顶三个，简单示例："><a href="#泛型函数减少了代码重复，一个顶三个，简单示例：" class="headerlink" title="泛型函数减少了代码重复，一个顶三个，简单示例："></a>泛型函数减少了代码重复，一个顶三个，简单示例：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">add_i8</span>(a:<span class="type">i8</span>, b:<span class="type">i8</span>) <span class="punctuation">-&gt;</span> <span class="type">i8</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add_i32</span>(a:<span class="type">i32</span>, b:<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add_f64</span>(a:<span class="type">f64</span>, b:<span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//T 是一个泛型参数，表示任意类型,没啥特殊含义，你用ABCDEFG都行。</span></span><br><span class="line"><span class="comment">//std::ops::Add&lt;Output = T&gt; 是一个 trait 约束，表示类型 T 必须实现了 Add trait，并且加法操作的结果类型也是 T。</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add</span>&lt;T : std::ops::Add&lt;Output = T&gt;&gt;(a:T, b:T) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="comment">//2i8,就是2（i8类型）</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;add i8: &#123;&#125;&quot;</span>,<span class="title function_ invoke__">add_i8</span>(<span class="number">2i8</span>, <span class="number">3i8</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;add i32: &#123;&#125;&quot;</span>,<span class="title function_ invoke__">add_i32</span>(<span class="number">20</span>, <span class="number">30</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;add f64: &#123;&#125;&quot;</span>,<span class="title function_ invoke__">add_f64</span>(<span class="number">1.23</span>, <span class="number">1.23</span>));</span><br><span class="line">    <span class="title function_ invoke__">add</span>(<span class="number">2i8</span>, <span class="number">3i8</span>);</span><br><span class="line">    <span class="title function_ invoke__">add</span>(<span class="number">20</span>, <span class="number">30</span>);</span><br><span class="line">    <span class="title function_ invoke__">add</span>(<span class="number">1.23</span>, <span class="number">1.23</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="复杂一点的例子-比较大小-："><a href="#复杂一点的例子-比较大小-：" class="headerlink" title="复杂一点的例子(比较大小)："></a>复杂一点的例子(比较大小)：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//list: &amp;[T] 表示 list 是一个切片，切片是一个指向数组的引用，可以是任何长度的数组的一部分。</span></span><br><span class="line"><span class="comment">//-&gt; &amp;T 表示返回一个指向切片中元素的引用。</span></span><br><span class="line"><span class="comment">//通过实现 std::cmp::PartialOrd，可以在泛型函数或泛型结构中允许使用比较操作。</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">larget</span>&lt;T: std::cmp::<span class="built_in">PartialOrd</span>&gt;(list: &amp;[T])<span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">largest</span> = &amp;list[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> list &#123;</span><br><span class="line">        <span class="keyword">if</span> item &gt; largest &#123;</span><br><span class="line">            largest = item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  largest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">number_list</span> = <span class="built_in">vec!</span>[<span class="number">34</span>, <span class="number">50</span>, <span class="number">25</span>, <span class="number">100</span>, <span class="number">65</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">larget</span>(&amp;number_list);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The largest number is &#123;&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">char_list</span> = <span class="built_in">vec!</span>[<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;q&#x27;</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">larget</span>(&amp;char_list);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The largest char is &#123;&#125;&quot;</span>,result);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="结构体中使用泛型："><a href="#结构体中使用泛型：" class="headerlink" title="结构体中使用泛型："></a>结构体中使用泛型：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//T 和 U区分两个类型</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&lt;T,U&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: U,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = Point&#123;x:<span class="number">5</span> , y:<span class="number">10</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = Point&#123;x:<span class="number">1.0</span> , y:<span class="number">1.0</span>&#125;;</span><br><span class="line">    <span class="comment">//如果上面是struct是&lt;T&gt;,会报错，因为x和y是不同类型。</span></span><br><span class="line">    <span class="comment">//但写成&lt;T ,U&gt;,区分开不同类型，就不会报错。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p3</span> = Point&#123;x: <span class="number">5</span>, y: <span class="number">4.0</span>&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="枚举中用泛型："><a href="#枚举中用泛型：" class="headerlink" title="枚举中用泛型："></a>枚举中用泛型：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Option</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="title function_ invoke__">Some</span>(T),</span><br><span class="line">	<span class="literal">None</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">	<span class="title function_ invoke__">Ok</span>(T),</span><br><span class="line">	<span class="title function_ invoke__">Err</span>(E),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现方法使用泛型："><a href="#实现方法使用泛型：" class="headerlink" title="实现方法使用泛型："></a>实现方法使用泛型：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&lt;T,U&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: U,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为结构体实现方法，使用泛型要在impl后面加&lt;T, U&gt;</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T, U&gt; Point&lt;T,U&gt;&#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">x</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;T&#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.x</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//接受另一个 Point 实例 other，返回一个新的 Point 实例，其 x 字段来自 self，y 字段来自 other。</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">mixup</span>&lt;T2, U2&gt;(<span class="keyword">self</span>, other: Point&lt;T2, U2&gt;) <span class="punctuation">-&gt;</span> Point&lt;T, U2&gt; &#123;</span><br><span class="line">        Point &#123;</span><br><span class="line">            x: <span class="keyword">self</span>.x,</span><br><span class="line">            y: other.y,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">p4</span> = Point &#123; x:<span class="number">5</span> , y:<span class="number">10.4</span>&#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p5</span> = Point &#123; x: <span class="string">&quot;Hello&quot;</span>, y: <span class="string">&#x27;c&#x27;</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//p4的 x 和 p5的 y 混合</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p6</span> = p4.<span class="title function_ invoke__">mixup</span>(p5);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;p6.x is &#123;&#125;,p6.y is &#123;&#125;&quot;</span>,p6.x,p6.y);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* let p1 = Point&#123;x:5 , y:10 &#125;;</span></span><br><span class="line"><span class="comment">    let p2 = Point&#123;x:1.0 , y:1.0&#125;;</span></span><br><span class="line"><span class="comment">    let p3 = Point&#123;x: 5, y: 4.0&#125;; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="const使用泛型："><a href="#const使用泛型：" class="headerlink" title="const使用泛型："></a>const使用泛型：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">display_array</span>(arr: [<span class="type">i32</span>; <span class="number">3</span>]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接受一个切片arr（slice）,元素类型为 T 作为参数，并使用 std::fmt::Debug trait 将切片的内容打印出来</span></span><br><span class="line"><span class="comment">//切片是一个指向数组的引用，可以是任何长度的数组的一部分</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">display_array1</span>&lt;T: std::fmt::<span class="built_in">Debug</span>&gt;(arr: &amp;[T]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//const N: usize：这是一个常量泛型参数，表示数组的大小 N 是一个常量, 大小事 usize</span></span><br><span class="line"><span class="comment">//arr: [T; N]：函数接受一个固定大小的数组 arr，数组中的元素类型为 T，大小为 N</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">display_array2</span>&lt;T: std::fmt::<span class="built_in">Debug</span>, <span class="keyword">const</span> N: <span class="type">usize</span> &gt;(arr: [T; N]) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="title function_ invoke__">display_array</span>(arr); </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* //这样不行，因为display_array(arr: [i32; 3])</span></span><br><span class="line"><span class="comment">    let arr2: [i32; 2] = [1, 2];</span></span><br><span class="line"><span class="comment">    display_array(arr2); */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="title function_ invoke__">display_array1</span>(&amp;arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">    <span class="title function_ invoke__">display_array1</span>(&amp;arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="title function_ invoke__">display_array2</span>(arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">2</span>] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">    <span class="title function_ invoke__">display_array2</span>(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/31/Rust-lesson-16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/31/Rust-lesson-16/" itemprop="url">Rust lesson 16 - 智能指针 Box</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-10-31T14:43:37+08:00">
                2024-10-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-智能指针："><a href="#What-is-智能指针：" class="headerlink" title="What is 智能指针："></a>What is 智能指针：</h1><p>智能指针（Smart Pointer）是一种数据结构，它不仅包含一个指针，还附加了一些额外的信息和功能。智能指针的主要目的是管理指针的生命周期，自动处理内存的分配和释放，从而避免内存泄漏和其他常见的内存管理错误。</p>
<h1 id="智能指针特点："><a href="#智能指针特点：" class="headerlink" title="智能指针特点："></a>智能指针特点：</h1><ol>
<li>自动管理内存：<br>智能指针在不需要时会自动释放其所管理的资源，避免内存泄漏。</li>
<li>所有权和借用规则：<br>智能指针遵循 Rust 的所有权和借用规则，确保数据的安全性和一致性。</li>
<li>附加功能：<br>智能指针通常附带额外的功能，如引用计数、内部可变性、互斥锁等，以满足不同的需求。</li>
</ol>
<h1 id="基本概念之一："><a href="#基本概念之一：" class="headerlink" title="基本概念之一："></a>基本概念之一：</h1><p><code>Box&lt;T&gt;</code>智能指针：<br>    用途：用于在堆上分配内存。<br>    特点：当 Box 被丢弃时，它所指向的堆上的内存会被自动释放。</p>
<h1 id="Box-使用场景："><a href="#Box-使用场景：" class="headerlink" title="Box 使用场景："></a>Box 使用场景：</h1><h2 id="堆分配："><a href="#堆分配：" class="headerlink" title="堆分配："></a>堆分配：</h2><p><code>Box</code> 是一个智能指针，用于在堆上分配内存。当你使用 <code>Box::new</code> 创建一个 <code>Box</code> 时，它会在堆上分配内存，并返回一个指向该内存的指针</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,b); </span><br><span class="line">    <span class="comment">//或者println!(&quot;&#123;&#125;&quot;, *b);  *解引用 Box，获取内部的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动态大小类型："><a href="#动态大小类型：" class="headerlink" title="动态大小类型："></a>动态大小类型：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="comment">//into 方法在这里将字符串字面量转换为 Box&lt;str&gt;。</span></span><br><span class="line">	<span class="keyword">let</span> <span class="variable">s</span> : <span class="type">Box</span>&lt;<span class="type">str</span>&gt; = <span class="string">&quot;Hello&quot;</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将 Vec&lt;i32&gt; 转换为 Box&lt;[i32]&gt;。into_boxed_slice 方法将 Vec 转换为一个指向固定大小数组的 Box。</span></span><br><span class="line">	<span class="keyword">let</span> <span class="variable">arr</span> : <span class="type">Box</span>&lt;[<span class="type">i32</span>]&gt; = <span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].<span class="title function_ invoke__">into_boxed_slice</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="递归数据结构："><a href="#递归数据结构：" class="headerlink" title="递归数据结构："></a>递归数据结构：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">	<span class="comment">//Cons(i32, Box&lt;List&gt;)：表示一个包含整数和指向下一个 List 元素的智能指针的节点,像链表</span></span><br><span class="line">	<span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, <span class="type">Box</span>&lt;List&gt;),</span><br><span class="line">    Nil,</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//use List::&#123;Cons, Nil&#125;;：引入 Cons 和 Nil 变体，以便在 main 函数中直接使用</span></span><br><span class="line"><span class="keyword">use</span> List::&#123;Cons, Nil&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="comment">//创建一个包含两个元素的列表 [1, 2]。</span></span><br><span class="line">	<span class="keyword">let</span> <span class="variable">list</span> = List::<span class="title function_ invoke__">Cons</span>(<span class="number">1</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(List::<span class="title function_ invoke__">Cons</span>(<span class="number">2</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(List::Nil))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类型擦除（Type-Erasure）："><a href="#类型擦除（Type-Erasure）：" class="headerlink" title="类型擦除（Type Erasure）："></a>类型擦除（Type Erasure）：</h2><p>类型擦除是指在编译时将具体类型信息“擦除”，只保留一个通用的接口或 trait。这样，不同类型的对象可以通过相同的接口进行操作，而不需要知道它们的具体类型。</p>
<h3 id="动态调度（Dynamic-Dispatch）："><a href="#动态调度（Dynamic-Dispatch）：" class="headerlink" title="动态调度（Dynamic Dispatch）："></a>动态调度（Dynamic Dispatch）：</h3><p>动态调度是指在运行时确定调用哪个具体方法的过程。与之相对的是静态调度（也称为单态化），在编译时就确定了调用的具体方法。</p>
<h3 id="dyn关键字："><a href="#dyn关键字：" class="headerlink" title="dyn关键字："></a>dyn关键字：</h3><p><code>dyn</code>用于指定动态分发的类型，它允许在运行时决定具体类型（而不是像平时那样在编译的时候决定），用于实现动态分发的trait对象。</p>
<h3 id="问题背景："><a href="#问题背景：" class="headerlink" title="问题背景："></a>问题背景：</h3><p>由于静态类型系统和所有权模型，直接将不同类型的对象放入同一个集合（如 <code>Vec</code>）中是不允许的。这是因为 <code>Vec</code> 需要知道它存储的元素的具体类型和大小。为了解决这个问题，我们可以使用动态类型（如 <code>Box&lt;dyn Trait&gt;</code>）来存储实现了特定 trait 的不同类型的对象。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义了一个 speak 方法，所有实现了 Animal trait 的类型都必须实现这个方法。</span></span><br><span class="line"><span class="comment">//如果再加一个方法，下面的impl也一定要加</span></span><br><span class="line"><span class="keyword">trait</span>  <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dog</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cat</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//由于impl Animal，所以一定要实现speak</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;haba dog&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Cat</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;dudu cat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">box_study</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这样会报错</span></span><br><span class="line">    <span class="comment">//因为Dog 和 Cat 不是同一类型，所以报错</span></span><br><span class="line">    <span class="comment">//let animals = vec![Dog,Cat];     </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//dyn Animal表示实现了 Animal trait 的动态类型。</span></span><br><span class="line">    <span class="comment">//Box::new：将具体类型的对象转换为 Box&lt;dyn Animal&gt; 类型。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">animals</span> : <span class="type">Vec</span>&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> Animal&gt;&gt; = <span class="built_in">vec!</span>[<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Dog),<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Cat)];</span><br><span class="line">    <span class="comment">//iter（）方法遍历 Vec</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">animal</span> <span class="keyword">in</span> animals.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        animal.<span class="title function_ invoke__">speak</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="具体解释"><a href="#具体解释" class="headerlink" title="具体解释"></a>具体解释</h4><ol>
<li><p><strong>静态类型和大小</strong>：</p>
<ul>
<li>在 Rust 中，<code>Vec&lt;T&gt;</code> 需要知道它存储的元素的具体类型 <code>T</code> 和大小。这是为了确保内存布局和性能优化。</li>
<li>例如，<code>Vec&lt;Dog&gt;</code> 和 <code>Vec&lt;Cat&gt;</code> 是两个不同的类型，它们的元素大小和布局是固定的。</li>
</ul>
</li>
<li><p>**动态类型 <code>Box&lt;dyn Animal&gt;</code>**：</p>
<ul>
<li><code>Box&lt;dyn Animal&gt;</code> 是一个智能指针，指向实现了 <code>Animal</code> trait 的对象。<code>dyn Animal</code> 表示一个动态类型，它只知道对象实现了 <code>Animal</code> trait，但不知道具体类型。</li>
<li><code>Box&lt;dyn Animal&gt;</code> 的大小是固定的，因为它只是一个指针（通常是 8 字节或 16 字节，取决于平台）。</li>
</ul>
</li>
<li><p><strong>类型擦除</strong>：</p>
<ul>
<li>当你将 <code>Dog</code> 和 <code>Cat</code> 转换为 <code>Box&lt;dyn Animal&gt;</code> 时，具体类型信息被“擦除”，只剩下 <code>Animal</code> trait 的接口。</li>
<li>这意味着 <code>Box&lt;dyn Animal&gt;</code> 可以指向任何实现了 <code>Animal</code> trait 的对象，无论其具体类型是什么。</li>
</ul>
</li>
<li><p><strong>动态调度</strong>：</p>
<ul>
<li>当你调用 <code>animal.speak()</code> 时，Rust 运行时会根据 <code>Box&lt;dyn Animal&gt;</code> 指向的具体对象来确定调用哪个实现的 <code>speak</code> 方法。</li>
<li>这种动态调度是在运行时进行的，而不是在编译时确定的。</li>
</ul>
</li>
</ol>
<h2 id="内存管理和性能优化："><a href="#内存管理和性能优化：" class="headerlink" title="内存管理和性能优化："></a>内存管理和性能优化：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="comment">//Box::new([0u8; 1_000_000])：在堆上分配内存，适合处理大型数据结构，避免栈溢出。</span></span><br><span class="line">	<span class="comment">//Box::new([0u8; 1_000_000])：涉及堆分配和指针管理，可能会有轻微的性能开销。</span></span><br><span class="line">	<span class="keyword">let</span> <span class="variable">large_arr</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0u8</span>;<span class="number">1_000_000</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//[0u8; 1_000_000]：在栈上分配内存，适合处理较小的数据结构。</span></span><br><span class="line">	<span class="comment">//[0u8; 1_000_000]：直接在栈上分配内存，访问速度快，但栈空间有限。</span></span><br><span class="line">	<span class="keyword">let</span> <span class="variable">array</span> = [<span class="number">0u8</span>;<span class="number">1_000_000</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Box-的优缺点："><a href="#Box-的优缺点：" class="headerlink" title="Box 的优缺点："></a>Box 的优缺点：</h1><h2 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h2><ol>
<li>提供堆内存分配，支持复杂数据结构。</li>
<li>与Rust的所有权系统完美继承，确保内存安全</li>
<li>动态分配对象，实现类型擦除。</li>
</ol>
<h2 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h2><ol>
<li>需要堆内存分配和释放，可能带来性能开销。</li>
<li>不适合需要频繁分配和释放的场景。</li>
</ol>
<h1 id="Drop、Deref、DerefMut"><a href="#Drop、Deref、DerefMut" class="headerlink" title="Drop、Deref、DerefMut:"></a>Drop、Deref、DerefMut:</h1><h2 id="Drop"><a href="#Drop" class="headerlink" title="Drop:"></a>Drop:</h2><p><code>Drop</code> trait 用于定义当一个值离开作用域时（即被丢弃时）应该执行的清理操作。这对于资源管理非常有用，特别是对于那些需要显式释放资源的情况。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Resource</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Resource</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Dropping &#123;&#125;&quot;</span>,<span class="keyword">self</span>.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">_rest1</span> = Resource&#123; name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Resource 1&quot;</span>)&#125;;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_rest2</span> = Resource&#123; name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Resource 2&quot;</span>)&#125;;</span><br><span class="line">        <span class="comment">// rest 2 的 drop在离开作用域时隐式调用</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// rest 1 的 drop在离开作用域时隐式调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Deref"><a href="#Deref" class="headerlink" title="Deref:"></a>Deref:</h2><p><code>Deref</code> trait 用于实现解引用操作，即 <code>*</code> 操作符。通过实现 <code>Deref</code>，可以将自定义类型转换为不可变引用（<code>&amp;T</code>）。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个泛型结构体 MyBox，包含一个泛型字段 T。</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyBox</span>&lt;T&gt;(T);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt;MyBox&lt;T&gt; &#123;</span><br><span class="line">	<span class="comment">//为 MyBox 实现一个构造函数 new，接受一个泛型参数 x，返回一个 MyBox&lt;T&gt; 实例。</span></span><br><span class="line">	<span class="keyword">fn</span> <span class="title function_">new</span>(x: T) <span class="punctuation">-&gt;</span> MyBox&lt;T&gt;&#123;</span><br><span class="line">        <span class="title function_ invoke__">MyBox</span>(x)</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">MyBox</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="comment">//指定Deref trait 的目标类型为 T</span></span><br><span class="line">	<span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">	<span class="comment">// 回 `MyBox` 内部存储的 `T` 类型的引用。</span></span><br><span class="line">	<span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;deref called&quot;</span>);</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = MyBox::<span class="title function_ invoke__">new</span>(x);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x= &#123;&#125;&quot;</span>, x);</span><br><span class="line">    <span class="comment">//*y 解引用 y，获取y的值</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;y= &#123;&#125;&quot;</span>, *y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DerefMut："><a href="#DerefMut：" class="headerlink" title="DerefMut："></a>DerefMut：</h2><p><code>DerefMut</code> trait 用于实现可变解引用操作，即 <code>*</code> 操作符应用于可变引用。通过实现 <code>DerefMut</code>，可以将自定义类型转换为可变引用（<code>&amp;mut T</code>）。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"><span class="keyword">use</span> std::ops::DerefMut;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyBox</span>&lt;T&gt;(T);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt;MyBox&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(x: T) <span class="punctuation">-&gt;</span> MyBox&lt;T&gt;&#123;</span><br><span class="line">        <span class="title function_ invoke__">MyBox</span>(x)</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">MyBox</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;deref called&quot;</span>);</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; DerefMut <span class="keyword">for</span> <span class="title class_">MyBox</span>&lt;T&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref_mut</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> T &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;deref_mut called&quot;</span>);</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = MyBox::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">	<span class="comment">//使用 *x 解引用 MyBox，实际调用 deref_mut 方法获取 x 内部的可变引用，然后赋值为 10。</span></span><br><span class="line">	*x = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x = &#123;&#125;&quot;</span>,*x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出结果：</span></span><br><span class="line"><span class="comment">//deref_mut called (在 *x = 10; 时，调用了 deref_mut 方法，输出 deref_mut called。</span></span><br><span class="line"><span class="comment">//deref called (在 println!(&quot;x = &#123;&#125;&quot;, *x); 时，调用了 deref 方法，输出 deref called。</span></span><br><span class="line"><span class="comment">//x = 10 (通过解引用 x，获取 x 内部的 i32 值，输出 10。</span></span><br></pre></td></tr></table></figure>

<p>解引用操作（Deref）和可变解引用（DerefMut）区别：</p>
<h3 id="主要区别"><a href="#主要区别" class="headerlink" title="主要区别"></a>主要区别</h3><ol>
<li><p><strong>引用类型</strong>：</p>
<ul>
<li><strong>解引用操作</strong>：返回不可变引用（<code>&amp;T</code>）。</li>
<li><strong>可变解引用操作</strong>：返回可变引用（<code>&amp;mut T</code>）。</li>
</ul>
</li>
<li><p><strong>数据访问权限</strong>：</p>
<ul>
<li><strong>解引用操作</strong>：只能读取数据，不能修改数据。</li>
<li><strong>可变解引用操作</strong>：可以读取和修改数据。</li>
</ul>
</li>
<li><p><strong>使用场景</strong>：</p>
<ul>
<li><strong>解引用操作</strong>：适用于需要读取数据的场景，如打印、计算等。</li>
<li><strong>可变解引用操作</strong>：适用于需要修改数据的场景，如更新、重置等。</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/28/Rust-lesson-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/28/Rust-lesson-15/" itemprop="url">Rust lesson 15 - 模块化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-10-28T17:13:12+08:00">
                2024-10-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="包（package）"><a href="#包（package）" class="headerlink" title="包（package）"></a>包（package）</h1><p>包（package）是一个包含一个或多个 crates 的目录树。包是 Rust 项目的基本单位，可以是一个库（library）或一个可执行文件（binary），也可以同时包含两者。包通常由 Cargo.toml 文件定义，这是一个配置文件，用于指定包的元数据、依赖关系和其他构建选项。</p>
<h2 id="包的结构："><a href="#包的结构：" class="headerlink" title="包的结构："></a>包的结构：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my_package/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── src/</span><br><span class="line">│   ├── lib.rs  # 库入口文件（如果包是一个库）</span><br><span class="line">│   └── main.rs  # 可执行文件入口文件（如果包是一个二进制程序）</span><br><span class="line">└── tests/  # 集成测试文件</span><br></pre></td></tr></table></figure>

<h2 id="包的组成："><a href="#包的组成：" class="headerlink" title="包的组成："></a>包的组成：</h2><ol>
<li>cargo.toml</li>
</ol>
<ul>
<li>这是包的配置文件，定义了包的元数据、依赖关系和其他构建选项。</li>
<li>一个基本的 <code>Cargo.toml</code> 文件可能如下所示：&#96;&#96;&#96;rust</li>
</ul>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_package&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Your Name &lt;you@example.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">serde</span> = <span class="string">&quot;1.0&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>src&#x2F; 目录：</li>
</ol>
<ul>
<li>包含源代码文件。</li>
<li><code>lib.rs</code>：库的入口文件。如果包是一个库，这是主文件。</li>
<li><code>main.rs</code>：可执行文件的入口文件。如果包是一个二进制程序，这是主文件。</li>
</ul>
<ol start="3">
<li>tests&#x2F; 目录：</li>
</ol>
<ul>
<li>包含集成测试文件。每个文件都是一个单独的模块，可以包含多个测试函数。</li>
</ul>
<h2 id="包的类型："><a href="#包的类型：" class="headerlink" title="包的类型："></a>包的类型：</h2><ol>
<li>库包（Library Package）：<br> 提供可重用的代码。<br> 通常包含一个 lib.rs 文件。<br> 可以被其他包依赖。</li>
<li>可执行文件包（Binary Package）：<br> 生成一个可执行文件。<br> 通常包含一个 main.rs 文件。<br> 可以包含多个可执行文件（通过在 src&#x2F;bin&#x2F; 目录下添加多个 *.rs 文件）。</li>
<li>混合包（Mixed Package）：<br> 同时包含库和可执行文件。<br> 通常包含 lib.rs 和 main.rs 文件。</li>
</ol>
<h2 id="依赖管理："><a href="#依赖管理：" class="headerlink" title="依赖管理："></a>依赖管理：</h2><p>在 <code>Cargo.toml</code> 文件中，你可以指定包的依赖关系。依赖关系可以是其他包或本地路径。</p>
<h3 id="添加依赖："><a href="#添加依赖：" class="headerlink" title="添加依赖："></a>添加依赖：</h3><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">serde</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1.0&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br></pre></td></tr></table></figure>

<h3 id="本地路径依赖"><a href="#本地路径依赖" class="headerlink" title="本地路径依赖:"></a>本地路径依赖:</h3><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">my_local_lib</span> = &#123; path = <span class="string">&quot;../my_local_lib&quot;</span> &#125;</span><br></pre></td></tr></table></figure>


<h1 id="库（crates）"><a href="#库（crates）" class="headerlink" title="库（crates）"></a>库（crates）</h1><p>crate 是编译和链接的基本单位。一个 crate 可以是一个库（library）或一个可执行文件（binary），也可以同时包含两者。crate 是 Rust 项目的核心组成部分，通过 <code>Cargo.toml</code> 文件进行管理和配置。</p>
<h2 id="什么是库？"><a href="#什么是库？" class="headerlink" title="什么是库？"></a>什么是库？</h2><ol>
<li>库（Library Crate）：<br> 提供可重用的代码。<br> 通常包含一个 lib.rs 文件。<br> 可以被其他 crate 依赖。</li>
<li>可执行文件（Binary Crate）：<br> 生成一个可执行文件。<br> 通常包含一个 main.rs 文件。<br> 可以包含多个可执行文件（通过在 src&#x2F;bin&#x2F; 目录下添加多个 *.rs 文件）。</li>
</ol>
<h2 id="crate结构："><a href="#crate结构：" class="headerlink" title="crate结构："></a>crate结构：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my_crate/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── src/</span><br><span class="line">│   ├── lib.rs  # 库入口文件（如果 <span class="keyword">crate</span> 是一个库）</span><br><span class="line">│   └── main.rs  # 可执行文件入口文件（如果 <span class="keyword">crate</span> 是一个二进制程序）</span><br><span class="line">└── tests/  # 集成测试文件</span><br></pre></td></tr></table></figure>

<h2 id="crate的类型："><a href="#crate的类型：" class="headerlink" title="crate的类型："></a>crate的类型：</h2><ol>
<li>库 crate：<br> 提供可重用的代码。<br> 通常包含一个 lib.rs 文件。<br> 可以被其他 crate 依赖。</li>
<li>可执行文件 crate：<br> 生成一个可执行文件。<br> 通常包含一个 main.rs 文件。<br> 可以包含多个可执行文件（通过在 src&#x2F;bin&#x2F; 目录下添加多个 *.rs 文件）。</li>
<li>混合 crate：<br> 同时包含库和可执行文件。<br> 通常包含 lib.rs 和 main.rs 文件。</li>
</ol>
<h2 id="依赖管理：-1"><a href="#依赖管理：-1" class="headerlink" title="依赖管理："></a>依赖管理：</h2><p>在 <code>Cargo.toml</code> 文件中，你可以指定 crate 的依赖关系。依赖关系可以是其他 crate 或本地路径。</p>
<h3 id="添加依赖：-1"><a href="#添加依赖：-1" class="headerlink" title="添加依赖："></a>添加依赖：</h3><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">serde</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1.0&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br></pre></td></tr></table></figure>

<h3 id="本地路径依赖："><a href="#本地路径依赖：" class="headerlink" title="本地路径依赖："></a>本地路径依赖：</h3><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">my_local_lib</span> = &#123; path = <span class="string">&quot;../my_local_lib&quot;</span> &#125;</span><br></pre></td></tr></table></figure>


<h1 id="包和库的区别："><a href="#包和库的区别：" class="headerlink" title="包和库的区别："></a>包和库的区别：</h1><ol>
<li><strong>范围</strong>：<ul>
<li><strong>包</strong>：是一个包含一个或多个 crates 的目录树，由 <code>Cargo.toml</code> 文件定义。</li>
<li><strong>库</strong>：是一个可重用的代码集合，通常包含一个 <code>lib.rs</code> 文件。</li>
</ul>
</li>
<li><strong>文件结构</strong>：<ul>
<li><strong>包</strong>：包含 <code>Cargo.toml</code> 文件、<code>src</code> 目录、测试文件等。</li>
<li><strong>库</strong>：主要包含 <code>src/lib.rs</code> 文件及其相关的模块文件。</li>
</ul>
</li>
<li><strong>功能</strong>：<ul>
<li><strong>包</strong>：管理项目的元数据、依赖关系和构建选项。</li>
<li><strong>库</strong>：提供可重用的代码，供其他 crate 使用。</li>
</ul>
</li>
<li><strong>用途</strong>：<ul>
<li><strong>包</strong>：用于组织和管理整个项目，可以发布到 crates.io。</li>
<li><strong>库</strong>：用于封装可重用的代码，提高代码的模块化和复用性。</li>
</ul>
</li>
</ol>
<h1 id="模块（mod"><a href="#模块（mod" class="headerlink" title="模块（mod)"></a>模块（mod)</h1><p>模块系统允许你将代码分成逻辑单元，提高代码的可读性和可维护性。</p>
<h2 id="模块系统的基本概念"><a href="#模块系统的基本概念" class="headerlink" title="模块系统的基本概念"></a>模块系统的基本概念</h2><ol>
<li><p><strong>模块</strong>：</p>
<ul>
<li>模块是一个包含其他项（如函数、结构体、枚举、其他模块等）的逻辑单元。</li>
<li>模块可以通过 <code>mod</code> 关键字定义。</li>
</ul>
</li>
<li><p><strong>可见性</strong>：</p>
<ul>
<li>默认情况下，模块中的项是私有的（private），只能在定义它们的模块内访问。</li>
<li>使用 <code>pub</code> 关键字可以将项声明为公有的（public），使其在父模块或其他模块中可见。</li>
</ul>
</li>
<li><p><strong>路径</strong>：</p>
<ul>
<li>路径是用于引用模块或模块中项的标识符，可以是绝对路径或相对路径。</li>
</ul>
</li>
<li><p><strong>重新导出</strong>：</p>
<ul>
<li>使用 <code>pub use</code> 关键字将模块中的项重新导出到父模块中，使其在父模块中可见。</li>
</ul>
</li>
</ol>
<p>项目结构示例：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">my_project/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">└── src/</span><br><span class="line">    ├── lib.rs</span><br><span class="line">    └── shapes/</span><br><span class="line">        ├── <span class="keyword">mod</span>.rs</span><br><span class="line">        ├── circle.rs</span><br><span class="line">        └── rectangle.rs</span><br></pre></td></tr></table></figure>

<h3 id="定义模块"><a href="#定义模块" class="headerlink" title="定义模块"></a>定义模块</h3><ol>
<li><p>src&#x2F;lib.rs<br> 这是库的入口文件，定义顶层模块并重新导出子模块中的项。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> shapes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> shapes::circle::draw_circle <span class="keyword">as</span> draw;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> shapes::rectangle::draw_rectangle <span class="keyword">as</span> draw_rect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">say_hello</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello from the library!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>src&#x2F;shapes&#x2F;mod.rs<br>这是 shapes 模块的入口文件，定义子模块。</p>
</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/shapes/mod.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> circle;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> rectangle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">draw_shapes</span>() &#123;</span><br><span class="line">    circle::<span class="title function_ invoke__">draw_circle</span>();</span><br><span class="line">    rectangle::<span class="title function_ invoke__">draw_rectangle</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>src&#x2F;shapes&#x2F;circle.rs<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/shapes/circle.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">draw_circle</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Drawing a circle&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">calculate_area</span>(radius: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    std::<span class="type">f64</span>::consts::PI * radius * radius</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="使用模块"><a href="#使用模块" class="headerlink" title="使用模块"></a>使用模块</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> my_project;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> my_project::&#123;draw, draw_rect&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    my_project::<span class="title function_ invoke__">say_hello</span>();</span><br><span class="line">    <span class="title function_ invoke__">draw</span>();          <span class="comment">// 调用 draw_circle</span></span><br><span class="line">    <span class="title function_ invoke__">draw_rect</span>();     <span class="comment">// 调用 draw_rectangle</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="工作区（workspace）"><a href="#工作区（workspace）" class="headerlink" title="工作区（workspace）"></a>工作区（workspace）</h1><p>工作区（workspace）是一种组织多个包（packages）的方式，这些包共享相同的依赖关系和构建配置。工作区允许你在单个 <code>Cargo.toml</code> 文件中管理多个包，从而简化大型项目的管理和构建过程。</p>
<h2 id="工作区的基本概念"><a href="#工作区的基本概念" class="headerlink" title="工作区的基本概念"></a>工作区的基本概念</h2><ol>
<li><strong>工作区</strong>：<ul>
<li>工作区是一个包含多个包的目录树。</li>
<li>每个包都有自己的 <code>Cargo.toml</code> 文件，但工作区有一个顶级的 <code>Cargo.toml</code> 文件来管理所有包的依赖关系和构建配置。</li>
</ul>
</li>
<li><strong>成员包</strong>：<ul>
<li>成员包是工作区中的每个包，每个包都可以是一个独立的库或可执行文件。</li>
<li>成员包的 <code>Cargo.toml</code> 文件可以指定自己的依赖关系和构建选项。</li>
</ul>
</li>
<li>**顶级 <code>Cargo.toml</code>**：<ul>
<li>顶级 <code>Cargo.toml</code> 文件定义了工作区的成员包，并可以指定共享的依赖关系和构建配置。</li>
</ul>
</li>
</ol>
<h2 id="工作区的结构"><a href="#工作区的结构" class="headerlink" title="工作区的结构"></a>工作区的结构</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">my_workspace/</span><br><span class="line">├── Cargo.toml  # 顶级 Cargo.toml 文件</span><br><span class="line">├── my_library/</span><br><span class="line">│   ├── Cargo.toml  # my_library 的 Cargo.toml 文件</span><br><span class="line">│   └── src/</span><br><span class="line">│       └── lib.rs</span><br><span class="line">└── my_binary/</span><br><span class="line">    ├── Cargo.toml  # my_binary 的 Cargo.toml 文件</span><br><span class="line">    └── src/</span><br><span class="line">        └── main.rs</span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<h2 id="创建工作区："><a href="#创建工作区：" class="headerlink" title="创建工作区："></a>创建工作区：</h2><ol>
<li>创建顶级 Cargo.toml 文件：</li>
</ol>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">members</span> = [</span><br><span class="line">    <span class="string">&quot;my_library&quot;</span>,</span><br><span class="line">    <span class="string">&quot;my_binary&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建成员包</li>
</ol>
<ul>
<li>使用 <code>cargo new</code> 命令创建成员包。<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cargo new my_library --lib</span><br><span class="line">cargo new my_binary</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="可见性-visibility"><a href="#可见性-visibility" class="headerlink" title="可见性(visibility)"></a>可见性(visibility)</h1><p>指代码项（如函数、结构体、枚举、模块等）在代码中的可见范围。</p>
<p>项目结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">my_project/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">└── src/</span><br><span class="line">    ├── lib.rs</span><br><span class="line">    └── shapes/</span><br><span class="line">        ├── mod.rs</span><br><span class="line">        ├── circle.rs</span><br><span class="line">        └── rectangle.rs</span><br></pre></td></tr></table></figure>

<h2 id="可见性关键字"><a href="#可见性关键字" class="headerlink" title="可见性关键字"></a>可见性关键字</h2><ol>
<li>**<code>pub</code>**：<ul>
<li>将项声明为公有（public），使其在父模块及其子模块之外可见。</li>
<li>如果不使用 <code>pub</code>，项默认为私有（private），只能在定义它的模块内访问。</li>
</ul>
</li>
<li>**<code>pub(in path)</code>**：<ul>
<li>将项声明为在指定路径内的公有，限制其可见范围。</li>
<li><code>path</code> 可以是绝对路径或相对路径。</li>
</ul>
</li>
<li>**<code>pub(crate)</code>**：<ul>
<li>将项声明为在当前 crate 内公有，使其在整个 crate 内可见。</li>
</ul>
</li>
<li>**<code>pub(super)</code>**：<ul>
<li>将项声明为在其父模块内公有，使其在父模块及其子模块内可见。</li>
</ul>
</li>
</ol>
<h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h3><ol>
<li>公有（pub）：<br> 将项声明为公有，使其在父模块及其子模块之外可见。</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/shapes/circle.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">draw_circle</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Drawing a circle&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">calculate_area</span>(radius: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    std::<span class="type">f64</span>::consts::PI * radius * radius</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>限制可见范围（pub(in path)）：<br> 将项声明为在指定路径内的公有，限制其可见范围。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/shapes/circle.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">draw_circle</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Drawing a circle&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">in</span> crate::shapes) <span class="keyword">fn</span> <span class="title function_">calculate_area</span>(radius: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    std::<span class="type">f64</span>::consts::PI * radius * radius</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>当前 crate 内公有（pub(crate)）：<br> 将项声明为在当前 crate 内公有，使其在整个 crate 内可见。</p>
</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/shapes/circle.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">draw_circle</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Drawing a circle&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">calculate_area</span>(radius: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    std::<span class="type">f64</span>::consts::PI * radius * radius</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>父模块内公有（pub(super)）：<br> 将项声明为在其父模块内公有，使其在父模块及其子模块内可见。</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/shapes/circle.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">draw_circle</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Drawing a circle&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">super</span>) <span class="keyword">fn</span> <span class="title function_">calculate_area</span>(radius: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">    std::<span class="type">f64</span>::consts::PI * radius * radius</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="路径（Path）"><a href="#路径（Path）" class="headerlink" title="路径（Path）"></a>路径（Path）</h1><p>路径（Path）用于引用模块或模块中的项（如函数、结构体、枚举、常量等）。路径可以是绝对路径或相对路径，通过路径，你可以在代码中访问不同模块中的项。</p>
<h2 id="路径的基本概念"><a href="#路径的基本概念" class="headerlink" title="路径的基本概念"></a>路径的基本概念</h2><ol>
<li><strong>绝对路径</strong>：<ul>
<li>从根模块开始的路径。</li>
<li>根模块通常是 crate 的入口点（<code>lib.rs</code> 或 <code>main.rs</code>）。</li>
</ul>
</li>
<li><strong>相对路径</strong>：<ul>
<li>从当前模块开始的路径。</li>
<li>使用 <code>self</code>、<code>super</code> 和模块名称来表示相对路径。</li>
</ul>
</li>
</ol>
<h3 id="路径的语法"><a href="#路径的语法" class="headerlink" title="路径的语法"></a>路径的语法</h3><ol>
<li><strong>绝对路径</strong>：<ul>
<li>以 <code>crate</code>、<code>self</code> 或 <code>super</code> 开头。</li>
<li>例如：<code>crate::module::item</code>、<code>self::module::item</code>、<code>super::module::item</code>。</li>
</ul>
</li>
<li><strong>相对路径</strong>：<ul>
<li>从当前模块开始，使用模块名称。</li>
<li>例如：<code>module::item</code>。</li>
</ul>
</li>
</ol>
<p>示例目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">my_project/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">└── src/</span><br><span class="line">    ├── lib.rs</span><br><span class="line">    └── shapes/</span><br><span class="line">        ├── mod.rs</span><br><span class="line">        ├── circle.rs</span><br><span class="line">        └── rectangle.rs</span><br></pre></td></tr></table></figure>

<h3 id="绝对路径示例"><a href="#绝对路径示例" class="headerlink" title="绝对路径示例"></a>绝对路径示例</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> my_project;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> my_project::shapes::circle::draw_circle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    my_project::<span class="title function_ invoke__">say_hello</span>();</span><br><span class="line">    <span class="title function_ invoke__">draw_circle</span>();  <span class="comment">// 调用 draw_circle</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="相对路径示例"><a href="#相对路径示例" class="headerlink" title="相对路径示例"></a>相对路径示例</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/shapes/mod.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> circle;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> rectangle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">draw_shapes</span>() &#123;</span><br><span class="line">    self::circle::<span class="title function_ invoke__">draw_circle</span>();</span><br><span class="line">    self::rectangle::<span class="title function_ invoke__">draw_rectangle</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="单元测试（unit-test"><a href="#单元测试（unit-test" class="headerlink" title="单元测试（unit test)"></a>单元测试（unit test)</h1><p>单元测试（unit testing）是确保代码正确性和健壮性的重要手段。</p>
<h2 id="单元测试的基本概念"><a href="#单元测试的基本概念" class="headerlink" title="单元测试的基本概念"></a>单元测试的基本概念</h2><ol>
<li><strong>测试模块</strong>：<ul>
<li>测试代码通常放在模块的 <code>#[cfg(test)]</code> 属性中，这样测试代码不会在生产环境中编译。</li>
<li>每个模块可以有自己的测试模块。</li>
</ul>
</li>
<li><strong>测试函数</strong>：<ul>
<li>测试函数使用 <code>#[test]</code> 属性标记。</li>
<li>测试函数必须没有参数且返回类型为 <code>()</code>。</li>
</ul>
</li>
<li><strong>断言</strong>：<ul>
<li>使用 <code>assert!</code> 宏来检查条件是否为真。</li>
<li>使用 <code>assert_eq!</code> 和 <code>assert_ne!</code> 宏来比较值是否相等或不相等。</li>
</ul>
</li>
</ol>
<p>项目结构：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my_project/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">└── src/</span><br><span class="line">    ├── lib.rs</span><br><span class="line">    └── tests/</span><br><span class="line">        └── integration_test.rs</span><br></pre></td></tr></table></figure>

<h3 id="代码示例："><a href="#代码示例：" class="headerlink" title="代码示例："></a>代码示例：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> math &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">        a + b</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">subtract</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">        a - b</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">multiply</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">        a * b</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(<span class="string">&quot;Division by zero&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(a / b)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::math;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(math::<span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_subtract</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(math::<span class="title function_ invoke__">subtract</span>(<span class="number">5</span>, <span class="number">3</span>), <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_multiply</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(math::<span class="title function_ invoke__">multiply</span>(<span class="number">4</span>, <span class="number">5</span>), <span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_divide</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(math::<span class="title function_ invoke__">divide</span>(<span class="number">10</span>, <span class="number">2</span>).<span class="title function_ invoke__">unwrap</span>(), <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">assert!</span>(math::<span class="title function_ invoke__">divide</span>(<span class="number">10</span>, <span class="number">0</span>).<span class="title function_ invoke__">is_err</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>**<code>pub mod math</code>**：<ul>
<li>定义了一个 <code>math</code> 模块，包含一些数学函数。</li>
</ul>
</li>
<li>**<code>#[cfg(test)] mod tests</code>**：<ul>
<li>定义了一个测试模块，只在测试配置中编译。</li>
</ul>
</li>
<li>**<code>#[test]</code>**：<ul>
<li>标记测试函数，这些函数将在运行测试时自动执行。</li>
</ul>
</li>
<li>**<code>assert_eq!</code> 和 <code>assert!</code>**：<ul>
<li><code>assert_eq!</code> 用于检查两个值是否相等。</li>
<li><code>assert!</code> 用于检查一个条件是否为真。</li>
</ul>
</li>
</ol>
<h3 id="运行单元测试："><a href="#运行单元测试：" class="headerlink" title="运行单元测试："></a>运行单元测试：</h3><ol>
<li><p>运行 cargo test</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">running 4 tests</span><br><span class="line">test tests::test_add ... ok</span><br><span class="line">test tests::test_subtract ... ok</span><br><span class="line">test tests::test_multiply ... ok</span><br><span class="line">test tests::test_divide ... ok</span><br><span class="line"></span><br><span class="line">test result: ok. 4 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="集成测试（Integration-Test"><a href="#集成测试（Integration-Test" class="headerlink" title="集成测试（Integration Test)"></a>集成测试（Integration Test)</h1><p>集成测试（integration testing）用于验证多个模块或组件之间的交互是否按预期工作。</p>
<h2 id="集成测试的基本概念"><a href="#集成测试的基本概念" class="headerlink" title="集成测试的基本概念"></a>集成测试的基本概念</h2><ol>
<li><p><strong>测试文件</strong>：</p>
<ul>
<li>集成测试文件通常放在 <code>tests</code> 目录下。</li>
<li>每个测试文件都是一个单独的 crate，可以独立编译和运行。</li>
</ul>
</li>
<li><p><strong>测试函数</strong>：</p>
<ul>
<li>测试函数使用 <code>#[test]</code> 属性标记。</li>
<li>测试函数必须没有参数且返回类型为 <code>()</code>。</li>
</ul>
</li>
<li><p><strong>断言</strong>：</p>
<ul>
<li>使用 <code>assert!</code> 宏来检查条件是否为真。</li>
<li>使用 <code>assert_eq!</code> 和 <code>assert_ne!</code> 宏来比较值是否相等或不相等。</li>
</ul>
</li>
</ol>
<p>继续沿用上面单元测试的目录结构</p>
<h3 id="创建集成测试文件："><a href="#创建集成测试文件：" class="headerlink" title="创建集成测试文件："></a>创建集成测试文件：</h3><p>在 tests 目录下创建一个新的文件，例如 integration_test.rs。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tests/integration_test.rs</span></span><br><span class="line"><span class="keyword">use</span> my_project::math;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_integration</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sum</span> = math::<span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">product</span> = math::<span class="title function_ invoke__">multiply</span>(sum, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(product, <span class="number">20</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行集成测试："><a href="#运行集成测试：" class="headerlink" title="运行集成测试："></a>运行集成测试：</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<h3 id="忽略某些测试"><a href="#忽略某些测试" class="headerlink" title="忽略某些测试"></a>忽略某些测试</h3><p>如果你有一些测试需要在特定条件下运行，可以使用 <code>#[ignore]</code> 属性来忽略这些测试。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::math;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(math::<span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[ignore]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_long_running</span>() &#123;</span><br><span class="line">        <span class="comment">// 这个测试会被忽略</span></span><br><span class="line">        <span class="built_in">assert_eq!</span>(math::<span class="title function_ invoke__">add</span>(<span class="number">1000</span>, <span class="number">2000</span>), <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行特定测试"><a href="#运行特定测试" class="headerlink" title="运行特定测试"></a>运行特定测试</h3><p>可以使用 <code>cargo test</code> 命令加上测试名称来运行特定的测试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo test test_add</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/26/Rust-lesson-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/26/Rust-lesson-14/" itemprop="url">Rust lesson 14 - 返回值和错误处理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-10-26T20:21:16+08:00">
                2024-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Opiton返回值"><a href="#Opiton返回值" class="headerlink" title="Opiton返回值"></a>Opiton返回值</h1><p><code>Option</code> 是一种用于表示可能缺失值的枚举类型。它有两个变体：<code>Some(T)</code> 表示存在一个值，<code>None</code> 表示不存在值。<code>Option</code> 常用于错误处理，特别是在可能没有结果的情况下。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Opiton</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="title function_ invoke__">Some</span>(T),</span><br><span class="line">	<span class="literal">None</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="基础示例："><a href="#基础示例：" class="headerlink" title="基础示例："></a>基础示例：</h2><p>&#96;</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">//返回 p1=Some(&#x27;A&#x27;),p1是 Option 类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = s.<span class="title function_ invoke__">pop</span>();</span><br><span class="line">    dbg!(p1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回None,因为弹两次已经为空了。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = s.<span class="title function_ invoke__">pop</span>();</span><br><span class="line">    dbg!(p2); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="匹配Option："><a href="#匹配Option：" class="headerlink" title="匹配Option："></a>匹配Option：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_one</span>(x: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">	<span class="keyword">match</span> x &#123;</span><br><span class="line">		<span class="literal">None</span> =&gt; <span class="literal">None</span>,</span><br><span class="line">		<span class="title function_ invoke__">Some</span>(i) =&gt; <span class="title function_ invoke__">Some</span>(i+<span class="number">1</span>),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">five</span> = <span class="title function_ invoke__">Some</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">six</span> = <span class="title function_ invoke__">plus_one</span>(five);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, six); </span><br></pre></td></tr></table></figure>

<h2 id="使用unwrap"><a href="#使用unwrap" class="headerlink" title="使用unwrap:"></a>使用unwrap:</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unwrap</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    <span class="comment">//unwrap，有值的时候取值，没值就panic</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = s.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="comment">//输出 o，把Some(o)的Some去掉了</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,p1); </span><br></pre></td></tr></table></figure>

<h2 id="使用is-some和is-none"><a href="#使用is-some和is-none" class="headerlink" title="使用is_some和is_none:"></a>使用<code>is_some</code>和<code>is_none</code>:</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//is_some 和 is_none</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="comment">//判断 v[1]有没有值</span></span><br><span class="line"><span class="comment">//if !v.get(1).is_none()&#123;&#125; 相同效果</span></span><br><span class="line"><span class="keyword">if</span> v.<span class="title function_ invoke__">get</span>(<span class="number">1</span>).<span class="title function_ invoke__">is_some</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,v[<span class="number">1</span>]);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="使用-unwrap-or"><a href="#使用-unwrap-or" class="headerlink" title="使用 unwrap_or:"></a>使用 <code>unwrap_or</code>:</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line"> <span class="comment">//b为0正常来讲会返回None，但unwrap_or可以设定其他默认返回值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r</span> = <span class="title function_ invoke__">div</span>(<span class="number">10</span>,<span class="number">0</span>).<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0.0</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,r); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">fn</span> <span class="title function_">div</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">f64</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//分母不能为0</span></span><br><span class="line">    <span class="keyword">if</span> b != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(a <span class="keyword">as</span> <span class="type">f64</span> / b <span class="keyword">as</span> <span class="type">f64</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h1 id="Rust-中的错误分类："><a href="#Rust-中的错误分类：" class="headerlink" title="Rust 中的错误分类："></a>Rust 中的错误分类：</h1><ol>
<li>可恢复错误，通常用于从系统全局角度来看可以接受的错误，例如处理用户的访问、操作和错误，这些操作只会影响操作进程，而不会对系统的全局稳定性产生影响。<br> <code>Rsesult&lt;T, E&gt;</code> 用于可恢复错误。</li>
<li>不可恢复错误，通常是全局性或者系统性的错误，例如数组越界访问等等，对系统安全性有致命影响<br><code>panic!</code> 用于不可恢复错误。</li>
</ol>
<h2 id="Panic："><a href="#Panic：" class="headerlink" title="Panic："></a>Panic：</h2><h3 id="被动触发："><a href="#被动触发：" class="headerlink" title="被动触发："></a>被动触发：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">	v[<span class="number">99</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="主动触发："><a href="#主动触发：" class="headerlink" title="主动触发："></a>主动触发：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="built_in">panic!</span>(<span class="string">&quot;crash and burn&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Result"><a href="#Result" class="headerlink" title="Result:"></a>Result:</h2><p>很多错误没严重到程序要完全停止，例如：想要打开一个不存在的文件但是失败了，我们下一步可能是想创建文件，而不是直接停止程序。</p>
<p><code>Ok(T)</code>：表示操作成功，并包含一个成功值 T。<br><code>Err(E)</code>：表示操作失败，并包含一个错误值 E。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Result</span>&lt;T,E&gt; &#123;</span><br><span class="line">	<span class="title function_ invoke__">Ok</span>(T),</span><br><span class="line">	<span class="title function_ invoke__">Err</span>(E),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="返回result"><a href="#返回result" class="headerlink" title="返回result:"></a>返回result:</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">enum</span> <span class="title class_">MathError</span> &#123;</span><br><span class="line">    DivisionByZero,</span><br><span class="line">    NegativeSquareRoot,</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//返回Result&lt;成功数据类型，失败数据类型&gt;</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">div</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">f64</span>,MathError&gt; &#123;</span><br><span class="line">    <span class="comment">//分母不能为0</span></span><br><span class="line">    <span class="keyword">if</span> b != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(a <span class="keyword">as</span> <span class="type">f64</span> / b <span class="keyword">as</span> <span class="type">f64</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">	    <span class="comment">//把失败原因包装在Err里并返回</span></span><br><span class="line">        <span class="title function_ invoke__">Err</span>(MathError::DivisionByZero)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"> <span class="keyword">fn</span> <span class="title function_">sqrt</span>(a: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">f64</span>, MathError&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> a &lt; <span class="number">0.0</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(MathError::NegativeSquareRoot)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(a.<span class="title function_ invoke__">sqrt</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="处理result"><a href="#处理result" class="headerlink" title="处理result:"></a>处理result:</h3><p>打开hello.txt文件，如果文件不存在而失败，希望创建这文件。如果因为其他原因失败，一样panic。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">//处理Result</span></span><br><span class="line">    <span class="comment">//open() 函数打开文件，返回是个Result类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span> = <span class="keyword">match</span> f &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(file) =&gt; file,</span><br><span class="line">        <span class="comment">//kind() 会输出更详细的错误类型</span></span><br><span class="line">        <span class="title function_ invoke__">Err</span>(error) =&gt; <span class="keyword">match</span> error.<span class="title function_ invoke__">kind</span>()&#123;</span><br><span class="line">            ErrorKind::NotFound =&gt; <span class="keyword">match</span> File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;hello.txt&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(fc) =&gt; fc,</span><br><span class="line">                <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;creating file failed: &#123;&#125;&quot;</span>,e),      </span><br><span class="line">            &#125;,</span><br><span class="line">            other_error =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;opening file failed: &#123;&#125;&quot;</span>, other_error),</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="unwrap"><a href="#unwrap" class="headerlink" title="unwrap():"></a>unwrap():</h3><p>如果Result 是 Ok，那么unwrap会返回Ok中的值；如果是Err，则会调用panic!</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">//unwrap</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="expect"><a href="#expect" class="headerlink" title="expect():"></a>expect():</h3><p>expect跟unwrap差不多，就是错误输出可以自定义内容</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="comment">//expect 按自己期望修改打印出来的错误信息</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to open hello.txt&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="map"><a href="#map" class="headerlink" title="map:"></a>map:</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//map</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">line</span> = <span class="string">&quot;1\n2\n3\n4\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历每一行，line.lines()是迭代器，按行分割字符串</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">num</span> <span class="keyword">in</span> line.<span class="title function_ invoke__">lines</span>() &#123;</span><br><span class="line">        <span class="comment">// num.parse::&lt;i32&gt;() 将num转为i32类型，成功就ok,不成功Err</span></span><br><span class="line">        <span class="comment">// ok的话， map会将ok中的值*2</span></span><br><span class="line">        <span class="keyword">match</span> num.parse::&lt;<span class="type">i32</span>&gt;().<span class="title function_ invoke__">map</span>(|i| i * <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(n) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;&#123;n&#125;&quot;</span>),</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(..) =&gt; &#123;&#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="map-err"><a href="#map-err" class="headerlink" title="map_err:"></a>map_err:</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//map_err</span></span><br><span class="line"><span class="comment">//注意 Result&lt;(), String&gt;的String</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">x</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//map_err,如果文件打开失败，map_err 方法将 std::io::Error 转换为一个 String 类型的错误信息。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>).<span class="title function_ invoke__">map_err</span>(|e: std::io::Error| <span class="built_in">format!</span>(<span class="string">&quot;&#123;e&#125;&quot;</span>));</span><br><span class="line">    <span class="keyword">match</span> f &#123;</span><br><span class="line">        <span class="comment">//：如果文件打开失败，返回 Err(e)，其中 e 是转换后的 String 错误信息。</span></span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="title function_ invoke__">Err</span>(e),</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(_) =&gt; <span class="title function_ invoke__">Ok</span>(()),</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="传播错误："><a href="#传播错误：" class="headerlink" title="传播错误："></a>传播错误：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">read_username_from_file</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, std::io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">f</span> = <span class="keyword">match</span> f &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(file) =&gt; file,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(error) =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(error),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> f.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> s) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(_) =&gt; <span class="title function_ invoke__">Ok</span>(s),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(error) =&gt; <span class="title function_ invoke__">Err</span>(error),</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上面这样写太长</span></span><br><span class="line"><span class="comment">//简略写法：</span></span><br><span class="line"><span class="comment">//对于Result，如果结果是Ok(T),则把T赋值给f</span></span><br><span class="line"><span class="comment">//如果结果是Err(E),则返回该错误</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_username_from_file</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, io::Error&gt; &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">f</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>)?;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">	f.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> s)?;</span><br><span class="line">	<span class="title function_ invoke__">Ok</span>(s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_username_from_file</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, std::io::Error&gt; &#123;</span><br><span class="line"><span class="comment">//还有更简单的，链式方法调用：</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//? 运算符用于在函数返回 Result 类型时，简化错误处理。如果某个操作返回 Err，? 运算符会立即将错误返回，否则继续执行后续代码。</span></span><br><span class="line">    <span class="comment">//如果 File::open(&quot;hello.txt&quot;) 返回 Err，则立即返回该错误；否则，继续执行 read_to_string 方法。</span></span><br><span class="line">    File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>)?.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> s)?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(s)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="Option和Result-互换："><a href="#Option和Result-互换：" class="headerlink" title="Option和Result 互换："></a>Option和Result 互换：</h2><h3 id="Option-转-Result，ok-or-："><a href="#Option-转-Result，ok-or-：" class="headerlink" title="Option 转 Result，ok_or()："></a>Option 转 Result，ok_or()：</h3><p><code>Some(v)</code> -&gt; <code>Ok(v)</code><br><code>None</code> -&gt; <code>Err(err)</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//Option 转 Result</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">op_to_re</span>(arr: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;&amp;<span class="type">i32</span>, <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//ok_or(&quot;out of index&quot;.to_string())：将 Option&lt;&amp;i32&gt; 转换为 Result&lt;&amp;i32, String&gt;。</span></span><br><span class="line">    <span class="comment">//如果 arr.get(0) 返回 Some(&amp;i32)，则 ok_or 返回 Ok(&amp;i32)。</span></span><br><span class="line">    <span class="comment">//如果 arr.get(0) 返回 None，则 ok_or 返回 Err(&quot;out of index&quot;.to_string())。</span></span><br><span class="line">    arr.<span class="title function_ invoke__">get</span>(<span class="number">0</span>).<span class="title function_ invoke__">ok_or</span>(<span class="string">&quot;out of index&quot;</span>.<span class="title function_ invoke__">to_string</span>())</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="Result-转-Option-ok-："><a href="#Result-转-Option-ok-：" class="headerlink" title="Result 转 Option, ok()："></a>Result 转 Option, ok()：</h3><p><code>Ok(v)</code> -&gt; <code>None</code><br><code>Err(e)</code> -&gt; <code>Some(v)</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">24</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">option</span> = res.<span class="title function_ invoke__">ok</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(opt,<span class="title function_ invoke__">Some</span>(<span class="number">42</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">res</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt;= <span class="title function_ invoke__">Err</span>(<span class="string">&quot;Nothing here&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = res.<span class="title function_ invoke__">ok</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(opt,<span class="literal">None</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/26/Rust-lesson-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2024/10/26/Rust-lesson-13/" itemprop="url">Rust lesson 13 - 常见集合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-10-26T20:21:06+08:00">
                2024-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Rust 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="向量-Vector"><a href="#向量-Vector" class="headerlink" title="向量 Vector"></a>向量 Vector</h1><p>是一个动态数组，可以根据需要动态增长和缩小，适用于需要按顺序存储数据的场景。</p>
<h2 id="基础用法："><a href="#基础用法：" class="headerlink" title="基础用法："></a>基础用法：</h2><h3 id="创建和初始化："><a href="#创建和初始化：" class="headerlink" title="创建和初始化："></a>创建和初始化：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_study</span>() &#123;</span><br><span class="line"><span class="comment">//创建一个空的vec</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> : <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;v: &#123;:?&#125;&quot;</span>,v);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用宏来创建vec</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;v: &#123;:?&#125;&quot;</span>, v); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="添加元素："><a href="#添加元素：" class="headerlink" title="添加元素："></a>添加元素：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_study</span>() &#123;</span><br><span class="line">	<span class="comment">//push 添加元素</span></span><br><span class="line">    <span class="comment">//Vec::new(); 必须显式写明类型 Vec&lt;i32&gt;</span></span><br><span class="line">    <span class="comment">//如果换成 vec![1,2,3,]; 编译器则会自动推断，不需要自己写类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;v: &#123;:?&#125;&quot;</span>,v);</span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;v: &#123;:?&#125;&quot;</span>,v); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="访问元素："><a href="#访问元素：" class="headerlink" title="访问元素："></a>访问元素：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_study</span>() &#123;</span><br><span class="line">     <span class="comment">//直接引用访问元素</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">second</span> : &amp;<span class="type">i32</span> = &amp;v[<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The second number is  &#123;&#125;&quot;</span>,second);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用get 方法访问</span></span><br><span class="line">    <span class="comment">//get方法返回的是OPTION类型，要用match</span></span><br><span class="line">    <span class="comment">//好处：假如get 10，这种方法不会报错，使用直接引用会报错越界</span></span><br><span class="line">    <span class="keyword">match</span> v.<span class="title function_ invoke__">get</span>(<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(third) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;The third number is &#123;&#125;&quot;</span>,third),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;There is no third&quot;</span>),</span><br><span class="line">    &#125; */&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改元素："><a href="#修改元素：" class="headerlink" title="修改元素："></a>修改元素：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_study</span>() &#123;</span><br><span class="line">    <span class="comment">//修改元素</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line">    v[<span class="number">2</span>] = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;v: &#123;:?&#125;&quot;</span>,v); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="遍历元素："><a href="#遍历元素：" class="headerlink" title="遍历元素："></a>遍历元素：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_study</span>() &#123;</span><br><span class="line"> <span class="comment">//遍历元素</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> &amp;v &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,i);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进阶用法："><a href="#进阶用法：" class="headerlink" title="进阶用法："></a>进阶用法：</h2><h3 id="使用枚举存储多种类型："><a href="#使用枚举存储多种类型：" class="headerlink" title="使用枚举存储多种类型："></a>使用枚举存储多种类型：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_study</span>() &#123;</span><br><span class="line">	<span class="keyword">enum</span> <span class="title class_">SpreadsheetCell</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Int</span>(<span class="type">i32</span>),</span><br><span class="line">        <span class="title function_ invoke__">Float</span>(<span class="type">f64</span>),</span><br><span class="line">        <span class="title function_ invoke__">String</span>(<span class="type">String</span>),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">row</span> = vect![</span><br><span class="line">        SpreadsheetCell::<span class="title function_ invoke__">Int</span>(<span class="number">2</span>),</span><br><span class="line">        SpreadsheetCell::<span class="title function_ invoke__">Float</span>(<span class="number">10</span>,<span class="number">12</span>),</span><br><span class="line">        SpreadsheetCell::<span class="title function_ invoke__">Test</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>))</span><br><span class="line">    ]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="容量与重新分配："><a href="#容量与重新分配：" class="headerlink" title="容量与重新分配："></a>容量与重新分配：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">vec_study</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span> : <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;capacity: &#123;&#125;&quot;</span>,v.<span class="title function_ invoke__">capacity</span>());</span><br><span class="line"></span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;capacity: &#123;&#125;&quot;</span>,v.<span class="title function_ invoke__">capacity</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;value: &#123;:?&#125;&quot;</span>,v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="Hashmap："><a href="#Hashmap：" class="headerlink" title="Hashmap："></a>Hashmap：</h1><p>一种键值对（Key-Value）的数据结构，用于需要快速查找数据的场景。</p>
<h2 id="基础使用："><a href="#基础使用：" class="headerlink" title="基础使用："></a>基础使用：</h2><h3 id="创建与初始化："><a href="#创建与初始化：" class="headerlink" title="创建与初始化："></a>创建与初始化：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">hashmap</span>() &#123;</span><br><span class="line">	<span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">scores</span>: HashMap&lt;_, _&gt; = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line">    scores.<span class="title function_ invoke__">insert</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Blue&quot;</span>), <span class="number">10</span>);</span><br><span class="line">    scores.<span class="title function_ invoke__">insert</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Yellow&quot;</span>), <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,scores);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="访问："><a href="#访问：" class="headerlink" title="访问："></a>访问：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">hashmap</span>() &#123;</span><br><span class="line"> <span class="comment">//使用get 来访问</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">team_name</span> = <span class="type">String</span> :: <span class="title function_ invoke__">from</span>(<span class="string">&quot;Blue&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">score</span> = scores.<span class="title function_ invoke__">get</span>(&amp;team_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> score &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(s) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; score is &#123;&#125;&quot;</span>,team_name,s),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;NO SCORE&quot;</span>),</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="遍历："><a href="#遍历：" class="headerlink" title="遍历："></a>遍历：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (team,score) <span class="keyword">in</span> &amp;scores &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;,&#123;&#125;&quot;</span>,team,score);</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<h2 id="进阶用法：-1"><a href="#进阶用法：-1" class="headerlink" title="进阶用法："></a>进阶用法：</h2><h3 id="更新哈希表："><a href="#更新哈希表：" class="headerlink" title="更新哈希表："></a>更新哈希表：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">hashmap</span>() &#123;</span><br><span class="line">	<span class="comment">//更新哈希表</span></span><br><span class="line">    <span class="comment">//insert直接插入</span></span><br><span class="line">    scores.<span class="title function_ invoke__">insert</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;red&quot;</span>), <span class="number">25</span>);</span><br><span class="line">    <span class="comment">//entry().or_insert(),检查是否已经存在key,不存在插入，存在不操作</span></span><br><span class="line">    scores.<span class="title function_ invoke__">entry</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Blue&quot;</span>)).<span class="title function_ invoke__">or_insert</span>(<span class="number">50</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="合并哈希表："><a href="#合并哈希表：" class="headerlink" title="合并哈希表："></a>合并哈希表：</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">hashmap</span>() &#123;</span><br><span class="line">	<span class="comment">//合并哈希表</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map1</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    map1.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    map1.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map2</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    map2.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;b&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    map2.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;c&quot;</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (k , v) <span class="keyword">in</span> map2 &#123;</span><br><span class="line">        </span><br><span class="line">        map1.<span class="title function_ invoke__">entry</span>(k).<span class="title function_ invoke__">or_insert</span>(v);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>,map1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="qsunou@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QsunOu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
