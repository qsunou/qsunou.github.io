<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Learning about Rust&amp;Solana">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Learning about Rust&amp;Solana">
<meta property="og:locale">
<meta property="article:author" content="QsunOu">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/17/web3.js%E7%B4%A2%E5%BC%95Solana%E9%93%BE%E4%B8%8A%E6%95%B0%E6%8D%AE%E6%A1%88%E4%BE%8B%E5%8F%82%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/05/17/web3.js%E7%B4%A2%E5%BC%95Solana%E9%93%BE%E4%B8%8A%E6%95%B0%E6%8D%AE%E6%A1%88%E4%BE%8B%E5%8F%82%E8%80%83/" itemprop="url">web3.js索引Solana链上数据参考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-05-17T23:17:11+08:00">
                2025-05-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web3-js/" itemprop="url" rel="index">
                    <span itemprop="name">web3.js</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文章需要一定 <code>Nest.js</code> 、<code>SQL</code>、<code>TypeORM</code> 前置知识，这里暂不赘述。此文章讲解如何链接Solana链，获取交易信息、交易成功后事件、定时扫描链上数据写入数据库等。</p>
<p>&#x2F;program.service.ts  用于通过RPC连接到 Solana链上</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="comment">// Here we export some useful types and functions for interacting with the Anchor program.</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AnchorProvider</span>, <span class="title class_">Program</span>, <span class="title class_">Wallet</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mplTokenMetadata &#125; <span class="keyword">from</span> <span class="string">&#x27;@metaplex-foundation/mpl-token-metadata&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Umi</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@metaplex-foundation/umi&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createUmi &#125; <span class="keyword">from</span> <span class="string">&#x27;@metaplex-foundation/umi-bundle-defaults&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; walletAdapterIdentity &#125; <span class="keyword">from</span> <span class="string">&#x27;@metaplex-foundation/umi-signer-wallet-adapters&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AccountInfo</span>, <span class="title class_">Connection</span>, <span class="title class_">Keypair</span>, <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; getAccount, <span class="variable constant_">TOKEN_PROGRAM_ID</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/spl-token&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ZxxIDL</span> <span class="keyword">from</span> <span class="string">&#x27;../../program/idl/zxx.json&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Zxx</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../../program/types/zxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ProgramService</span> &#123;</span><br><span class="line">	<span class="comment">//请先准备个钱包以及私钥</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">visitorWallet</span>: <span class="title class_">Wallet</span> = <span class="keyword">new</span> <span class="title class_">Wallet</span>(</span><br><span class="line">    <span class="title class_">Keypair</span>.<span class="title function_">fromSecretKey</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line"></span><br><span class="line">      ]),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="attr">endpoints</span>: <span class="built_in">string</span>[];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// env文件自行准备，并且里面提供RPC URL，例如Helius的RPC</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">endpoints</span> = [</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">PROVIDER_ENDPOINT_02</span>,</span><br><span class="line">      process.<span class="property">env</span>.<span class="property">PROVIDER_ENDPOINT_03</span>,</span><br><span class="line">    ].<span class="title function_">filter</span>((endpoint): endpoint is <span class="built_in">string</span> =&gt; endpoint !== <span class="literal">undefined</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">connection</span>(): <span class="title class_">Connection</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> endpoint =</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">endpoints</span>[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="variable language_">this</span>.<span class="property">endpoints</span>.<span class="property">length</span>)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Connection</span>(endpoint, <span class="string">&#x27;confirmed&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">provider</span>(): <span class="title class_">AnchorProvider</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> provider = <span class="keyword">new</span> <span class="title class_">AnchorProvider</span>(<span class="variable language_">this</span>.<span class="property">connection</span>, <span class="variable language_">this</span>.<span class="property">visitorWallet</span>);</span><br><span class="line">    <span class="keyword">return</span> provider;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// idl文件也请自行准备好，就是anchor build之后生成的idl和ts文件，确保最新且准确，否则无法索引数据</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">program</span>(): <span class="title class_">Program</span>&lt;<span class="title class_">Zxx</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> program = <span class="keyword">new</span> <span class="title class_">Program</span>(<span class="title class_">ZxxIDL</span> <span class="keyword">as</span> <span class="title class_">Zxx</span>, <span class="variable language_">this</span>.<span class="property">provider</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Program initialized:&#x27;</span>, program.<span class="property">programId</span>.<span class="title function_">toBase58</span>());</span><br><span class="line">      <span class="keyword">return</span> program;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error initializing program:&#x27;</span>, error);</span><br><span class="line">      <span class="keyword">throw</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">umi</span>(): <span class="title class_">Umi</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createUmi</span>(<span class="variable language_">this</span>.<span class="property">connection</span>.<span class="property">rpcEndpoint</span>)</span><br><span class="line">      .<span class="title function_">use</span>(<span class="title function_">mplTokenMetadata</span>())</span><br><span class="line">      .<span class="title function_">use</span>(<span class="title function_">walletAdapterIdentity</span>(<span class="variable language_">this</span>.<span class="property">visitorWallet</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">fetchAllTokenAccountByMint</span>(<span class="params"><span class="attr">mint</span>: <span class="title class_">PublicKey</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> accounts = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">connection</span>.<span class="title function_">getParsedProgramAccounts</span>(</span><br><span class="line">      <span class="variable constant_">TOKEN_PROGRAM_ID</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">filters</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">dataSize</span>: <span class="number">165</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">memcmp</span>: &#123;</span><br><span class="line">              <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">              <span class="attr">bytes</span>: mint.<span class="title function_">toBase58</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> accounts <span class="keyword">as</span> &#123;</span><br><span class="line">      <span class="attr">pubkey</span>: <span class="title class_">PublicKey</span>;</span><br><span class="line">      <span class="attr">account</span>: <span class="title class_">AccountInfo</span>&lt;&#123;</span><br><span class="line">        <span class="attr">parsed</span>: &#123;</span><br><span class="line">          <span class="attr">info</span>: &#123;</span><br><span class="line">            <span class="attr">tokenAmount</span>: &#123;</span><br><span class="line">              <span class="attr">uiAmount</span>: <span class="built_in">number</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;&gt;;</span><br><span class="line">    &#125;[];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">fetchNewTransactions</span>(<span class="params"><span class="attr">ata</span>: <span class="built_in">string</span>, <span class="attr">last_signature</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> allSignatures = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">connection</span>.<span class="title function_">getSignaturesForAddress</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">PublicKey</span>(ata),</span><br><span class="line">      &#123; <span class="attr">until</span>: last_signature || <span class="literal">undefined</span> &#125;,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> allSignatures;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">fetchUserWalletAddress</span>(<span class="params"><span class="attr">ata</span>: <span class="title class_">PublicKey</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ataAccount = <span class="keyword">await</span> <span class="title function_">getAccount</span>(<span class="variable language_">this</span>.<span class="property">connection</span>, ata);</span><br><span class="line">    <span class="keyword">const</span> ownerPublicKey = ataAccount.<span class="property">owner</span>;</span><br><span class="line">    <span class="keyword">return</span> ownerPublicKey;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取合约交易成功后发出的emit事件，Instruction，eventData结构必须与合约相同</span></span><br><span class="line">  <span class="title function_">parseUserInitializedEvent</span>(<span class="params"><span class="attr">logs</span>: <span class="built_in">string</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> hasInitialize = logs.<span class="title function_">some</span>(<span class="function">(<span class="params">l</span>) =&gt;</span></span><br><span class="line">      l.<span class="title function_">includes</span>(<span class="string">&#x27;Instruction: InitializeUser&#x27;</span>),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!hasInitialize) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dataLine = logs.<span class="title function_">find</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l.<span class="title function_">startsWith</span>(<span class="string">&#x27;Program data:&#x27;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!dataLine) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> base64Data = dataLine.<span class="title function_">replace</span>(<span class="string">&#x27;Program data: &#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> eventData = <span class="variable language_">this</span>.<span class="property">program</span>.<span class="property">coder</span>.<span class="property">events</span>.<span class="title function_">decode</span>(base64Data);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (eventData.<span class="property">name</span> === <span class="string">&#x27;userInitialized&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">user</span>: eventData.<span class="property">data</span>.<span class="property">user</span>,</span><br><span class="line">          <span class="attr">nickname</span>: eventData.<span class="property">data</span>.<span class="property">nickname</span>,</span><br><span class="line">          <span class="attr">created_at</span>: eventData.<span class="property">data</span>.<span class="property">createdAt</span>.<span class="title function_">toNumber</span>(),</span><br><span class="line">          <span class="attr">owner</span>: eventData.<span class="property">data</span>.<span class="property">owner</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to decode event:&#x27;</span>, err);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">parseChannelNftCreateEvent</span>(<span class="params"><span class="attr">logs</span>: <span class="built_in">string</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> hasInitialize = logs.<span class="title function_">some</span>(<span class="function">(<span class="params">l</span>) =&gt;</span></span><br><span class="line">      l.<span class="title function_">includes</span>(<span class="string">&#x27;Instruction: ChannelNftCreate&#x27;</span>),</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!hasInitialize) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dataLine = logs.<span class="title function_">find</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l.<span class="title function_">startsWith</span>(<span class="string">&#x27;Program data:&#x27;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!dataLine) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> base64Data = dataLine.<span class="title function_">replace</span>(<span class="string">&#x27;Program data: &#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> eventData = <span class="variable language_">this</span>.<span class="property">program</span>.<span class="property">coder</span>.<span class="property">events</span>.<span class="title function_">decode</span>(base64Data);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;eventData&#x27;</span>, eventData);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (eventData.<span class="property">name</span> === <span class="string">&#x27;channelNftCreateEvent&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">channel_nft_mint</span>: eventData.<span class="property">data</span>.<span class="property">channelNftMint</span>,</span><br><span class="line">          <span class="attr">created_at</span>: eventData.<span class="property">data</span>.<span class="property">createdAt</span>,</span><br><span class="line">          <span class="attr">public_key</span>: eventData.<span class="property">data</span>.<span class="property">channelInfoAddress</span>,</span><br><span class="line">          <span class="attr">name</span>: eventData.<span class="property">data</span>.<span class="property">channelName</span>,</span><br><span class="line">          <span class="attr">symbol</span>: eventData.<span class="property">data</span>.<span class="property">channelSymbol</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to decode event:&#x27;</span>, err);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">parseEpisodeCreateEvent</span>(<span class="params"><span class="attr">logs</span>: <span class="built_in">string</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> hasInitialize = logs.<span class="title function_">some</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l.<span class="title function_">includes</span>(<span class="string">&#x27;Instruction: UpdateEp&#x27;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!hasInitialize) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dataLine = logs.<span class="title function_">find</span>(<span class="function">(<span class="params">l</span>) =&gt;</span> l.<span class="title function_">startsWith</span>(<span class="string">&#x27;Program data:&#x27;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!dataLine) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> base64Data = dataLine.<span class="title function_">replace</span>(<span class="string">&#x27;Program data: &#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> eventData = <span class="variable language_">this</span>.<span class="property">program</span>.<span class="property">coder</span>.<span class="property">events</span>.<span class="title function_">decode</span>(base64Data);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;eventData&#x27;</span>, eventData);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (eventData.<span class="property">name</span> === <span class="string">&#x27;episodeCreatedEvent&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">episode_name</span>: eventData.<span class="property">data</span>.<span class="property">episodeName</span>,</span><br><span class="line">          <span class="attr">episode_symbol</span>: eventData.<span class="property">data</span>.<span class="property">episodeSymbol</span>,</span><br><span class="line">          <span class="attr">channel</span>: eventData.<span class="property">data</span>.<span class="property">channel</span>.<span class="title function_">toString</span>(),</span><br><span class="line">          <span class="attr">creator</span>: eventData.<span class="property">data</span>.<span class="property">creator</span>.<span class="title function_">toString</span>(),</span><br><span class="line">          <span class="attr">metadata_cid</span>: eventData.<span class="property">data</span>.<span class="property">metadataCid</span>,</span><br><span class="line">          <span class="attr">created_at</span>: eventData.<span class="property">data</span>.<span class="property">createdAt</span>.<span class="title function_">toNumber</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to decode event:&#x27;</span>, err);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;tasks.service.ts 定时任务获取链上数据存入数据库</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Cron</span>, <span class="title class_">CronExpression</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/schedule&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InjectRepository</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/typeorm&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataSource</span>, <span class="title class_">Repository</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ChannelInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/channel/channel.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">EpisodeInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/episode/episode.entity&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ProgramService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/program/program.service&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UserInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;src/user/user.entity&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TasksService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">programService</span>: <span class="title class_">ProgramService</span>,</span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(ChannelInfo)</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">channelInfoRepository</span>: <span class="title class_">Repository</span>&lt;<span class="title class_">ChannelInfo</span>&gt;,</span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(EpisodeInfo)</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">episodeRepository</span>: <span class="title class_">Repository</span>&lt;<span class="title class_">EpisodeInfo</span>&gt;,</span></span><br><span class="line"><span class="params">    <span class="meta">@InjectRepository</span>(UserInfo)</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">userRepository</span>: <span class="title class_">Repository</span>&lt;<span class="title class_">UserInfo</span>&gt;,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> <span class="attr">dataSource</span>: <span class="title class_">DataSource</span>,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">parseTypeOfCost</span>(<span class="attr">typeOfCost</span>: <span class="built_in">any</span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;free&#x27;</span> <span class="keyword">in</span> typeOfCost) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;paid&#x27;</span> <span class="keyword">in</span> typeOfCost) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid type_of_cost&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时获取用户Pda数据，1分钟一次扫描</span></span><br><span class="line">  <span class="meta">@Cron</span>(<span class="title class_">CronExpression</span>.<span class="property">EVERY_MINUTE</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">handleUserSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start handleUserSync&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> program = <span class="variable language_">this</span>.<span class="property">programService</span>.<span class="property">program</span>;</span><br><span class="line">    <span class="keyword">const</span> userAccounts = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">userAccount</span>.<span class="title function_">all</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//遍历合约所有的用户Pda</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> userAccount <span class="keyword">of</span> userAccounts) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> publicKey = userAccount.<span class="property">publicKey</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="keyword">const</span> existingUser = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">userRepository</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">          <span class="attr">where</span>: &#123; <span class="attr">public_key</span>: publicKey &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 字段应在ORM的entity（数据库表）上存在，entity设计应参考合约Pda的账户结构</span></span><br><span class="line">        <span class="keyword">const</span> userData = &#123;</span><br><span class="line">          <span class="attr">id</span>: existingUser?.<span class="property">id</span>,</span><br><span class="line">          <span class="attr">public_key</span>: publicKey,</span><br><span class="line">          <span class="attr">owner</span>: userAccount.<span class="property">account</span>.<span class="property">owner</span>.<span class="title function_">toString</span>(),</span><br><span class="line">          <span class="attr">nickname</span>: userAccount.<span class="property">account</span>.<span class="property">nickname</span>,</span><br><span class="line">          <span class="attr">avatar</span>: userAccount.<span class="property">account</span>.<span class="property">avatar</span>,</span><br><span class="line">          <span class="attr">is_frozen</span>: userAccount.<span class="property">account</span>.<span class="property">isFrozen</span>,</span><br><span class="line">          <span class="attr">created_at</span>: userAccount.<span class="property">account</span>.<span class="property">createdAt</span>.<span class="title function_">toNumber</span>(),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//应使用save或upsert方法，不存在则自动创建字段，存在则更新，至于用哪种取决于你表的设计，是用pubkey唯一键还是用id主键</span></span><br><span class="line">        <span class="keyword">const</span> savedUser = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">userRepository</span>.<span class="title function_">save</span>(userData);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">`user <span class="subst">$&#123;existingUser ? <span class="string">&#x27;update&#x27;</span> : <span class="string">&#x27;create&#x27;</span>&#125;</span> successfully,ID: <span class="subst">$&#123;savedUser.id&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">          <span class="string">`Error processing user <span class="subst">$&#123;userAccount.publicKey.toString()&#125;</span>:`</span>,</span><br><span class="line">          error,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Cron</span>(<span class="title class_">CronExpression</span>.<span class="property">EVERY_MINUTE</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">handleChannelSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start handleChannelSync&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> program = <span class="variable language_">this</span>.<span class="property">programService</span>.<span class="property">program</span>;</span><br><span class="line">    <span class="keyword">const</span> channelinfos = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">channelInfo</span>.<span class="title function_">all</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> channelinfo <span class="keyword">of</span> channelinfos) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> channelPublicKey = channelinfo.<span class="property">publicKey</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="keyword">const</span> existingChannel = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">channelInfoRepository</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">          <span class="attr">where</span>: &#123; <span class="attr">public_key</span>: channelPublicKey &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">const</span> channelData = &#123;</span><br><span class="line">          <span class="attr">id</span>: existingChannel?.<span class="property">id</span>,</span><br><span class="line">          <span class="attr">public_key</span>: channelPublicKey,</span><br><span class="line">          <span class="attr">name</span>: channelinfo.<span class="property">account</span>.<span class="property">name</span>,</span><br><span class="line">          <span class="attr">symbol</span>: channelinfo.<span class="property">account</span>.<span class="property">symbol</span>,</span><br><span class="line">          <span class="attr">avatar</span>: channelinfo.<span class="property">account</span>.<span class="property">avatar</span>,</span><br><span class="line">          <span class="attr">description</span>: channelinfo.<span class="property">account</span>.<span class="property">description</span>,</span><br><span class="line">          <span class="attr">nft_mint_account</span>: channelinfo.<span class="property">account</span>.<span class="property">nftMintAccount</span>.<span class="title function_">toString</span>(),</span><br><span class="line">          <span class="attr">nft_mint_amount</span>: channelinfo.<span class="property">account</span>.<span class="property">nftMintAmount</span>,</span><br><span class="line">          <span class="attr">num_of_audios</span>: channelinfo.<span class="property">account</span>.<span class="property">numOfAudios</span>.<span class="title function_">toNumber</span>(),</span><br><span class="line">          <span class="attr">is_enabled</span>: channelinfo.<span class="property">account</span>.<span class="property">isEnabled</span>,</span><br><span class="line">          <span class="attr">type_of_cost</span>: <span class="variable language_">this</span>.<span class="title function_">parseTypeOfCost</span>(channelinfo.<span class="property">account</span>.<span class="property">typeOfCost</span>),</span><br><span class="line">          <span class="attr">created_at</span>: channelinfo.<span class="property">account</span>.<span class="property">createdAt</span>.<span class="title function_">toNumber</span>(),</span><br><span class="line">          <span class="attr">creators</span>: channelinfo.<span class="property">account</span>.<span class="property">creators</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">creator</span>) =&gt;</span> (&#123;</span><br><span class="line">            <span class="attr">address</span>: creator.<span class="property">address</span>.<span class="title function_">toString</span>(),</span><br><span class="line">            <span class="attr">share</span>: creator.<span class="property">share</span>,</span><br><span class="line">            <span class="attr">verified</span>: creator.<span class="property">verified</span>,</span><br><span class="line">          &#125;)),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> savedChannel = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">channelInfoRepository</span>.<span class="title function_">save</span>(channelData);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">`Channel <span class="subst">$&#123;existingChannel ? <span class="string">&#x27;updated&#x27;</span> : <span class="string">&#x27;created&#x27;</span>&#125;</span> with id: <span class="subst">$&#123;savedChannel.id&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">		<span class="comment">//以下是联表更新，可忽略，</span></span><br><span class="line">        <span class="keyword">if</span> (channelinfo.<span class="property">account</span>.<span class="property">creators</span>?.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> firstCreatorAddress =</span><br><span class="line">            channelinfo.<span class="property">account</span>.<span class="property">creators</span>[<span class="number">0</span>].<span class="property">address</span>.<span class="title function_">toString</span>();</span><br><span class="line">          <span class="keyword">const</span> creatorUser = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">userRepository</span>.<span class="title function_">findOneBy</span>(&#123;</span><br><span class="line">            <span class="attr">public_key</span>: firstCreatorAddress,</span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (creatorUser) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">channelInfoRepository</span>.<span class="title function_">update</span>(</span><br><span class="line">              &#123; <span class="attr">id</span>: savedChannel.<span class="property">id</span> &#125;,</span><br><span class="line">              &#123; <span class="attr">main_creator_id</span>: creatorUser.<span class="property">id</span> &#125;,</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">          <span class="string">`Error processing channel <span class="subst">$&#123;channelinfo.publicKey.toString()&#125;</span>:`</span>,</span><br><span class="line">          error,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Cron</span>(<span class="title class_">CronExpression</span>.<span class="property">EVERY_MINUTE</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">handleEpisodeSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start handleEpisodeSync&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> program = <span class="variable language_">this</span>.<span class="property">programService</span>.<span class="property">program</span>;</span><br><span class="line">    <span class="keyword">const</span> channelinfos = <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">channelInfo</span>.<span class="title function_">all</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> channelinfo <span class="keyword">of</span> channelinfos) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> channelPublicKey = channelinfo.<span class="property">publicKey</span>.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> channelEntity = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">channelInfoRepository</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">          <span class="attr">where</span>: &#123; <span class="attr">public_key</span>: channelPublicKey &#125;,</span><br><span class="line">          <span class="attr">relations</span>: [<span class="string">&#x27;episodes&#x27;</span>],</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!channelEntity) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`channel is not exist: <span class="subst">$&#123;channelPublicKey&#125;</span>`</span>);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!channelEntity.<span class="property">main_creator_id</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">`Skipping channel <span class="subst">$&#123;channelPublicKey&#125;</span> with no main creator`</span>,</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (channelinfo.<span class="property">account</span>.<span class="property">episodes</span>?.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">const</span> episode <span class="keyword">of</span> channelinfo.<span class="property">account</span>.<span class="property">episodes</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">const</span> existingEpisode = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">episodeRepository</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">                <span class="attr">where</span>: &#123; <span class="attr">metadata_cid</span>: episode.<span class="property">metadataCid</span> &#125;,</span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">const</span> episodeData = &#123;</span><br><span class="line">                <span class="attr">id</span>: existingEpisode?.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">metadata_cid</span>: episode.<span class="property">metadataCid</span>,</span><br><span class="line">                <span class="attr">name</span>: episode.<span class="property">name</span>,</span><br><span class="line">                <span class="attr">symbol</span>: episode.<span class="property">symbol</span>,</span><br><span class="line">                <span class="attr">created_at</span>: episode.<span class="property">createdAt</span>.<span class="title function_">toNumber</span>(),</span><br><span class="line">                <span class="attr">is_published</span>: episode.<span class="property">isPublished</span>,</span><br><span class="line">                <span class="attr">reward</span>: episode.<span class="property">rewards</span>.<span class="title function_">toNumber</span>(),</span><br><span class="line">                <span class="attr">channel</span>: channelEntity,</span><br><span class="line">                <span class="attr">channel_id</span>: channelEntity.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">creator_id</span>: channelEntity.<span class="property">main_creator_id</span>,</span><br><span class="line">                <span class="attr">rss_feed_id</span>: <span class="literal">null</span>,</span><br><span class="line">              &#125;;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">const</span> savedEpisode =</span><br><span class="line">                <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">episodeRepository</span>.<span class="title function_">save</span>(episodeData);</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">                <span class="string">` <span class="subst">$&#123;existingEpisode ? <span class="string">&#x27;update&#x27;</span> : <span class="string">&#x27;create&#x27;</span>&#125;</span> successfully: <span class="subst">$&#123;savedEpisode.id&#125;</span>`</span>,</span><br><span class="line">              );</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (channelinfo.<span class="property">account</span>.<span class="property">creators</span>?.[<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="keyword">const</span> creatorPublicKey =</span><br><span class="line">                  channelinfo.<span class="property">account</span>.<span class="property">creators</span>[<span class="number">0</span>].<span class="property">address</span>.<span class="title function_">toString</span>();</span><br><span class="line">                <span class="keyword">const</span> creator = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">userRepository</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">                  <span class="attr">where</span>: &#123; <span class="attr">public_key</span>: creatorPublicKey &#125;,</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (creator) &#123;</span><br><span class="line">                  savedEpisode.<span class="property">creator</span> = creator;</span><br><span class="line">                  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">episodeRepository</span>.<span class="title function_">save</span>(savedEpisode);</span><br><span class="line">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">                    <span class="string">`Update ep <span class="subst">$&#123;savedEpisode.id&#125;</span> ,Its creator is: <span class="subst">$&#123;creator.id&#125;</span>`</span>,</span><br><span class="line">                  );</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`: <span class="subst">$&#123;episode.metadataCid&#125;</span>`</span>, error);</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">          <span class="string">`handle channel and ep error: <span class="subst">$&#123;channelinfo.publicKey.toString()&#125;</span> `</span>,</span><br><span class="line">          error,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/19/ETH%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20lesson%201%20-%20Hello%20World/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/03/19/ETH%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20lesson%201%20-%20Hello%20World/" itemprop="url">Solidity lesson 1 - 介绍与部署第一个程序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-03-19T18:24:50+08:00">
                2025-03-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solidity-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Solidity 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是hardhat"><a href="#什么是hardhat" class="headerlink" title="什么是hardhat?"></a>什么是hardhat?</h1><p>Hardhat 是一个以 Ethereum 开发为核心的开发框架，主要用于智能合约的编写、测试、部署和调试。它为开发者提供了一套完整的工具链，极大地简化了以太坊开发流程，尤其是在本地开发环境中。</p>
<h1 id="环境hardhat准备："><a href="#环境hardhat准备：" class="headerlink" title="环境hardhat准备："></a>环境hardhat准备：</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> firstcontract</span><br><span class="line"><span class="built_in">cd</span> firstcontract </span><br><span class="line">yarn add -D hardhat <span class="comment">#安装包</span></span><br><span class="line">npx hardhat  <span class="comment">#初始化项目</span></span><br></pre></td></tr></table></figure>

<h1 id="hardhat目录结构"><a href="#hardhat目录结构" class="headerlink" title="hardhat目录结构:"></a>hardhat目录结构:</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">my-hardhat-project/</span><br><span class="line">├── contracts/          # 存放 Solidity 智能合约文件</span><br><span class="line">│   └── MyContract.sol  # 示例智能合约</span><br><span class="line">├── scripts/            # 存放部署脚本和其他脚本</span><br><span class="line">│   └── deploy.js       # 示例部署脚本</span><br><span class="line">├── test/               # 存放测试脚本</span><br><span class="line">│   └── MyContract.test.js  # 示例测试脚本</span><br><span class="line">├── artifacts/          # 编译后的合约 ABI 和字节码（自动生成）</span><br><span class="line">├── cache/              # 缓存文件（自动生成）</span><br><span class="line">├── hardhat.config.js   # Hardhat 配置文件</span><br><span class="line">└── package.json        # Node.js 项目配置文件</span><br></pre></td></tr></table></figure>

<h1 id="编写-HelloWorld"><a href="#编写-HelloWorld" class="headerlink" title="编写 HelloWorld"></a>编写 HelloWorld</h1><ol>
<li>solidity&#x2F;firstcontract&#x2F;contracts&#x2F;HelloWorld.sol:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line">contract <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params"></span>) public pure <span class="title function_">returns</span>(<span class="params">string memory</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>pure</code>和 <code>memory</code> 后面再讲</li>
</ol>
<p>版本号要与solidity&#x2F;firstcontract&#x2F;hardhat.config.js 相同或更高：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;@nomicfoundation/hardhat-toolbox&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> import(&#x27;hardhat/config&#x27;).HardhatUserConfig */</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">solidity</span>: <span class="string">&quot;0.8.24&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编译文件：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx hardhat compile</span><br></pre></td></tr></table></figure></li>
</ol>
<p>成功后会在 solidity&#x2F;firstcontract&#x2F;artifacts&#x2F;contracts&#x2F;HelloWorld.sol&#x2F;HelloWorld.json 生成json文件</p>
<ol start="3">
<li><p>把<code>hardhat.config.js</code>  改成 ts 文件,并修改内容</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-toolbox&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-ethers&quot;</span>;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Config</span> = <span class="keyword">import</span>(<span class="string">&quot;hardhat/config&quot;</span>).<span class="property">HardhatUserConfig</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">config</span>: <span class="title class_">Config</span> = &#123;</span><br><span class="line">  <span class="attr">solidity</span>: <span class="string">&quot;0.8.24&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> config;</span><br></pre></td></tr></table></figure>
</li>
<li><p>yarn 安装 ts-node 包</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add -D ts-node typescript</span><br></pre></td></tr></table></figure>

</li>
<li><p>编写单元测试，solidity&#x2F;firstcontract&#x2F;test&#x2F; 下的<code>Lock.js</code> 改为 <code>HelloWorld.ts</code> ,添加以下内容</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-ethers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ethers &#125; <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>; <span class="comment">//Ethers.js库的核心模块，提供与以太坊区块链交互的功能（如部署合约、调用方法）。</span></span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">&quot;chai&quot;</span>; <span class="comment">//Chai断言库的方法，用于测试结果是否符合预期。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// describe</span></span><br><span class="line"><span class="comment">// 定义一个测试套件，名为HelloWorld，用于组织相关测试用例。</span></span><br><span class="line"><span class="comment">// it</span></span><br><span class="line"><span class="comment">// 定义一个具体的测试用例，描述为should say hello world，表示测试目标是验证合约是否返回&quot;Hello World!&quot;。</span></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;HelloWorld&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;should say hello world&quot;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1.setup</span></span><br><span class="line">    <span class="comment">// 2.import contract</span></span><br><span class="line">    <span class="comment">// 3.test action</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">HW</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;HelloWorld&quot;</span>); <span class="comment">//获取名为HelloWorld的智能合约工厂对象(其实就之前写的合约），用于创建和部署合约实例。</span></span><br><span class="line">    <span class="keyword">const</span> hw = <span class="keyword">await</span> <span class="variable constant_">HW</span>.<span class="title function_">deploy</span>(); <span class="comment">//部署HelloWorld合约到本地测试网络，并返回合约实例。</span></span><br><span class="line">    <span class="keyword">await</span> hw.<span class="title function_">waitForDeployment</span>(); <span class="comment">//等待合约部署完成，确保后续操作在合约可用状态下执行。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//  hw.hello()</span></span><br><span class="line">    <span class="comment">// 调用合约的hello方法，获取其返回值。</span></span><br><span class="line">    <span class="comment">// expect(...).to.equal(...)</span></span><br><span class="line">    <span class="comment">// 使用Chai断言库验证返回值是否等于字符串&quot;Hello World!&quot;。</span></span><br><span class="line">    <span class="title function_">expect</span>(<span class="keyword">await</span> hw.<span class="title function_">hello</span>()).<span class="property">to</span>.<span class="title function_">equal</span>(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>项目根目录创建个tsconfig.json文件，内容添加<code>&#123;&#125;</code> </p>
</li>
<li><p>进行测试</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx hardhat test</span><br></pre></td></tr></table></figure>
</li>
<li><p>本地启动一个区块链节点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npx hardhat node</span><br><span class="line">Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/</span><br></pre></td></tr></table></figure>
</li>
<li><p>根目录下创建scripts目录，并创建 deploy-hello.ts<br>&#x2F;Users&#x2F;qsun-ou&#x2F;solidity&#x2F;firstcontract&#x2F;scripts&#x2F;deploy-hello.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;@nomicfoundation/hardhat-ethers&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ethers &#125; <span class="keyword">from</span> <span class="string">&quot;hardhat&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">deploy</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">HelloWorld</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;HelloWorld&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> helloWorld = <span class="keyword">await</span> <span class="title class_">HelloWorld</span>.<span class="title function_">deploy</span>(); <span class="comment">//HelloWorld.deploy() 部署合约到区块链。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> helloWorld.<span class="title function_">waitForDeployment</span>(); <span class="comment">//使用 waitForDeployment() 确保合约成功部署。</span></span><br><span class="line">  <span class="keyword">return</span> helloWorld;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该函数用于调用已部署的 HelloWorld 合约的 hello 方法，并打印返回值。</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"><span class="attr">helloWorld</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hello = <span class="keyword">await</span> helloWorld.<span class="title function_">hello</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(hello);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是程序的主入口，负责依次执行以下操作：</span></span><br><span class="line"><span class="comment">// 调用 deploy 函数，部署 HelloWorld 合约。</span></span><br><span class="line"><span class="comment">// 将部署完成的合约实例传递给 sayHello 函数，调用并打印 hello 方法的结果。</span></span><br><span class="line"><span class="title function_">deploy</span>().<span class="title function_">then</span>(sayHello);</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行本地网络测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx hardhat run ./scripts/deploy-hello.ts --network localhost</span><br></pre></td></tr></table></figure></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/12/Move%20%E5%9F%BA%E7%A1%80%20-%20lesson%201%20%20Hello%20move/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/03/12/Move%20%E5%9F%BA%E7%A1%80%20-%20lesson%201%20%20Hello%20move/" itemprop="url">Move lesson 1 - 介绍与部署第一个程序</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-03-12T23:38:17+08:00">
                2025-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Move-%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index">
                    <span itemprop="name">Move 开发基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是Sui和Move"><a href="#什么是Sui和Move" class="headerlink" title="什么是Sui和Move"></a>什么是Sui和Move</h1><p>Sui是致力于将去中心化技术带给大众的区块链。其代币SUI用于保护网络、支付燃料费、促成链上交易并在未来实现治理。</p>
<p>Mysten Labs是Sui最初的开发团队，由Meta的前雇员创立，这些雇员曾研究Diem区块链项目（前身为Libra）。作为研究的一部分，该团队开发了几项新技术，如新智能合约编程语言Move以及高吞吐量内存池Narwhal和共识引擎Bullshark。</p>
<p>Move 是一种专门为区块链设计的编程语言，最初由 Facebook（现 Meta）为其 Libra（后来更名为 Diem）项目开发。尽管 Diem 项目最终未能成功，但 Move 作为一种安全、高效的智能合约语言被保留了下来，并被其他区块链项目（如 Sui 和 Aptos）广泛采用。</p>
<p>Move 的设计受到了 Rust 的启发，特别是在类型系统、所有权机制和模块化设计方面。Rust 是一种通用语言，而 Move 是专门为区块链设计的智能合约语言。熟悉 Rust 的开发者可以快速上手 Move，因为两者在语法和理念上有许多相似之处。</p>
<h1 id="Sui-cli安装"><a href="#Sui-cli安装" class="headerlink" title="Sui-cli安装"></a>Sui-cli安装</h1><p>以mac os 为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install sui</span><br><span class="line">sui --version</span><br><span class="line">sui 1.44.3-homebrew</span><br></pre></td></tr></table></figure>

<h1 id="安装Sui钱包"><a href="#安装Sui钱包" class="headerlink" title="安装Sui钱包"></a>安装Sui钱包</h1><p>google浏览器 扩展商店搜 <code>Sui Wallet</code>或者<code>Suiet Wallet</code> 进行安装</p>
<h1 id="区块链浏览器"><a href="#区块链浏览器" class="headerlink" title="区块链浏览器"></a>区块链浏览器</h1><ul>
<li><a target="_blank" rel="noopener" href="https://suiscan.xyz/">https://suiscan.xyz/</a></li>
<li><a target="_blank" rel="noopener" href="https://suivision.xyz/">https://suivision.xyz/</a></li>
</ul>
<h1 id="获取测试网SUI"><a href="#获取测试网SUI" class="headerlink" title="获取测试网SUI"></a>获取测试网SUI</h1><p><a target="_blank" rel="noopener" href="https://docs.sui.io/guides/developer/getting-started/get-coins">https://docs.sui.io/guides/developer/getting-started/get-coins</a></p>
<p>查看当前钱包地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sui client addresses </span><br></pre></td></tr></table></figure>

<p>获取测试SUI</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sui client faucet </span><br></pre></td></tr></table></figure>

<p>查看是否成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sui client gas </span><br></pre></td></tr></table></figure>

<p>给指定地址获取SUI</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST &#x27;https://faucet.testnet.sui.io/gas&#x27; \</span><br><span class="line">--header &#x27;Content-Type: application/json&#x27; \</span><br><span class="line">--data-raw &#x27;&#123;</span><br><span class="line">    &quot;FixedAmountRequest&quot;: &#123;</span><br><span class="line">        &quot;recipient&quot;: &quot;0x1fdcbc218b29c5d91eb445781016a24658c45825a8469b76f0efb289ccc89f86&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>创建项目<br><code>sui move new hello_move</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">module hello_move::hello ;</span><br><span class="line"></span><br><span class="line">use std::ascii::&#123;String, string&#125;;</span><br><span class="line">use sui::object::&#123;Self, UID&#125;;</span><br><span class="line">use sui::transfer::transfer;</span><br><span class="line">use sui::tx_context::&#123;TxContext, sender&#125;;</span><br><span class="line"></span><br><span class="line">public struct Hello has key &#123;</span><br><span class="line">    id: UID,</span><br><span class="line">    say: String</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun init(ctx: &amp;mut TxContext) &#123;</span><br><span class="line">    let hello_move = Hello &#123;</span><br><span class="line">        id: object::new(ctx),</span><br><span class="line">        say: string(b&quot;move&quot;),</span><br><span class="line">    &#125;;</span><br><span class="line">    transfer(hello_move, sender(ctx));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发布上链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sui client publish </span><br></pre></td></tr></table></figure>

<p>生成的地址可以去区块链浏览器里面搜，查看结果</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20Solana%20%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86-%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20Solana%20%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86-%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6/" itemprop="url">Solana 合约开发 - Solana 基础原理-共识机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-28T23:04:23+08:00">
                2025-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="大概介绍："><a href="#大概介绍：" class="headerlink" title="大概介绍："></a>大概介绍：</h1><h2 id="共识机制（后面还会详细介绍）："><a href="#共识机制（后面还会详细介绍）：" class="headerlink" title="共识机制（后面还会详细介绍）："></a>共识机制（后面还会详细介绍）：</h2><ul>
<li><strong>Proof of History (PoH)</strong>: PoH 是一种创新的时间记录机制，通过加密散列函数生成一个可验证的时间顺序，使得区块链中的事件可以按时间线性顺序排列。这减少了节点之间的时间同步需求，使得节点能够迅速达成共识，而无需等待整个网络确认，这是重点。</li>
<li><strong>Proof of Stake (PoS)</strong>: 验证者需要抵押一定数量的 SOL 代币，持有更多代币的验证者有更高的概率被选中生成区块。PoS 提供了经济激励，确保验证者行为诚实。</li>
<li><strong>PoH</strong> 确保区块的时间戳和顺序，<strong>PoS</strong> 则确保网络的安全性和抗攻击性，两者结合使得网络能够达到<strong>每秒数千笔</strong>交易处理速度</li>
</ul>
<h2 id="交易处理能力："><a href="#交易处理能力：" class="headerlink" title="交易处理能力："></a>交易处理能力：</h2><ul>
<li><strong>并行处理</strong>: 通过将交易分解为多个子集，利用不同的验证节点并行处理，提高了吞吐量。Solana 的架构支持高达每秒数千笔交易，平均出块时间为 400 毫秒，平均每秒 2000+ 笔交易，在高负载时保持较低的交易费用。</li>
<li><strong>低延迟和低费用</strong>: Solana 的架构设计使其能够快速确认交易，通常在一秒以内完成。即使在高负载下，交易费用仍保持低廉，适合需要高频交易的应用。</li>
</ul>
<h2 id="交易费用（gas费用）："><a href="#交易费用（gas费用）：" class="headerlink" title="交易费用（gas费用）："></a>交易费用（gas费用）：</h2><p><strong>Solana</strong>它的交易费用是根据交易的复杂度和大小动态计算的，这意味着，交易费用会根据交易的执行成本而变化，而不是根据网络上的交易量变化。Solana 的平均交易费用通常低于 0.01 美元，平均为 0.00025 美元，这使得进行小额交易更具成本效益。</p>
<h2 id="智能合约："><a href="#智能合约：" class="headerlink" title="智能合约："></a>智能合约：</h2><p><strong>Solana</strong>中一切皆账户，它的智能合约（Solana 中称之为<strong>程序</strong>program，后续也统一使用“程序”这一术语）也是账户，但细分为<strong>可执行账户</strong>和<strong>数据账户</strong>，前者存储程序的代码，用来执行特定的逻辑，后者存储状态，即程序运行时的数据。这种分离的模式，使得程序的升级更加简单，因为程序本身无状态，可以直接升级为新的代码逻辑。</p>
<h2 id="账户："><a href="#账户：" class="headerlink" title="账户："></a>账户：</h2><p><strong>Solana</strong>中一切皆账户，它的账户就像一个容器（或者电脑中的文件夹），可以包含程序代码、状态数据以及账户元数据。按照功能可划分为<strong>可执行账户</strong>和<strong>数据账户</strong>，前者为存储程序代码的账户，也称为程序账户。后者包括<strong>普通用户账户</strong>和其他非程序账户，这些账户存储了用户的余额、交易历史和其他相关数据，但它们本身不包含程序代码。</p>
<h1 id="共识机制："><a href="#共识机制：" class="headerlink" title="共识机制："></a>共识机制：</h1><h2 id="先讲讲传统共识机制"><a href="#先讲讲传统共识机制" class="headerlink" title="先讲讲传统共识机制"></a>先讲讲传统共识机制</h2><p>分布式区块链网络中的每个节点都有自己的内部时钟，它按照这个本地系统时钟运行。当发生交易时，节点将根据这个本地系统时钟为交易添加时间戳。</p>
<p>最终确认或拒绝交易的时间戳也将根据这个本地系统区块进行。在传统的共识机制（例如工作量证明 PoW 和权益证明 PoS）中，所有的节点需要相互沟通，以协调彼此的本地时钟，以确保它们在处理交易时对时间的理解是一致的。节点之间的通信有助于建立一个共同的时间基准，以确保整个网络对时间的认知是一致的，从而协调交易的顺序和确认。</p>
<p>对于一个分布式区块链，有成千上万个节点分布在全球各地，节点之间的本地系统时钟存在差异是不可避免的，导致交易的时间戳在不同节点之间不一致。当节点需要就发生了哪些交易以及这些交易在区块中的顺序达成共识时，这就成为一个问题。<strong>这被称为时间戳同步问题，当网络通过增加节点数量来增强去中心化时，这个问题会变得更加严重和复杂。</strong></p>
<p>最终，这为恶意攻击创造了一条可能的路径。时间上的差异使恶意行为者能够广播类似于真实时间戳的虚假交易，试图掌控网络。为防止对交易的操纵，需要花费大量的时间和处理能力来验证时间戳的准确性。这有可能导致区块确认的延迟，甚至区块被拒绝（因为节点可能投票认为区块无效，原因是具有不同的时间戳）。</p>
<h2 id="什么是PoH（历史证明）？"><a href="#什么是PoH（历史证明）？" class="headerlink" title="什么是PoH（历史证明）？"></a>什么是PoH（历史证明）？</h2><p><strong>Proof of History (PoH)</strong> ，PoH 是一种“时间戳机制”，它通过连续的哈希计算生成一个不可篡改的时间链，为每个事件提供唯一的时间标记。</p>
<ul>
<li>每个哈希值都依赖于前一个哈希值，形成一个“时间序列”。</li>
<li>这个时间序列可以被任何节点独立验证，而无需额外的通信。</li>
</ul>
<h3 id="工作原理："><a href="#工作原理：" class="headerlink" title="工作原理："></a>工作原理：</h3><p>PoH 的实现基于 <strong>SHA-256 哈希函数</strong> ，具体过程如下：</p>
<ol>
<li><p><strong>初始化</strong> :</p>
<ul>
<li>选择一个初始值（称为“种子”）。</li>
<li>开始对这个种子进行 SHA-256 哈希计算。</li>
</ul>
</li>
<li><p><strong>连续哈希</strong> :</p>
<ul>
<li>将当前的哈希值作为输入，计算下一个哈希值。</li>
<li>不断重复这一过程，生成一个连续的哈希链。</li>
</ul>
</li>
<li><p><strong>记录事件</strong> :</p>
<ul>
<li>当某个事件发生时（例如接收到一笔交易），将该事件的数据插入到当前的哈希值中。</li>
<li>继续哈希计算，生成新的哈希值。</li>
</ul>
</li>
<li><p><strong>验证</strong> :</p>
<ul>
<li>其他节点可以通过重新计算哈希链来验证事件的顺序和时间。</li>
</ul>
</li>
</ol>
<h3 id="举个例子："><a href="#举个例子：" class="headerlink" title="举个例子："></a>举个例子：</h3><p>假设我们有一个简单的哈希链，初始值为 <code>H0</code>，原本它的生成过程是这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">H0 = SHA256(&quot;seed&quot;)</span><br><span class="line">H1 = SHA256(H0)</span><br><span class="line">H2 = SHA256(H1)</span><br><span class="line">H3 = SHA256(H2)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>如果在生成 <code>H2</code> 时发生了一笔交易 <code>T1</code>，我们可以将 <code>T1</code> 的数据插入到 <code>H2</code> 中，相当于顺序+交易：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">H2_with_T1 = SHA256(H1 + T1)</span><br></pre></td></tr></table></figure>

<p>然后继续生成后续的哈希值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">H3 = SHA256(H2_with_T1)</span><br><span class="line">H4 = SHA256(H3)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="PoH的优势"><a href="#PoH的优势" class="headerlink" title="PoH的优势"></a>PoH的优势</h3><ol>
<li><p>全局时间顺序<br>PoH 提供了一个全局的时间参考，所有节点都可以独立验证事件的顺序，而无需额外的通信。</p>
</li>
<li><p>减少通信开销<br>传统区块链需要通过消息传递来确认事件顺序，而 PoH 通过哈希链直接提供了时间顺序，显著减少了节点之间的通信需求。</p>
</li>
<li><p>提高效率<br>由于节点不需要等待共识完成，交易可以更快地被打包和处理。</p>
</li>
</ol>
<h2 id="什么是PoS？"><a href="#什么是PoS？" class="headerlink" title="什么是PoS？"></a>什么是PoS？</h2><p>先来了解下在 Solana的系统架构中最重要的两种角色：<strong>Leader</strong>（出块者）和 <strong>Validator</strong>（验证者）。两者实际上都是质押了 SOL 代币的全节点，只是在不同的出块周期内，Leader 会由不同的全节点来充当，而没有当选 Leader 的全节点会成为 Validator。 所以在选择验证者方面， Solana 采用的是 PoS（权益证明）机制，验证者是通过抵押一定数量的代币来参与网络交易的验证的，持有更多代币的验证者有更大的机会被选中生成新的区块。</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><ol>
<li><p>用户发起交易后，会被客户端直接转发给 Leader 节点，或者先被普通节点接收，再立刻转发给 Leader；</p>
</li>
<li><p>出块者 Leader 接收网络内全部的待处理交易，一边执行，一边给交易指令排序，制成交易序列（类似区块）。每隔一段时间，Leader 会把排好的交易序列发送给 Validator 验证节点；</p>
</li>
<li><p>Validator 按照交易序列（区块）给定的顺序执行交易，产生相应的状态信息State（执行交易会改变节点的状态，比如改变某些账户的余额）；</p>
</li>
<li><p>每发送 N 个交易序列，Leader 会定期公开本地的状态 State，Validator会将其与自己的 State 作对比，给出 肯定&#x2F;否定 的投票。</p>
</li>
<li><p>如果在规定时间内，Leader收集到占全网 2&#x2F;3 质押权重的节点们给出的肯定票，则此前发布的交易序列和状态 State 就被敲定，“检查点”通过，相当于区块完成最终确认 Finality；</p>
</li>
<li><p>一般而言，给出肯定票的 Validator 节点与出块者 Leader 所执行的交易、执行后的状态都是相同的，数据会同步。</p>
</li>
</ol>
<h2 id="结合两个流程，大概就是："><a href="#结合两个流程，大概就是：" class="headerlink" title="结合两个流程，大概就是："></a>结合两个流程，大概就是：</h2><p><strong>1. PoH 生成器启动</strong></p>
<ul>
<li>假设当前的 PoH 生成器（通常是当前的 leader 节点）开始工作。</li>
</ul>
<p><strong>2. PoH 序列生成</strong></p>
<p>PoH 生成器开始连续进行哈希操作</p>
<p><strong>3. 交易到达</strong></p>
<p><strong>4. 交易嵌入 PoH</strong></p>
<p>PoH 生成器将 T1 嵌入到 PoH 序列中</p>
<p><strong>5. 继续生成 PoH 和处理交易</strong></p>
<ul>
<li>更多的交易陆续到达并被嵌入 PoH 序列</li>
</ul>
<p><strong>6. 形成区块</strong></p>
<ul>
<li>假设每 200 个 PoH 条目形成一个区块</li>
<li>当达到 Index 200 时，当前的 PoH 序列和所有嵌入的交易被打包成一个区块</li>
</ul>
<p><strong>7. 区块广播和验证</strong></p>
<ul>
<li>Leader 节点将这个区块广播给其他验证者节点</li>
<li>验证者接收到区块后，可以并行验证 PoH 序列：<ul>
<li>验证者 1 检查 Index 0-66</li>
<li>验证者 2 检查 Index 67-133</li>
<li>验证者 3 检查 Index 134-200</li>
</ul>
</li>
</ul>
<p><strong>8. 共识和确认</strong></p>
<ul>
<li>验证者快速确认 PoH 序列的正确性</li>
<li>他们也验证嵌入的交易（T1, T2, T3 等）是否有效</li>
<li>一旦大多数验证者确认，区块被添加到链上</li>
</ul>
<p><strong>9. Leader 轮换</strong></p>
<ul>
<li>基于 PoH 序列，网络预先知道下一个 leader 是谁</li>
<li>例如，如果每 1000 个 PoH 条目轮换一次 leader，那么在 Index 1000 时，新的 leader 接管 PoH 生成</li>
</ul>
<p><strong>10. 时间估算</strong></p>
<ul>
<li>假设每次哈希操作平均需要 0.1 毫秒</li>
<li>那么 200 个 PoH 条目（一个区块）大约代表 20 毫秒的真实时间</li>
<li>网络可以据此估算交易的确切时间戳</li>
</ul>
<h2 id="领导者（Leader）选举"><a href="#领导者（Leader）选举" class="headerlink" title="领导者（Leader）选举"></a>领导者（Leader）选举</h2><p>在 Solana 的共识协议中，有 Epoch（纪元）和Slot（间隔）两大时间单位。每个 Slot 约为0.4<del>0.8秒，相当于一个区块的时间间隔。而每个Epoch周期包含43.2万个Slot（区块），长达2</del>4天。每过4个 Slot（出块周期），Leader节点就会进行一次变更。</p>
<p>Solana 使用一种称为 Tower BFT（一种改进的实用拜占庭容错算法）的共识机制，结合 Proof of Stake (PoS) 和 Proof of History (PoH) 来选择和轮换 leader。</p>
<ol>
<li><strong>Leader 调度</strong>:<ul>
<li>Solana 网络预先确定一个 leader 调度表，通常覆盖未来几天的时间。</li>
<li>这个调度是基于验证者的质押量（stake）按比例分配的。</li>
</ul>
</li>
<li><strong>Leader 轮换</strong>:<ul>
<li>Leader 角色在验证者之间频繁轮换，通常每 400 毫秒（一个 “slot”）就会切换。</li>
<li>在一个 “epoch”（大约 2-3 天）内，每个验证者都有机会成为 leader。</li>
</ul>
</li>
<li><strong>单一 Leader</strong>:<ul>
<li>在任何给定的时刻，<strong>只有一个节点作为 leader</strong>。</li>
<li>Leader 负责生成 PoH 序列和打包交易到区块。</li>
</ul>
</li>
<li><strong>Leader 的职责</strong>:<ul>
<li>生成 PoH 序列</li>
<li>接收交易并将其打包到区块</li>
<li>广播区块给其他验证者</li>
</ul>
</li>
</ol>
<p>在每个新的Epoch周期开始时，Solana网络会按照各节点的质押权重进行抽选，组成一个出块者Leader轮换名单，“钦定”了未来不同时刻的出块者。也就是说出块者会提前获知他们成为出块者。 具体而言，究竟如何指定 Leader 会考虑诸多因素，比如：</p>
<ol>
<li><p><strong>质押的代币数量：</strong> 在 PoS 中，质押的代币数量是一个关键的考虑因素。Validator 通常倾向于选择质押数量较大的节点，因为这增加了节点被选中为区块生产者的机会。这也有助于确保网络由具有足够利益参与的节点维护。</p>
</li>
<li><p><strong>节点的性能：</strong> Validator 的节点性能是另一个关键因素。高性能的节点能够更快速地验证和打包交易，有助于维持网络的高吞吐量。Validator 可能会选择性能较好的节点以提高整个网络的效率。</p>
</li>
<li><p><strong>网络延迟：</strong> Validator 可能会考虑节点之间的网络延迟。选择网络延迟较低的节点有助于减少区块的传播时间，从而提高网络的实时性。</p>
</li>
<li><p><strong>节点的可用性：</strong> Validator 会关注节点的可用性，确保它们能够稳定运行而不容易出现故障。可靠的节点能够为网络提供更稳定的服务。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%E4%BA%8C%EF%BC%9AETF%20%E5%88%9B%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%E4%BA%8C%EF%BC%9AETF%20%E5%88%9B%E5%BB%BA/" itemprop="url">Solana 合约开发 - DeFi - Dex 开发十二：ETF 创建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-28T22:22:19+08:00">
                2025-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-DeFi-Dex/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发-DeFi-Dex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是ETF"><a href="#什么是ETF" class="headerlink" title="什么是ETF?"></a>什么是ETF?</h1><p>交易型开放式指数基金（ETF） 是一种将多个资产打包成一个投资组合的金融工具，投资者可以通过交易所像股票一样买卖 ETF 份额。ETF 常常追踪某一特定市场指数（如 S&amp;P 500）或者行业、商品、债券等多元化资产。通过 ETF，投资者能够低成本地获得广泛的市场暴露，通常用于长期投资和资产配置。</p>
<h1 id="什么是DeFi-ETF？"><a href="#什么是DeFi-ETF？" class="headerlink" title="什么是DeFi ETF？"></a>什么是DeFi ETF？</h1><p>很简单，跟ETF的区别在于由智能合约进行管理，ETF包含的资产从股票等变成了各种Token，流动性也依赖于AMM，交易透明，全天24小时开放。</p>
<h1 id="合约代码："><a href="#合约代码：" class="headerlink" title="合约代码："></a>合约代码：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/programs/swap/src/states/etf.rs</span></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ETF代币</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="meta">#[derive(InitSpace)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> creator: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> create_time: <span class="type">i64</span>,</span><br><span class="line">    <span class="meta">#[max_len(50)]</span></span><br><span class="line">    <span class="keyword">pub</span> description: <span class="type">String</span>,</span><br><span class="line">    <span class="meta">#[max_len(10)]</span></span><br><span class="line">    <span class="keyword">pub</span> assets: <span class="type">Vec</span>&lt;EtfAsset&gt;,  <span class="comment">//其实创建ETF跟创建普通token差不多，区别在于这里用Vec包含多个token的Mint地址。</span></span><br><span class="line">    <span class="keyword">pub</span> status: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> ETFTOKEN_SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;etf_token_v1&quot;</span>;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> ETFTOKEN_DECIMALS: <span class="type">u8</span> = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> ETFTOKEN_METADATA_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;metadata&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ETF代币总资产信息,作为结构体传入，用于创建ETF代币</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfTokenArgs</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> name: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> symbol: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> description: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> url: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> assets: <span class="type">Vec</span>&lt;EtfAsset&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfTokenArgs</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_account</span>(<span class="keyword">self</span>, creator: Pubkey, etf_mint: Pubkey) <span class="punctuation">-&gt;</span> EtfToken &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">clock</span> = Clock::<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">status</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        EtfToken &#123;</span><br><span class="line">            creator,</span><br><span class="line">            etf_mint,</span><br><span class="line">            description: <span class="keyword">self</span>.description,</span><br><span class="line">            assets: <span class="keyword">self</span>.assets,</span><br><span class="line">            create_time: clock.unix_timestamp,</span><br><span class="line">            status,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ETF代币子资产信息</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="meta">#[derive(InitSpace)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfAsset</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> token: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> weight: <span class="type">u16</span>,  <span class="comment">// 每种子资产token占ETF的比例</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/programs/swap/src/accounts_all/etf.rs</span></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::associated_token::AssociatedToken;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::metadata::Metadata;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::Token;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_2022::Token2022;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::&#123;Mint,  TokenAccount, TokenInterface&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::&#123;EtfToken, BuyerOrderInfo,  EtfTokenArgs,AmmConfig&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="meta">#[instruction(args: EtfTokenArgs)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfTokenCreate</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于存储etf token的信息</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = authority,</span></span><br><span class="line"><span class="meta">        space = 8 + EtfToken::INIT_SPACE,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            EtfToken::ETFTOKEN_SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            etf_token_mint_account.key().as_ref(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> etf_token_info: <span class="type">Box</span>&lt;Account&lt;<span class="symbol">&#x27;info</span>, EtfToken&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: Validate address by deriving pda</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            EtfToken::ETFTOKEN_METADATA_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            token_metadata_program.key().as_ref(),</span></span><br><span class="line"><span class="meta">            etf_token_mint_account.key().as_ref()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">        seeds::program = token_metadata_program.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> etf_metadata_account: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ETF token mint</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        payer = authority,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            EtfToken::ETFTOKEN_SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            args.symbol.as_bytes(), // symbol不允许重复</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">        mint::decimals = EtfToken::ETFTOKEN_DECIMALS,</span><br><span class="line">        mint::authority = etf_token_info.<span class="title function_ invoke__">key</span>(), </span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> etf_token_mint_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> authority: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> token_metadata_program: Program&lt;<span class="symbol">&#x27;info</span>, Metadata&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program_2022: Program&lt;<span class="symbol">&#x27;info</span>, Token2022&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="keyword">pub</span> rent: Sysvar&lt;<span class="symbol">&#x27;info</span>, Rent&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::TokenAccount;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    associated_token::get_associated_token_address,</span><br><span class="line">    metadata::&#123;</span><br><span class="line">        create_metadata_accounts_v3, mpl_token_metadata::types::DataV2, CreateMetadataAccountsV3,</span><br><span class="line">    &#125;,</span><br><span class="line">    token::&#123;burn, mint_to, transfer, Burn, MintTo, Transfer&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::accounts_all::*;</span><br><span class="line"><span class="keyword">use</span> crate::calculate::*;</span><br><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> crate::states::*;</span><br><span class="line"><span class="keyword">use</span> crate::util::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ETF创建</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_etf_token_metadata</span>(ctx: Context&lt;EtfTokenCreate&gt;, args: EtfTokenArgs) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">etf_token_mint_key</span> = ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        EtfToken::ETFTOKEN_SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">        etf_token_mint_key.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        &amp;[ctx.bumps.etf_token_info],</span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">create_metadata_accounts_v3</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            ctx.accounts.etf_metadata_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            CreateMetadataAccountsV3 &#123;</span><br><span class="line">                metadata: ctx.accounts.etf_metadata_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                mint_authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                update_authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                payer: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                system_program: ctx.accounts.system_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                rent: ctx.accounts.rent.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        DataV2 &#123;</span><br><span class="line">            name: args.name.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            symbol: args.symbol.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            uri: args.url.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            seller_fee_basis_points: <span class="number">0</span>,</span><br><span class="line">            creators: <span class="literal">None</span>,</span><br><span class="line">            collection: <span class="literal">None</span>,</span><br><span class="line">            uses: <span class="literal">None</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="literal">true</span>,</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    ctx.accounts.etf_token_info.<span class="title function_ invoke__">set_inner</span>(args.<span class="title function_ invoke__">create_account</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_etf_token_metadata</span>(</span><br><span class="line">        ctx: Context&lt;EtfTokenCreate&gt;,</span><br><span class="line">        args: EtfTokenArgs,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        instructions::<span class="title function_ invoke__">create_etf_token_metadata</span>(ctx, args)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="前端测试代码："><a href="#前端测试代码：" class="headerlink" title="前端测试代码："></a>前端测试代码：</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/example/api/etf.ts</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&#x27;./wallet&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createETFToken</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token_1_mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token_2_mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> etfTokenArgs = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;ETF_v1&#x27;</span>,</span><br><span class="line">    <span class="attr">symbol</span>: <span class="string">&#x27;ETF_v1&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;This is an example ETF token v1&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://example.com&#x27;</span>,</span><br><span class="line">    <span class="attr">assets</span>: [</span><br><span class="line">      &#123; <span class="attr">token</span>: token_1_mint, <span class="attr">weight</span>: <span class="number">50</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">token</span>: token_2_mint, <span class="attr">weight</span>: <span class="number">50</span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">createEtfTokenMetadata</span>(etfTokenArgs)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">authority</span>: wallet.<span class="property">publicKey</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/example/index.ts</span></span><br><span class="line"><span class="comment">// 创建 ETF Token</span></span><br><span class="line">  <span class="keyword">const</span> etf_token = <span class="keyword">await</span> <span class="title function_">createETFToken</span>(defaultWallet, usdcDevTokenMint, eurcDevTokenMint);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(etf_token);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20solana%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20solana%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB/" itemprop="url">Solana 合约开发 - 合约安全 Solana重入攻击</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-28T21:52:35+08:00">
                2025-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发 - 合约安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在智能合约中，当一个合约调用另一个合约（或外部程序）时，如果当前合约的状态尚未完全更新，而外部程序又反过来调用当前合约的函数，就可能发生重入攻击。</p>
<ul>
<li><strong>状态未锁定</strong> ：在合约执行逻辑的过程中，账户余额或其他关键状态未及时更新。</li>
<li><strong>外部调用风险</strong> ：攻击者通过恶意合约反复调用目标合约的函数，绕过正常的逻辑检查。</li>
</ul>
<h1 id="Solana重入攻击示例："><a href="#Solana重入攻击示例：" class="headerlink" title="Solana重入攻击示例："></a>Solana重入攻击示例：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">withdraw</span>(accounts: &amp;[AccountInfo]) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = &amp;accounts[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vault</span> = &amp;accounts[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查用户是否有足够的余额</span></span><br><span class="line">    <span class="keyword">if</span> **vault.lamports.<span class="title function_ invoke__">borrow</span>() &lt; <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ProgramError::InsufficientFunds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用外部程序向用户转账</span></span><br><span class="line">    <span class="title function_ invoke__">invoke</span>(</span><br><span class="line">        &amp;<span class="title function_ invoke__">transfer_instruction</span>(user.key, <span class="number">10</span>),</span><br><span class="line">        accounts,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新状态：减少金库余额</span></span><br><span class="line">    **vault.lamports.<span class="title function_ invoke__">borrow_mut</span>() -= <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题:"></a><strong>问题</strong>:</h2><p>在这个逻辑中：</p>
<ol>
<li>合约首先检查金库余额是否足够。</li>
<li>然后调用外部程序向用户转账。</li>
<li>最后更新金库余额。</li>
</ol>
<p> <strong>攻击者的操作</strong><br>攻击者可以创建一个恶意合约，在 <code>invoke</code> 调用外部程序时再次调用 <code>withdraw</code> 函数：</p>
<ol>
<li>攻击者调用 <code>withdraw</code> 函数。</li>
<li>合约检查金库余额（此时余额足够）。</li>
<li>合约调用外部程序（例如转账给用户）。</li>
<li>在外部程序执行期间，恶意合约再次调用 <code>withdraw</code> 函数。</li>
<li>第二次调用时，由于金库余额尚未更新，攻击者可以再次提取资金。</li>
<li>最终，攻击者可能提取远超其应得的资金，相当于N*10。</li>
<li>但金库才更新了一次10，状态不一致。</li>
</ol>
<h1 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">withdraw</span>(accounts: &amp;[AccountInfo]) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = &amp;accounts[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vault</span> = &amp;accounts[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查金库余额是否足够</span></span><br><span class="line">    <span class="keyword">if</span> **vault.lamports.<span class="title function_ invoke__">borrow</span>() &lt; <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ProgramError::InsufficientFunds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新状态：减少金库余额</span></span><br><span class="line">    **vault.lamports.<span class="title function_ invoke__">borrow_mut</span>() -= <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用外部程序向用户转账</span></span><br><span class="line">    <span class="title function_ invoke__">invoke</span>(</span><br><span class="line">        &amp;<span class="title function_ invoke__">transfer_instruction</span>(user.key, <span class="number">10</span>),</span><br><span class="line">        accounts,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a><strong>执行流程</strong></h2><ol>
<li>攻击者调用 <code>withdraw</code> 函数。</li>
<li>合约检查金库余额（此时余额足够）。</li>
<li>合约立即更新金库余额（减少余额）。</li>
<li>合约调用外部程序（例如转账给用户）。</li>
<li>如果攻击者的恶意合约再次调用 <code>withdraw</code>：<ul>
<li>不断进行新的调用会发现金库余额不足，无法继续提取资金。</li>
</ul>
</li>
<li>最终，每次提取资金都会对应一次金库余额的更新。</li>
</ol>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><ol>
<li>第一种情况的根本原因是<strong>状态更新发生在外部调用之后</strong> ，导致攻击者可以利用时间窗口进行多次提取。</li>
<li>第二种情况通过<strong>先更新状态，再调用外部程序</strong> ，确保每次提取都对应一次状态更新，从而避免了漏洞。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20%E5%AE%89%E5%85%A8%E6%95%B0%E5%AD%A6%E8%BF%90%E7%AE%97%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20%E5%AE%89%E5%85%A8%E6%95%B0%E5%AD%A6%E8%BF%90%E7%AE%97%E4%BD%BF%E7%94%A8/" itemprop="url">Solana 合约开发 - 合约安全 安全数学运算使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-28T17:16:57+08:00">
                2025-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发 - 合约安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>整数溢出（Overflow）</strong>和<strong>下溢（Underflow）</strong>是智能合约开发中常见的漏洞，可能导致资金损失、逻辑错误或程序崩溃。</p>
<h1 id="整数溢出-下溢的原理"><a href="#整数溢出-下溢的原理" class="headerlink" title="整数溢出&#x2F;下溢的原理"></a>整数溢出&#x2F;下溢的原理</h1><ol>
<li><p><strong>整数溢出</strong><br>当一个整数值超过其数据类型的最大值时，会发生溢出 。例如：<br>u8 类型的最大值为 255。<br>如果执行 255 + 1，结果会“回绕”到 0。</p>
</li>
<li><p><strong>整数下溢</strong><br>当一个整数值小于其数据类型的最小值时，会发生下溢 。例如：<br>u8 类型的最小值为 0。<br>如果执行 0 - 1，结果会“回绕”到 255。</p>
</li>
<li><p><strong>无符号整数 vs 有符号整数</strong><br>无符号整数（如 u64） ：只能表示非负数，溢出会导致回绕到 0。<br>有符号整数（如 i64） ：可以表示正负数，溢出会导致从正数变为负数，反之亦然。</p>
</li>
</ol>
<h1 id="整数溢出-下溢的危害"><a href="#整数溢出-下溢的危害" class="headerlink" title="整数溢出&#x2F;下溢的危害"></a>整数溢出&#x2F;下溢的危害</h1><ol>
<li><strong>资金损失</strong><br>在金融相关的合约中，溢出&#x2F;下溢可能导致计算错误，进而引发资金丢失。例如：<br>计算余额时发生溢出，用户可能提取超出预期的资金。<br>计算手续费时发生下溢，攻击者可能绕过费用限制。</li>
<li><strong>逻辑错误</strong><br>溢出&#x2F;下溢可能导致程序状态不一致，影响后续操作。例如：<br>循环次数计算错误，导致死循环或未完成的操作。<br>数组索引越界，导致程序崩溃。</li>
<li><strong>拒绝服务攻击</strong><br>攻击者可能利用溢出&#x2F;下溢触发异常，导致合约无法正常运行。</li>
</ol>
<h1 id="如何解决？"><a href="#如何解决？" class="headerlink" title="如何解决？"></a>如何解决？</h1><p>在Anchor框架中使用安全数学运算：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加法操作，a+b=result,如果超出范围则ok_or处理错误</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_add</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 减法操作</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_sub</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 乘法操作</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_mul</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 除法操作</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_div</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="以下数据类型最常需要使用安全数学运算（如-checked-方法）："><a href="#以下数据类型最常需要使用安全数学运算（如-checked-方法）：" class="headerlink" title="以下数据类型最常需要使用安全数学运算（如 checked_* 方法）："></a>以下数据类型最常需要使用安全数学运算（如 checked_* 方法）：</h1><h2 id="无符号整数（u8-u16-u32-u64-u128）-："><a href="#无符号整数（u8-u16-u32-u64-u128）-：" class="headerlink" title="无符号整数（u8, u16, u32, u64, u128） ："></a>无符号整数（u8, u16, u32, u64, u128） ：</h2><ul>
<li>用于表示金额、余额、计数器等非负数值。</li>
<li>风险：溢出导致回绕到 0。</li>
</ul>
<h2 id="有符号整数（i8-i16-i32-i64-i128）-："><a href="#有符号整数（i8-i16-i32-i64-i128）-：" class="headerlink" title="有符号整数（i8, i16, i32, i64, i128） ："></a>有符号整数（i8, i16, i32, i64, i128） ：</h2><ul>
<li>用于表示可能为负数的值。</li>
<li>风险：溢出导致从正数变为负数，反之亦然。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/25/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8pub(crate)%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/25/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8pub(crate)%E4%BD%BF%E7%94%A8/" itemprop="url">Solana 合约开发 - 合约安全 pub(crate) 使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-25T22:45:34+08:00">
                2025-02-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发 - 合约安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="可见性修饰符以及含义："><a href="#可见性修饰符以及含义：" class="headerlink" title="可见性修饰符以及含义："></a>可见性修饰符以及含义：</h1><ol>
<li><code>pub</code>: 对所有 crate 和模块可见（完全公开）。</li>
<li><code>pub(crate)</code>: 仅对当前 crate 内的模块可见，也就是当前合约内可以调用，其他合约不行。</li>
<li><code>pub(super)</code>: 仅对当前模块的父模块可见。</li>
<li><code>pub(in path)</code>: 仅对指定路径内的模块可见（更细粒度的控制）。</li>
</ol>
<p>在 Solana 合约开发中，由于智能合约运行在区块链上，安全性是首要考虑因素。因此，合理使用 pub(crate) 可以有效隐藏内部逻辑，减少暴露给外部的风险。</p>
<h1 id="Pub（crate）使用示例："><a href="#Pub（crate）使用示例：" class="headerlink" title="Pub（crate）使用示例："></a>Pub（crate）使用示例：</h1><h2 id="隐藏内部工具函数："><a href="#隐藏内部工具函数：" class="headerlink" title="隐藏内部工具函数："></a><strong>隐藏内部工具函数</strong>：</h2><p>智能合约通常包含一些辅助函数，用于验证数据、处理逻辑或计算结果。这些函数不需要暴露给外部，但需要在多个模块之间共享。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils.rs</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">validate_account_size</span>(data: &amp;[<span class="type">u8</span>], expected_size: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    data.<span class="title function_ invoke__">len</span>() == expected_size</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">calculate_fee</span>(amount: <span class="type">u64</span>, fee_rate: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    amount * fee_rate / <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="封装内部状态结构体"><a href="#封装内部状态结构体" class="headerlink" title="封装内部状态结构体:"></a>封装内部状态结构体:</h2><p>智能合约通常需要维护一些内部状态（如计数器、余额、配置）。这些状态结构体可能只在合约内部使用，不需要暴露给外部。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/state.rs</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">InternalState</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) counter: <span class="type">u64</span>,</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) balance: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">InternalState</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">increment_counter</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.counter += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">add_balance</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, amount: <span class="type">u64</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.balance += amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="共享常量和配置："><a href="#共享常量和配置：" class="headerlink" title="共享常量和配置："></a>共享常量和配置：</h2><p>智能合约可能需要一些全局常量或配置（如最大允许值、默认费率）。这些常量通常只在合约内部使用，不需要暴露给外部。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">StakePool</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">const</span> SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;stake_pool_v1&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">const</span> LEN: <span class="type">usize</span> = <span class="number">194</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="限制公共接口："><a href="#限制公共接口：" class="headerlink" title="限制公共接口："></a>限制公共接口：</h2><p>Solana 合约的入口点函数（<code>process_instruction</code>）是唯一的公开接口，所有外部调用都必须通过它。其他所有内容都应该是私有的或受限制的。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[program]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> swap &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_token_stake</span>(ctx: Context&lt;LPTokenStake&gt;, index: <span class="type">u16</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        instructions::<span class="title function_ invoke__">lp_token_stake</span>(ctx, index, amount)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// instructions/stake.rs</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">lp_token_stake</span>(ctx: Context&lt;LPTokenStake&gt;, index: <span class="type">u16</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">staker</span> = &amp;ctx.accounts.user;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lp_mint</span> = &amp;ctx.accounts.lp_mint;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stake_pool</span> = ctx.accounts.stake_pool.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line"></span><br><span class="line">    require!(amount &gt; <span class="number">0</span>, ErrorCode::InvalidAmount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><ol>
<li><strong>最小化暴露</strong><br> 只有必要的部分才应该使用 pub 或 pub(crate)。<br> 对于内部逻辑，优先使用 pub(crate) 而不是 pub。</li>
<li><strong>模块化设计</strong><br> 将功能划分为多个模块（如 instructions、state、utils），并通过 pub(crate) 控制模块间的可见性。<br> 避免将所有代码放在一个文件中，保持代码清晰且易于维护。</li>
<li><strong>安全审计</strong><br> 定期审查代码，确保没有意外暴露的接口。<br> 使用工具（如 Clippy）检查未使用的 pub 或 pub(crate)。<br> <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/clippy/usage.html">https://doc.rust-lang.org/clippy/usage.html</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/24/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20Account%20&%20AccountInfo%20&%20InterfaceAccount%20&%20AccountLoader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/24/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20Account%20&%20AccountInfo%20&%20InterfaceAccount%20&%20AccountLoader/" itemprop="url">Solana 合约开发 - Account & AccountInfo & InterfaceAccount & AccountLoader 区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-24T19:51:49+08:00">
                2025-02-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h1><p>在 Solana 中，Account 是一个核心概念，表示区块链上的一个存储单元。每个账户都有一个唯一的地址（公钥），并且可以存储数据、持有 SOL（Solana 的原生代币）以及执行权限控制。</p>
<ul>
<li><p><strong>账户类型</strong> ：Solana 上的账户可以分为几种类型：</p>
<ul>
<li><code>System Account</code> ：由系统程序管理的账户，通常用于存储 SOL。</li>
<li><code>Program Derived Address (PDA)</code> ：由程序派生的地址，用于存储与特定程序相关的数据。</li>
<li><code>Token Account</code> ：用于存储 SPL 代币（Solana 的标准代币协议）。</li>
</ul>
</li>
<li><p><strong>账户结构</strong> ：每个账户包含以下信息：</p>
<ul>
<li>公钥（地址）</li>
<li>数据（可以是任意字节序列）</li>
<li>权限（所有者程序）</li>
<li>SOL 余额</li>
</ul>
</li>
</ul>
<p>在Anchor中，Account 是 Anchor 框架 提供的一个高级抽象，用于简化账户的操作。它封装了账户的数据、权限、所有者程序等信息，并提供了类型安全的访问方式。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> etf_token_info: <span class="type">Box</span>&lt;Account&lt;<span class="symbol">&#x27;info</span>, EtfToken&gt;&gt;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Account</span>&lt;<span class="symbol">&#x27;info</span>, T: AccountSerialize + AccountDeserialize + <span class="built_in">Clone</span>&gt; &#123;</span><br><span class="line">    account: T,</span><br><span class="line">    info: &amp;<span class="symbol">&#x27;info</span> AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于AccountInfo为字节数组，难以修改，Anchor 会自动将 AccountInfo 的字节数组反序列化为 T 类型，并存储在 account 字段中，这样就方便用户进行修改。</p>
<h1 id="AccountInfo"><a href="#AccountInfo" class="headerlink" title="AccountInfo"></a>AccountInfo</h1><p>AccountInfo 是 Solana 运行时提供的原生结构体 ，表示账户的底层元数据。它是 Solana 程序中最基础的账户表示形式，所有操作最终都会涉及 AccountInfo。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Account information</span></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">AccountInfo</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/// Public key of the account</span></span><br><span class="line">    <span class="keyword">pub</span> key: &amp;<span class="symbol">&#x27;a</span> Pubkey,</span><br><span class="line">    <span class="comment">/// The lamports in the account.  Modifiable by programs.</span></span><br><span class="line">    <span class="keyword">pub</span> lamports: Rc&lt;RefCell&lt;&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="type">u64</span>&gt;&gt;,</span><br><span class="line">    <span class="comment">/// The data held in this account.  Modifiable by programs.</span></span><br><span class="line">    <span class="keyword">pub</span> data: Rc&lt;RefCell&lt;&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> [<span class="type">u8</span>]&gt;&gt;,</span><br><span class="line">    <span class="comment">/// Program that owns this account</span></span><br><span class="line">    <span class="keyword">pub</span> owner: &amp;<span class="symbol">&#x27;a</span> Pubkey,</span><br><span class="line">    <span class="comment">/// The epoch at which this account will next owe rent</span></span><br><span class="line">    <span class="keyword">pub</span> rent_epoch: Epoch,</span><br><span class="line">    <span class="comment">/// Was the transaction signed by this account&#x27;s public key?</span></span><br><span class="line">    <span class="keyword">pub</span> is_signer: <span class="type">bool</span>,</span><br><span class="line">    <span class="comment">/// Is the account writable?</span></span><br><span class="line">    <span class="keyword">pub</span> is_writable: <span class="type">bool</span>,</span><br><span class="line">    <span class="comment">/// This account&#x27;s data contains a loaded program (and is now read-only)</span></span><br><span class="line">    <span class="keyword">pub</span> executable: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结构 ：AccountInfo 是一个结构体，包含了以下字段：<ul>
<li><code>key</code>: 账户的公钥（地址）。</li>
<li><code>is_signer</code>: 表示该账户是否是交易的签名者。</li>
<li><code>is_writable</code>: 表示该账户是否可写（即是否可以修改其数据或余额）。</li>
<li><code>lamports</code>: 账户中的 SOL 余额（以 lamports 为单位，1 SOL &#x3D; 10^9 lamports）。</li>
<li><code>data</code>: 账户存储的数据（字节数组）。</li>
<li><code>owner</code>: 账户的所有者程序（即哪个程序有权修改该账户的数据）。</li>
<li><code>用途</code> ：AccountInfo 是 Solana 程序中最基础的账户表示形式，所有的账户操作最终都会涉及到 AccountInfo。开发者可以直接通过 AccountInfo 来访问和修改账户的数据。</li>
</ul>
</li>
</ul>
<h2 id="如何转换-Account-和-AccountInfo？"><a href="#如何转换-Account-和-AccountInfo？" class="headerlink" title="如何转换 Account 和 AccountInfo？"></a>如何转换 Account 和 AccountInfo？</h2><p>在 Anchor 中，<code>Account</code> 实际上是对 <code>AccountInfo</code> 的封装。可以通过以下方式获取底层 <code>AccountInfo</code>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">account_info</span>: &amp;AccountInfo = ctx.accounts.my_account.<span class="title function_ invoke__">to_account_info</span>();</span><br></pre></td></tr></table></figure>

<p>反之，若需将 <code>AccountInfo</code> 转换为 Anchor 的 <code>Account</code>，需手动验证并反序列化数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">account</span>: Account&lt;MyData&gt; = Account::<span class="title function_ invoke__">try_from</span>(&amp;account_info)?;</span><br></pre></td></tr></table></figure>


<h1 id="InterfaceAccount"><a href="#InterfaceAccount" class="headerlink" title="InterfaceAccount"></a>InterfaceAccount</h1><p>InterfaceAccount 是一个接口 ，定义了账户必须实现的方法或属性。它的作用类似于面向对象编程中的接口（如 Java 的 Interface 或 Rust 的 Trait），确保不同账户类型遵循统一的行为规范。</p>
<p>在 Solana 的 Anchor 框架中，InterfaceAccount&lt;’info, TokenAccount&gt; 是一种结合了接口（Interface）和具体账户类型（如 TokenAccount）的泛型结构。它用于在智能合约中约束某个账户必须实现特定的接口（即行为规范），同时关联具体的账户类型（如 SPL Token 账户）。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> etf_token_ata: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">InterfaceAccount</span>&lt;<span class="symbol">&#x27;info</span>, T: AccountSerialize + AccountDeserialize + <span class="built_in">Clone</span>&gt; &#123;</span><br><span class="line">    account: Account&lt;<span class="symbol">&#x27;info</span>, T&gt;,</span><br><span class="line">    <span class="comment">// The owner here is used to make sure that changes aren&#x27;t incorrectly propagated</span></span><br><span class="line">    <span class="comment">// to an account with a modified owner</span></span><br><span class="line">    owner: Pubkey,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-泛型参数"><a href="#1-泛型参数" class="headerlink" title="1. 泛型参数"></a>1. <strong>泛型参数</strong></h4><ul>
<li><strong><code>&#39;info</code></strong> ：生命周期参数，确保账户引用的上下文有效性。</li>
<li><strong><code>T</code></strong> ：泛型类型参数，需满足以下约束：<ul>
<li><code>AccountSerialize</code>：账户数据可序列化。</li>
<li><code>AccountDeserialize</code>：账户数据可反序列化。</li>
<li><code>Clone</code>：允许结构体被克隆。</li>
</ul>
</li>
</ul>
<h4 id="2-字段说明"><a href="#2-字段说明" class="headerlink" title="2. 字段说明"></a>2. <strong>字段说明</strong></h4><ul>
<li><strong><code>account: Account&lt;&#39;info, T&gt;</code></strong><br>  封装具体账户数据的 Anchor 账户类型，包含账户的元数据（如地址、权限、数据等）。</li>
<li><strong><code>owner: Pubkey</code></strong><br>  账户的原始所有者公钥，owner 字段保存账户的初始所有者公钥 。在操作账户前，检查当前账户的所有者是否与 owner 一致，确保操作合法性。防止所有者被篡改后引发的安全问题。</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义代币操作接口</span></span><br><span class="line"><span class="meta">#[interface]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">TokenInterface</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">transfer</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, to: &amp;<span class="keyword">mut</span> <span class="keyword">dyn</span> TokenInterface, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> ProgramResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 SPL Token 账户实现接口</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">TokenInterface</span> <span class="keyword">for</span> <span class="title class_">SplTokenAccount</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">transfer</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, to: &amp;<span class="keyword">mut</span> <span class="keyword">dyn</span> TokenInterface, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">        <span class="comment">// 调用 SPL Token 程序的转账逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在指令上下文中使用 InterfaceAccount</span></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Transfer</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> from: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, SplTokenAccount&gt;,</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> to: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, SplTokenAccount&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行转账</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer</span>(ctx: Context&lt;Transfer&gt;, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    ctx.accounts.from.<span class="title function_ invoke__">transfer</span>(&amp;<span class="keyword">mut</span> ctx.accounts.to, amount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="AccountLoader"><a href="#AccountLoader" class="headerlink" title="AccountLoader"></a>AccountLoader</h1><p>在Solana中，每个账户的数据是以字节数组的形式存储的。当你在智能合约中处理账户数据时，通常需要将这些字节数组反序列化为 Rust 的结构体或其他高级数据结构，以便进行操作。手动处理字节数组不仅繁琐，而且容易出错。</p>
<h2 id="AccountLoader-的主要作用是："><a href="#AccountLoader-的主要作用是：" class="headerlink" title="AccountLoader 的主要作用是："></a>AccountLoader 的主要作用是：</h2><ul>
<li><code>简化数据加载</code> ：自动将账户的字节数组反序列化为 Rust 结构体。</li>
<li><code>提供线程安全的访问 </code>：通过 load() 和 load_mut() 方法，确保对账户数据的读写操作是线程安全的。</li>
<li><code>支持复杂数据结构</code> ：可以轻松处理复杂的嵌套数据结构，而不需要手动解析字节数组。</li>
</ul>
<h2 id="什么是-zero-copy-unsafe"><a href="#什么是-zero-copy-unsafe" class="headerlink" title="什么是(zero_copy(unsafe))"></a>什么是(zero_copy(unsafe))</h2><p><code>#[account(zero_copy(unsafe))]</code> 是 Anchor 提供的一个属性，用于标记一个账户结构体为“零拷贝”（Zero-Copy）模式。这意味着该结构体的数据不会被反序列化到 Rust 的堆内存中，而是直接从账户的字节数组中读取和写入数据。</p>
<ul>
<li><strong><code>零拷贝</code></strong> ：零拷贝是一种优化技术，避免了将数据从字节数组反序列化为 Rust 结构体的过程。相反，程序直接操作原始字节数组中的数据。</li>
<li><strong><code>unsafe</code></strong> ：由于零拷贝模式绕过了 Rust 的安全检查机制（如边界检查），因此它被认为是不安全的。开发者需要确保手动处理数据时不会出现越界访问等问题。</li>
</ul>
<h2 id="为什么要用零拷贝？"><a href="#为什么要用零拷贝？" class="headerlink" title="为什么要用零拷贝？"></a>为什么要用零拷贝？</h2><p>Solana 的账户数据是以字节数组的形式存储的，通常在智能合约中需要将这些字节数组反序列化为 Rust 结构体进行操作。然而，这种反序列化过程会带来以下问题：</p>
<ul>
<li><strong><code>性能开销</code></strong> ：每次加载账户数据时都需要进行反序列化，这会消耗额外的 CPU 时间。</li>
<li>**<code>内存占用</code>**：反序列化后的数据会被复制到堆内存中，增加了内存使用。</li>
<li>通过使用零拷贝模式，可以避免这些开销，因为程序直接操作原始字节数组中的数据，而不需要额外的反序列化和内存分配。</li>
</ul>
<h2 id="什么是repr-packed-？"><a href="#什么是repr-packed-？" class="headerlink" title="什么是repr(packed)？"></a>什么是repr(packed)？</h2><p>#[repr(packed)] 是 Rust 的一个属性，用于指定结构体的内存布局。具体来说，它告诉编译器不要在结构体字段之间插入任何填充字节（padding），从而使得结构体的内存布局更加紧凑。</p>
<ul>
<li><strong><code>默认行为</code></strong> ：Rust 编译器为了提高内存访问效率，通常会在结构体字段之间插入填充字节，以确保字段的对齐（alignment）。例如，u64 类型通常需要 8 字节对齐。</li>
<li><strong><code>packed 属性</code></strong> ：使用 #[repr(packed)] 后，编译器会移除这些填充字节，使得结构体的大小尽可能小。</li>
</ul>
<p>在 Solana 中，账户数据是以字节数组的形式存储的，且每个账户都有固定的大小。为了最大化利用账户空间并减少浪费，通常会希望结构体的内存布局与账户数据的字节数组布局完全一致。</p>
<p>如果不对结构体使用 #[repr(packed)]，编译器可能会插入填充字节，导致结构体的内存布局与账户数据的字节数组布局不匹配，进而引发数据解析错误。</p>
<p>举个例子</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyData</span> &#123;</span><br><span class="line">    value: <span class="type">u64</span>,  <span class="comment">// 8 bytes</span></span><br><span class="line">    flag: <span class="type">bool</span>,  <span class="comment">// 1 byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在默认情况下，Rust 编译器会对 MyData 进行对齐处理。由于 u64 需要 8 字节对齐，编译器会在 flag 后面插入 7 个填充字节，以确保下一个字段（如果有）也能正确对齐。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| u64 (8 bytes) | bool (1 byte) | padding (7 bytes) |</span><br></pre></td></tr></table></figure>
<p>如果我们使用 #[repr(packed)]，编译器将不会插入任何填充字节，结构体的内存布局将是紧凑的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| u64 (8 bytes) | bool (1 byte) |</span><br></pre></td></tr></table></figure>

<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><ul>
<li><strong><code>填充字节的作用</code></strong> ：Rust 编译器默认会在结构体字段之间插入填充字节，以确保字段的对齐要求。这种行为提高了内存访问效率，但可能导致结构体的内存布局与账户数据的字节数组布局不匹配。</li>
<li><strong><code>问题的原因</code></strong> ：如果不对结构体使用 #[repr(packed)]，编译器可能会插入填充字节，导致结构体的内存布局与账户数据的字节数组布局不一致。这会引发数据解析错误，因为程序会错误地读取或写入数据。</li>
<li><strong><code>解决方案</code></strong> ：使用 #[repr(packed)] 来移除填充字节，确保结构体的内存布局与账户数据的字节数组布局一致。这样可以避免数据解析错误，并高效地利用账户空间。</li>
</ul>
<h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><ul>
<li>虽然 #[repr(packed)] 可以解决数据布局不匹配的问题，但它也有一些潜在的风险：<ul>
<li><strong><code>性能下降</code></strong> ：未对齐的内存访问在某些架构上可能会导致性能下降。</li>
<li><strong><code>安全性风险</code></strong> ：未对齐的内存访问在某些架构上可能会导致崩溃或未定义行为。</li>
</ul>
</li>
</ul>
<h2 id="怎么用："><a href="#怎么用：" class="headerlink" title="怎么用："></a>怎么用：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Accounts)]</span> 里面使用：</span><br><span class="line">	<span class="meta">#[account(init, payer = user, space = 8 + 8)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">	<span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line">    </span><br><span class="line">------------------------------</span><br><span class="line">结构体：</span><br><span class="line"><span class="meta">#[account(zero_copy(unsafe))]</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="meta">#[derive(Default, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PoolState</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> pool_creator: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_0_vault: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_1_vault: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_0_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_1_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_0_vault: <span class="type">u64</span>,</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line">------------------------------</span><br><span class="line">方法使用：</span><br><span class="line"><span class="comment">//load(): 返回一个不可变引用，确保数据不会被修改。</span></span><br><span class="line"><span class="comment">//load_mut(): 返回一个可变引用，允许修改数据，但确保同一时间只有一个指令可以修改该数据。</span></span><br><span class="line"><span class="comment">//load_init() 时，会创建一个新的账户并将其反序列化为 PoolState 结构体。</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pool_state</span> =  ctx.accounts.pool_state.<span class="title function_ invoke__">load_init</span>()?;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/23/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20to_owned()%E4%B8%8Eto_clone()%E7%9A%84%E5%AF%B9%E6%AF%94/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/23/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20to_owned()%E4%B8%8Eto_clone()%E7%9A%84%E5%AF%B9%E6%AF%94/" itemprop="url">Solana 合约开发 - to_owned()与to_clone()的对比</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-23T23:12:59+08:00">
                2025-02-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用to-owned-和使用引用对比："><a href="#使用to-owned-和使用引用对比：" class="headerlink" title="使用to_owned()和使用引用对比："></a>使用to_owned()和使用引用对比：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts</span> = ctx</span><br><span class="line">    .remaining_accounts</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))</span><br><span class="line">    .collect::&lt;HashMap&lt;_, _&gt;&gt;();</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong><code>所有权转移</code></strong> ：<br>x.to_owned() 会创建一个 AccountInfo 的深拷贝（即完全独立的副本），并将这个副本存储到 HashMap 中。<br>这意味着 accounts 拥有这些 AccountInfo 的所有权，而不是借用它们。</p>
</li>
<li><p><strong><code>生命周期</code></strong> ：<br>因为 accounts 存储的是深拷贝的数据，它的生命周期与 ctx.remaining_accounts 无关。<br>它可以独立存在，即使 ctx.remaining_accounts 被释放或超出作用域，accounts 仍然有效。</p>
</li>
<li><p><strong><code>内存开销</code></strong> ：<br>由于每个 AccountInfo 都被深拷贝，这会导致额外的内存分配和性能开销。</p>
</li>
<li><p><strong><code>适用场景</code></strong> ：<br>如果你需要在函数外部返回 accounts(例如<code>fn xxx() -&gt; HashMap&lt;Pubkey, AccountInfo&gt;</code>)，或者长时间持有这些数据，这种方法是合适的。<br>但要注意，Solana 程序中通常不建议频繁深拷贝数据，因为这会增加计算和内存开销。</p>
</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts_map</span>: HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;&gt; = ctx</span><br><span class="line">    .remaining_accounts</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|acc| (acc.key, acc))</span><br><span class="line">    .<span class="title function_ invoke__">collect</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong><code>借用而非拥有</code></strong> ：<br>这里没有调用 to_owned()，而是直接借用 ctx.remaining_accounts 中的 AccountInfo 引用。<br>accounts_map 中存储的是对 ctx.remaining_accounts 中元素的引用（&amp;AccountInfo&lt;’info&gt;），而不是独立的副本。</p>
</li>
<li><p><strong><code>生命周期绑定</code></strong> ：<br>accounts_map 的生命周期与 ctx.remaining_accounts 绑定。<br>如果 ctx.remaining_accounts 被释放或超出作用域，accounts_map 中的引用也会失效。<br>这是因为 accounts_map 中的引用依赖于 ctx.remaining_accounts 的生命周期。</p>
</li>
<li><p><strong><code>内存开销</code></strong> ：<br>由于只是存储引用，不会产生额外的内存分配，性能更高。</p>
</li>
<li><p><strong><code>适用场景</code></strong> ：<br>如果你只需要在当前函数的作用域内使用 accounts_map，并且不需要长期持有这些数据，这种方法更高效。<br>这是 Solana 程序中推荐的方式，因为它避免了不必要的深拷贝。</p>
</li>
</ul>
<h1 id="使用to-owned-和clone-对比："><a href="#使用to-owned-和clone-对比：" class="headerlink" title="使用to_owned()和clone()对比："></a>使用to_owned()和clone()对比：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">pool_input_vault_info</span> = accounts   <span class="comment">//HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;&#x27;info&gt;&gt;</span></span><br><span class="line">	.<span class="title function_ invoke__">get</span>(&amp;pool_input_vault_key) <span class="comment">//Option&lt;&amp;&amp;AccountInfo&lt;&#x27;info&gt;&gt;</span></span><br><span class="line">    .<span class="title function_ invoke__">ok_or</span>(ErrorCode::InvalidAccounts)? <span class="comment">// &amp;&amp;AccountInfo</span></span><br><span class="line">    .<span class="title function_ invoke__">to_owned</span>(); <span class="comment">// &amp;AccountInfo</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>**<code>定义</code>**：to_owned() 是一个特定于某些类型的方法，通常用于将借用的数据（如引用）转换为拥有所有权的数据。</p>
</li>
<li><p>**<code>行为</code>**：<br><code>to_owned()</code> 通常用于从借用类型（如 &amp;str 或 &amp;AccountInfo）创建拥有所有权的类型（如 String 或 AccountInfo）。<br>它不会递归地复制所有子对象，而是根据具体类型的行为来决定如何复制数据。<br>对于字符串切片 &amp;str，to_owned() 返回一个 String；对于 &amp;AccountInfo，它返回一个 AccountInfo。</p>
</li>
<li><p>**<code>适用场景</code>**：<br>当你有一个借用的数据（如引用），并且你需要拥有该数据的所有权时。<br>当你需要避免双重引用的问题，或者当你需要确保后续代码可以安全地使用该数据时。</p>
</li>
<li><p>**<code>性能考虑</code>**：<br>to_owned() 通常比 clone() 更高效，因为它只复制必要的部分，而不是递归地复制整个对象树。<br>对于简单的类型（如字符串或基本数据结构），to_owned() 的性能开销较小。</p>
</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">pool_input_vault_info</span> = accounts</span><br><span class="line">    .<span class="title function_ invoke__">get</span>(&amp;pool_input_vault_key)</span><br><span class="line">    .<span class="title function_ invoke__">ok_or</span>(ErrorCode::InvalidAccounts)?</span><br><span class="line">    .<span class="title function_ invoke__">clone</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><p>**<code>定义</code>**：clone() 是一个 trait 方法，属于 Clone trait。它用于创建一个类型的新实例，该实例是原始实例的深度副本。</p>
</li>
<li><p>**<code>行为</code>**：<br>clone() 会递归地复制整个对象及其所有子对象。<br>对于实现了 Clone trait 的类型，clone() 可以用于任何类型的对象，包括复杂的数据结构（如 Vec<T>、HashMap&lt;K, V&gt; 等）。<br>如果类型中的字段也实现了 Clone，则这些字段也会被递归复制。</p>
</li>
<li><p>**<code>适用场景</code>**：<br>当你需要完全复制一个复杂的对象，并且不希望两个对象共享任何内部数据时。<br>当你需要确保两个变量拥有独立的状态时。</p>
</li>
<li><p>**<code>性能考虑</code>**：<br>clone() 可能会导致较高的性能开销，因为它需要递归地复制所有子对象。对于大型或复杂的数据结构，这可能会导致显著的性能下降。</p>
</li>
</ul>
<p>在上面两段代码中<br>to_owned()：<br>适用于你只需要将引用转换为拥有所有权的对象，而不需要递归复制整个对象树的情况。<br>在代码中，accounts 是一个 HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;’info&gt;&gt;，因此 to_owned() 可以将 &amp;&amp;AccountInfo&lt;’info&gt; 转换为 &amp;AccountInfo&lt;’info&gt;，从而避免双重引用问题。</p>
<h2 id="双重引用问题："><a href="#双重引用问题：" class="headerlink" title="双重引用问题："></a>双重引用问题：</h2><p>在 Rust 中，双重引用（double reference）是指你有一个指向另一个引用的引用。例如，&amp;AccountInfo&lt;’info&gt; 是一个对 AccountInfo&lt;’info&gt; 的引用。</p>
<h3 id="双重引用问题的背景"><a href="#双重引用问题的背景" class="headerlink" title="双重引用问题的背景"></a>双重引用问题的背景</h3><p>在之前的代码中，accounts 是一个 HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;’info&gt;&gt;，即键是 Pubkey 的引用，值是 AccountInfo&lt;’info&gt; 的引用。当你从 accounts 中获取某个账户信息时，返回的是 Option&lt;&amp;&amp;AccountInfo&lt;’info&gt;&gt;，即对 AccountInfo&lt;’info&gt; 的引用的引用。</p>
<p>如果你直接在这个引用上使用 .clone()，它只会复制这个引用，而不是内部的 AccountInfo&lt;’info&gt; 对象。这会导致双重引用的问题，即你最终会得到的还是 &amp;&amp;AccountInfo&lt;’info&gt;，而不是你期望的 &amp;AccountInfo&lt;’info&gt;。</p>
<h2 id="如何避免双重引用问题"><a href="#如何避免双重引用问题" class="headerlink" title="如何避免双重引用问题"></a>如何避免双重引用问题</h2><p>为了避免双重引用问题，你可以使用以下几种方法：</p>
<ul>
<li><p>**<code>使用 .to_owned()</code>**：<br><code>.to_owned()</code> 用于将借用的数据转换为拥有所有权的数据。对于 &amp;AccountInfo&lt;’info&gt;，它会创建一个新的 AccountInfo&lt;’info&gt; 实例，从而避免了双重引用问题。</p>
</li>
<li><p>**<code>解引用并克隆</code>**：<br>你可以先解引用，然后克隆内部的数据。例如，<code>*accounts.get(&amp;key).ok_or(ErrorCode::InvalidAccounts).clone()?</code>，但这通常不如 .to_owned() 简洁和高效。</p>
</li>
<li><p>**<code>直接解引用</code>**：<br>如果你只需要读取数据而不需要修改或复制整个对象，可以直接解引用并使用该数据。例如，<code>*accounts.get(&amp;key).ok_or(ErrorCode::InvalidAccounts)?</code>。</p>
</li>
</ul>
<h2 id="为什么to-owned-更高效？"><a href="#为什么to-owned-更高效？" class="headerlink" title="为什么to_owned()更高效？"></a>为什么to_owned()更高效？</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个包含 Borrowed 数据的 OuterData</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">original</span> = OuterData &#123;</span><br><span class="line">    name: <span class="string">&quot;outer&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    inner: InnerData &#123;</span><br><span class="line">        value: Cow::<span class="title function_ invoke__">Borrowed</span>(<span class="string">&quot;hello&quot;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">此时内存布局：</span><br><span class="line">original.name → <span class="string">&quot;outer&quot;</span> (堆内存)</span><br><span class="line">original.inner.value → <span class="string">&quot;hello&quot;</span> (静态内存，Borrowed)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用<code>clone()</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">cloned</span> = original.<span class="title function_ invoke__">clone</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>clone()</code> 会递归克隆所有字段：<ul>
<li>name: String：深拷贝堆内存中的字符串（分配新堆内存）。</li>
<li>inner: InnerData：调用 InnerData 的 clone()：</li>
<li>value: Cow::Borrowed(“hello”) → 仍然指向原始静态内存。</li>
</ul>
</li>
</ul>
</li>
<li><p>使用<code>to_owned()</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">owned</span> = original.<span class="title function_ invoke__">to_owned</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>to_owned()</code> 会按需复制 ：<ul>
<li>name: String：已经是拥有所有权的类型，直接转移所有权（原堆内存，无需复制）。</li>
<li>inner.value: Cow::Borrowed → 转换为 Cow::Owned，复制数据到堆内存。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>总结：<br><code>clone()</code> 是“傻瓜式”深拷贝 ：不管数据是否已拥有，都会递归复制。<br><code>to_owned()</code> 是“智能”所有权转换 ：仅复制必要的借用数据，最大化复用已有资源。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="qsunou@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QsunOu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
