<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Learning about Rust&amp;Solana">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Learning about Rust&amp;Solana">
<meta property="og:locale">
<meta property="article:author" content="QsunOu">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 7.3.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%E4%BA%8C%EF%BC%9AETF%20%E5%88%9B%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%E4%BA%8C%EF%BC%9AETF%20%E5%88%9B%E5%BB%BA/" itemprop="url">Solana 合约开发 - DeFi - Dex 开发十二：ETF 创建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-28T22:22:19+08:00">
                2025-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-DeFi-Dex/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发-DeFi-Dex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是ETF"><a href="#什么是ETF" class="headerlink" title="什么是ETF?"></a>什么是ETF?</h1><p>交易型开放式指数基金（ETF） 是一种将多个资产打包成一个投资组合的金融工具，投资者可以通过交易所像股票一样买卖 ETF 份额。ETF 常常追踪某一特定市场指数（如 S&amp;P 500）或者行业、商品、债券等多元化资产。通过 ETF，投资者能够低成本地获得广泛的市场暴露，通常用于长期投资和资产配置。</p>
<h1 id="什么是DeFi-ETF？"><a href="#什么是DeFi-ETF？" class="headerlink" title="什么是DeFi ETF？"></a>什么是DeFi ETF？</h1><p>很简单，跟ETF的区别在于由智能合约进行管理，ETF包含的资产从股票等变成了各种Token，流动性也依赖于AMM，交易透明，全天24小时开放。</p>
<h1 id="合约代码："><a href="#合约代码：" class="headerlink" title="合约代码："></a>合约代码：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/programs/swap/src/states/etf.rs</span></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ETF代币</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="meta">#[derive(InitSpace)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> etf_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> creator: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> create_time: <span class="type">i64</span>,</span><br><span class="line">    <span class="meta">#[max_len(50)]</span></span><br><span class="line">    <span class="keyword">pub</span> description: <span class="type">String</span>,</span><br><span class="line">    <span class="meta">#[max_len(10)]</span></span><br><span class="line">    <span class="keyword">pub</span> assets: <span class="type">Vec</span>&lt;EtfAsset&gt;,  <span class="comment">//其实创建ETF跟创建普通token差不多，区别在于这里用Vec包含多个token的Mint地址。</span></span><br><span class="line">    <span class="keyword">pub</span> status: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfToken</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> ETFTOKEN_SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;etf_token_v1&quot;</span>;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> ETFTOKEN_DECIMALS: <span class="type">u8</span> = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> ETFTOKEN_METADATA_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;metadata&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ETF代币总资产信息,作为结构体传入，用于创建ETF代币</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfTokenArgs</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> name: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> symbol: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> description: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> url: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> assets: <span class="type">Vec</span>&lt;EtfAsset&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EtfTokenArgs</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_account</span>(<span class="keyword">self</span>, creator: Pubkey, etf_mint: Pubkey) <span class="punctuation">-&gt;</span> EtfToken &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">clock</span> = Clock::<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">status</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        EtfToken &#123;</span><br><span class="line">            creator,</span><br><span class="line">            etf_mint,</span><br><span class="line">            description: <span class="keyword">self</span>.description,</span><br><span class="line">            assets: <span class="keyword">self</span>.assets,</span><br><span class="line">            create_time: clock.unix_timestamp,</span><br><span class="line">            status,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ETF代币子资产信息</span></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="meta">#[derive(InitSpace)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfAsset</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> token: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> weight: <span class="type">u16</span>,  <span class="comment">// 每种子资产token占ETF的比例</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/programs/swap/src/accounts_all/etf.rs</span></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::associated_token::AssociatedToken;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::metadata::Metadata;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::Token;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_2022::Token2022;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::&#123;Mint,  TokenAccount, TokenInterface&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::&#123;EtfToken, BuyerOrderInfo,  EtfTokenArgs,AmmConfig&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="meta">#[instruction(args: EtfTokenArgs)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">EtfTokenCreate</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于存储etf token的信息</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = authority,</span></span><br><span class="line"><span class="meta">        space = 8 + EtfToken::INIT_SPACE,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            EtfToken::ETFTOKEN_SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            etf_token_mint_account.key().as_ref(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> etf_token_info: <span class="type">Box</span>&lt;Account&lt;<span class="symbol">&#x27;info</span>, EtfToken&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: Validate address by deriving pda</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            EtfToken::ETFTOKEN_METADATA_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            token_metadata_program.key().as_ref(),</span></span><br><span class="line"><span class="meta">            etf_token_mint_account.key().as_ref()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">        seeds::program = token_metadata_program.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> etf_metadata_account: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ETF token mint</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        payer = authority,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            EtfToken::ETFTOKEN_SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            args.symbol.as_bytes(), // symbol不允许重复</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">        mint::decimals = EtfToken::ETFTOKEN_DECIMALS,</span><br><span class="line">        mint::authority = etf_token_info.<span class="title function_ invoke__">key</span>(), </span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> etf_token_mint_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> authority: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> token_metadata_program: Program&lt;<span class="symbol">&#x27;info</span>, Metadata&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program_2022: Program&lt;<span class="symbol">&#x27;info</span>, Token2022&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="keyword">pub</span> rent: Sysvar&lt;<span class="symbol">&#x27;info</span>, Rent&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::TokenAccount;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    associated_token::get_associated_token_address,</span><br><span class="line">    metadata::&#123;</span><br><span class="line">        create_metadata_accounts_v3, mpl_token_metadata::types::DataV2, CreateMetadataAccountsV3,</span><br><span class="line">    &#125;,</span><br><span class="line">    token::&#123;burn, mint_to, transfer, Burn, MintTo, Transfer&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::accounts_all::*;</span><br><span class="line"><span class="keyword">use</span> crate::calculate::*;</span><br><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> crate::states::*;</span><br><span class="line"><span class="keyword">use</span> crate::util::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ETF创建</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_etf_token_metadata</span>(ctx: Context&lt;EtfTokenCreate&gt;, args: EtfTokenArgs) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">etf_token_mint_key</span> = ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        EtfToken::ETFTOKEN_SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">        etf_token_mint_key.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        &amp;[ctx.bumps.etf_token_info],</span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">create_metadata_accounts_v3</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            ctx.accounts.etf_metadata_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            CreateMetadataAccountsV3 &#123;</span><br><span class="line">                metadata: ctx.accounts.etf_metadata_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                mint: ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                mint_authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                update_authority: ctx.accounts.etf_token_info.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                payer: ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                system_program: ctx.accounts.system_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                rent: ctx.accounts.rent.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        DataV2 &#123;</span><br><span class="line">            name: args.name.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            symbol: args.symbol.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            uri: args.url.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            seller_fee_basis_points: <span class="number">0</span>,</span><br><span class="line">            creators: <span class="literal">None</span>,</span><br><span class="line">            collection: <span class="literal">None</span>,</span><br><span class="line">            uses: <span class="literal">None</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="literal">true</span>,</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    ctx.accounts.etf_token_info.<span class="title function_ invoke__">set_inner</span>(args.<span class="title function_ invoke__">create_account</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        ctx.accounts.etf_token_mint_account.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_etf_token_metadata</span>(</span><br><span class="line">        ctx: Context&lt;EtfTokenCreate&gt;,</span><br><span class="line">        args: EtfTokenArgs,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        instructions::<span class="title function_ invoke__">create_etf_token_metadata</span>(ctx, args)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="前端测试代码："><a href="#前端测试代码：" class="headerlink" title="前端测试代码："></a>前端测试代码：</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/example/api/etf.ts</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&#x27;./wallet&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createETFToken</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token_1_mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token_2_mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> etfTokenArgs = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;ETF_v1&#x27;</span>,</span><br><span class="line">    <span class="attr">symbol</span>: <span class="string">&#x27;ETF_v1&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;This is an example ETF token v1&#x27;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://example.com&#x27;</span>,</span><br><span class="line">    <span class="attr">assets</span>: [</span><br><span class="line">      &#123; <span class="attr">token</span>: token_1_mint, <span class="attr">weight</span>: <span class="number">50</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">token</span>: token_2_mint, <span class="attr">weight</span>: <span class="number">50</span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">createEtfTokenMetadata</span>(etfTokenArgs)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">authority</span>: wallet.<span class="property">publicKey</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// anchor/example/index.ts</span></span><br><span class="line"><span class="comment">// 创建 ETF Token</span></span><br><span class="line">  <span class="keyword">const</span> etf_token = <span class="keyword">await</span> <span class="title function_">createETFToken</span>(defaultWallet, usdcDevTokenMint, eurcDevTokenMint);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(etf_token);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20solana%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20solana%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB/" itemprop="url">Solana 合约开发 - 合约安全 Solana重入攻击</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-28T21:52:35+08:00">
                2025-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在智能合约中，当一个合约调用另一个合约（或外部程序）时，如果当前合约的状态尚未完全更新，而外部程序又反过来调用当前合约的函数，就可能发生重入攻击。</p>
<ul>
<li><strong>状态未锁定</strong> ：在合约执行逻辑的过程中，账户余额或其他关键状态未及时更新。</li>
<li><strong>外部调用风险</strong> ：攻击者通过恶意合约反复调用目标合约的函数，绕过正常的逻辑检查。</li>
</ul>
<h1 id="Solana重入攻击示例："><a href="#Solana重入攻击示例：" class="headerlink" title="Solana重入攻击示例："></a>Solana重入攻击示例：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">withdraw</span>(accounts: &amp;[AccountInfo]) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = &amp;accounts[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vault</span> = &amp;accounts[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查用户是否有足够的余额</span></span><br><span class="line">    <span class="keyword">if</span> **vault.lamports.<span class="title function_ invoke__">borrow</span>() &lt; <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ProgramError::InsufficientFunds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用外部程序向用户转账</span></span><br><span class="line">    <span class="title function_ invoke__">invoke</span>(</span><br><span class="line">        &amp;<span class="title function_ invoke__">transfer_instruction</span>(user.key, <span class="number">10</span>),</span><br><span class="line">        accounts,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新状态：减少金库余额</span></span><br><span class="line">    **vault.lamports.<span class="title function_ invoke__">borrow_mut</span>() -= <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题:"></a><strong>问题</strong>:</h2><p>在这个逻辑中：</p>
<ol>
<li>合约首先检查金库余额是否足够。</li>
<li>然后调用外部程序向用户转账。</li>
<li>最后更新金库余额。</li>
</ol>
<p> <strong>攻击者的操作</strong><br>攻击者可以创建一个恶意合约，在 <code>invoke</code> 调用外部程序时再次调用 <code>withdraw</code> 函数：</p>
<ol>
<li>攻击者调用 <code>withdraw</code> 函数。</li>
<li>合约检查金库余额（此时余额足够）。</li>
<li>合约调用外部程序（例如转账给用户）。</li>
<li>在外部程序执行期间，恶意合约再次调用 <code>withdraw</code> 函数。</li>
<li>第二次调用时，由于金库余额尚未更新，攻击者可以再次提取资金。</li>
<li>最终，攻击者可能提取远超其应得的资金，相当于N*10。</li>
<li>但金库才更新了一次10，状态不一致。</li>
</ol>
<h1 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">withdraw</span>(accounts: &amp;[AccountInfo]) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = &amp;accounts[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vault</span> = &amp;accounts[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查金库余额是否足够</span></span><br><span class="line">    <span class="keyword">if</span> **vault.lamports.<span class="title function_ invoke__">borrow</span>() &lt; <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ProgramError::InsufficientFunds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新状态：减少金库余额</span></span><br><span class="line">    **vault.lamports.<span class="title function_ invoke__">borrow_mut</span>() -= <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用外部程序向用户转账</span></span><br><span class="line">    <span class="title function_ invoke__">invoke</span>(</span><br><span class="line">        &amp;<span class="title function_ invoke__">transfer_instruction</span>(user.key, <span class="number">10</span>),</span><br><span class="line">        accounts,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a><strong>执行流程</strong></h2><ol>
<li>攻击者调用 <code>withdraw</code> 函数。</li>
<li>合约检查金库余额（此时余额足够）。</li>
<li>合约立即更新金库余额（减少余额）。</li>
<li>合约调用外部程序（例如转账给用户）。</li>
<li>如果攻击者的恶意合约再次调用 <code>withdraw</code>：<ul>
<li>不断进行新的调用会发现金库余额不足，无法继续提取资金。</li>
</ul>
</li>
<li>最终，每次提取资金都会对应一次金库余额的更新。</li>
</ol>
<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><ol>
<li>第一种情况的根本原因是<strong>状态更新发生在外部调用之后</strong> ，导致攻击者可以利用时间窗口进行多次提取。</li>
<li>第二种情况通过<strong>先更新状态，再调用外部程序</strong> ，确保每次提取都对应一次状态更新，从而避免了漏洞。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20%E5%AE%89%E5%85%A8%E6%95%B0%E5%AD%A6%E8%BF%90%E7%AE%97%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/28/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8%20%E5%AE%89%E5%85%A8%E6%95%B0%E5%AD%A6%E8%BF%90%E7%AE%97%E4%BD%BF%E7%94%A8/" itemprop="url">Solana 合约开发 - 合约安全 安全数学运算使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-28T17:16:57+08:00">
                2025-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>整数溢出（Overflow）</strong>和<strong>下溢（Underflow）</strong>是智能合约开发中常见的漏洞，可能导致资金损失、逻辑错误或程序崩溃。</p>
<h1 id="整数溢出-下溢的原理"><a href="#整数溢出-下溢的原理" class="headerlink" title="整数溢出&#x2F;下溢的原理"></a>整数溢出&#x2F;下溢的原理</h1><ol>
<li><p><strong>整数溢出</strong><br>当一个整数值超过其数据类型的最大值时，会发生溢出 。例如：<br>u8 类型的最大值为 255。<br>如果执行 255 + 1，结果会“回绕”到 0。</p>
</li>
<li><p><strong>整数下溢</strong><br>当一个整数值小于其数据类型的最小值时，会发生下溢 。例如：<br>u8 类型的最小值为 0。<br>如果执行 0 - 1，结果会“回绕”到 255。</p>
</li>
<li><p><strong>无符号整数 vs 有符号整数</strong><br>无符号整数（如 u64） ：只能表示非负数，溢出会导致回绕到 0。<br>有符号整数（如 i64） ：可以表示正负数，溢出会导致从正数变为负数，反之亦然。</p>
</li>
</ol>
<h1 id="整数溢出-下溢的危害"><a href="#整数溢出-下溢的危害" class="headerlink" title="整数溢出&#x2F;下溢的危害"></a>整数溢出&#x2F;下溢的危害</h1><ol>
<li><strong>资金损失</strong><br>在金融相关的合约中，溢出&#x2F;下溢可能导致计算错误，进而引发资金丢失。例如：<br>计算余额时发生溢出，用户可能提取超出预期的资金。<br>计算手续费时发生下溢，攻击者可能绕过费用限制。</li>
<li><strong>逻辑错误</strong><br>溢出&#x2F;下溢可能导致程序状态不一致，影响后续操作。例如：<br>循环次数计算错误，导致死循环或未完成的操作。<br>数组索引越界，导致程序崩溃。</li>
<li><strong>拒绝服务攻击</strong><br>攻击者可能利用溢出&#x2F;下溢触发异常，导致合约无法正常运行。</li>
</ol>
<h1 id="如何解决？"><a href="#如何解决？" class="headerlink" title="如何解决？"></a>如何解决？</h1><p>在Anchor框架中使用安全数学运算：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加法操作，a+b=result,如果超出范围则ok_or处理错误</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_add</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 减法操作</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_sub</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 乘法操作</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_mul</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 除法操作</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = a.<span class="title function_ invoke__">checked_div</span>(b).<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidInstructionData)?;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="以下数据类型最常需要使用安全数学运算（如-checked-方法）："><a href="#以下数据类型最常需要使用安全数学运算（如-checked-方法）：" class="headerlink" title="以下数据类型最常需要使用安全数学运算（如 checked_* 方法）："></a>以下数据类型最常需要使用安全数学运算（如 checked_* 方法）：</h1><h2 id="无符号整数（u8-u16-u32-u64-u128）-："><a href="#无符号整数（u8-u16-u32-u64-u128）-：" class="headerlink" title="无符号整数（u8, u16, u32, u64, u128） ："></a>无符号整数（u8, u16, u32, u64, u128） ：</h2><ul>
<li>用于表示金额、余额、计数器等非负数值。</li>
<li>风险：溢出导致回绕到 0。</li>
</ul>
<h2 id="有符号整数（i8-i16-i32-i64-i128）-："><a href="#有符号整数（i8-i16-i32-i64-i128）-：" class="headerlink" title="有符号整数（i8, i16, i32, i64, i128） ："></a>有符号整数（i8, i16, i32, i64, i128） ：</h2><ul>
<li>用于表示可能为负数的值。</li>
<li>风险：溢出导致从正数变为负数，反之亦然。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/25/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8pub(crate)%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/25/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8pub(crate)%E4%BD%BF%E7%94%A8/" itemprop="url">Solana 合约开发 - 合约安全 pub(crate) 使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-25T22:45:34+08:00">
                2025-02-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="可见性修饰符以及含义："><a href="#可见性修饰符以及含义：" class="headerlink" title="可见性修饰符以及含义："></a>可见性修饰符以及含义：</h1><ol>
<li><code>pub</code>: 对所有 crate 和模块可见（完全公开）。</li>
<li><code>pub(crate)</code>: 仅对当前 crate 内的模块可见，也就是当前合约内可以调用，其他合约不行。</li>
<li><code>pub(super)</code>: 仅对当前模块的父模块可见。</li>
<li><code>pub(in path)</code>: 仅对指定路径内的模块可见（更细粒度的控制）。</li>
</ol>
<p>在 Solana 合约开发中，由于智能合约运行在区块链上，安全性是首要考虑因素。因此，合理使用 pub(crate) 可以有效隐藏内部逻辑，减少暴露给外部的风险。</p>
<h1 id="Pub（crate）使用示例："><a href="#Pub（crate）使用示例：" class="headerlink" title="Pub（crate）使用示例："></a>Pub（crate）使用示例：</h1><h2 id="隐藏内部工具函数："><a href="#隐藏内部工具函数：" class="headerlink" title="隐藏内部工具函数："></a><strong>隐藏内部工具函数</strong>：</h2><p>智能合约通常包含一些辅助函数，用于验证数据、处理逻辑或计算结果。这些函数不需要暴露给外部，但需要在多个模块之间共享。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils.rs</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">validate_account_size</span>(data: &amp;[<span class="type">u8</span>], expected_size: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    data.<span class="title function_ invoke__">len</span>() == expected_size</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">calculate_fee</span>(amount: <span class="type">u64</span>, fee_rate: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    amount * fee_rate / <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="封装内部状态结构体"><a href="#封装内部状态结构体" class="headerlink" title="封装内部状态结构体:"></a>封装内部状态结构体:</h2><p>智能合约通常需要维护一些内部状态（如计数器、余额、配置）。这些状态结构体可能只在合约内部使用，不需要暴露给外部。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/state.rs</span></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">struct</span> <span class="title class_">InternalState</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) counter: <span class="type">u64</span>,</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) balance: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">InternalState</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">increment_counter</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.counter += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">add_balance</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, amount: <span class="type">u64</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.balance += amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="共享常量和配置："><a href="#共享常量和配置：" class="headerlink" title="共享常量和配置："></a>共享常量和配置：</h2><p>智能合约可能需要一些全局常量或配置（如最大允许值、默认费率）。这些常量通常只在合约内部使用，不需要暴露给外部。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">StakePool</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">const</span> SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;stake_pool_v1&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">const</span> LEN: <span class="type">usize</span> = <span class="number">194</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="限制公共接口："><a href="#限制公共接口：" class="headerlink" title="限制公共接口："></a>限制公共接口：</h2><p>Solana 合约的入口点函数（<code>process_instruction</code>）是唯一的公开接口，所有外部调用都必须通过它。其他所有内容都应该是私有的或受限制的。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[program]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> swap &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_token_stake</span>(ctx: Context&lt;LPTokenStake&gt;, index: <span class="type">u16</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        instructions::<span class="title function_ invoke__">lp_token_stake</span>(ctx, index, amount)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// instructions/stake.rs</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">lp_token_stake</span>(ctx: Context&lt;LPTokenStake&gt;, index: <span class="type">u16</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">staker</span> = &amp;ctx.accounts.user;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lp_mint</span> = &amp;ctx.accounts.lp_mint;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stake_pool</span> = ctx.accounts.stake_pool.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line"></span><br><span class="line">    require!(amount &gt; <span class="number">0</span>, ErrorCode::InvalidAmount);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><ol>
<li><strong>最小化暴露</strong><br> 只有必要的部分才应该使用 pub 或 pub(crate)。<br> 对于内部逻辑，优先使用 pub(crate) 而不是 pub。</li>
<li><strong>模块化设计</strong><br> 将功能划分为多个模块（如 instructions、state、utils），并通过 pub(crate) 控制模块间的可见性。<br> 避免将所有代码放在一个文件中，保持代码清晰且易于维护。</li>
<li><strong>安全审计</strong><br> 定期审查代码，确保没有意外暴露的接口。<br> 使用工具（如 Clippy）检查未使用的 pub 或 pub(crate)。<br> <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/clippy/usage.html">https://doc.rust-lang.org/clippy/usage.html</a></li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/24/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20Account%20&%20AccountInfo%20&%20InterfaceAccount%20&%20AccountLoader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/24/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20Account%20&%20AccountInfo%20&%20InterfaceAccount%20&%20AccountLoader/" itemprop="url">Solana 合约开发 - Account & AccountInfo & InterfaceAccount & AccountLoader 区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-24T19:51:49+08:00">
                2025-02-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Account"><a href="#Account" class="headerlink" title="Account"></a>Account</h1><p>在 Solana 中，Account 是一个核心概念，表示区块链上的一个存储单元。每个账户都有一个唯一的地址（公钥），并且可以存储数据、持有 SOL（Solana 的原生代币）以及执行权限控制。</p>
<ul>
<li><p><strong>账户类型</strong> ：Solana 上的账户可以分为几种类型：</p>
<ul>
<li><code>System Account</code> ：由系统程序管理的账户，通常用于存储 SOL。</li>
<li><code>Program Derived Address (PDA)</code> ：由程序派生的地址，用于存储与特定程序相关的数据。</li>
<li><code>Token Account</code> ：用于存储 SPL 代币（Solana 的标准代币协议）。</li>
</ul>
</li>
<li><p><strong>账户结构</strong> ：每个账户包含以下信息：</p>
<ul>
<li>公钥（地址）</li>
<li>数据（可以是任意字节序列）</li>
<li>权限（所有者程序）</li>
<li>SOL 余额</li>
</ul>
</li>
</ul>
<p>在Anchor中，Account 是 Anchor 框架 提供的一个高级抽象，用于简化账户的操作。它封装了账户的数据、权限、所有者程序等信息，并提供了类型安全的访问方式。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> etf_token_info: <span class="type">Box</span>&lt;Account&lt;<span class="symbol">&#x27;info</span>, EtfToken&gt;&gt;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Account</span>&lt;<span class="symbol">&#x27;info</span>, T: AccountSerialize + AccountDeserialize + <span class="built_in">Clone</span>&gt; &#123;</span><br><span class="line">    account: T,</span><br><span class="line">    info: &amp;<span class="symbol">&#x27;info</span> AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于AccountInfo为字节数组，难以修改，Anchor 会自动将 AccountInfo 的字节数组反序列化为 T 类型，并存储在 account 字段中，这样就方便用户进行修改。</p>
<h1 id="AccountInfo"><a href="#AccountInfo" class="headerlink" title="AccountInfo"></a>AccountInfo</h1><p>AccountInfo 是 Solana 运行时提供的原生结构体 ，表示账户的底层元数据。它是 Solana 程序中最基础的账户表示形式，所有操作最终都会涉及 AccountInfo。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Account information</span></span><br><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">AccountInfo</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/// Public key of the account</span></span><br><span class="line">    <span class="keyword">pub</span> key: &amp;<span class="symbol">&#x27;a</span> Pubkey,</span><br><span class="line">    <span class="comment">/// The lamports in the account.  Modifiable by programs.</span></span><br><span class="line">    <span class="keyword">pub</span> lamports: Rc&lt;RefCell&lt;&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="type">u64</span>&gt;&gt;,</span><br><span class="line">    <span class="comment">/// The data held in this account.  Modifiable by programs.</span></span><br><span class="line">    <span class="keyword">pub</span> data: Rc&lt;RefCell&lt;&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> [<span class="type">u8</span>]&gt;&gt;,</span><br><span class="line">    <span class="comment">/// Program that owns this account</span></span><br><span class="line">    <span class="keyword">pub</span> owner: &amp;<span class="symbol">&#x27;a</span> Pubkey,</span><br><span class="line">    <span class="comment">/// The epoch at which this account will next owe rent</span></span><br><span class="line">    <span class="keyword">pub</span> rent_epoch: Epoch,</span><br><span class="line">    <span class="comment">/// Was the transaction signed by this account&#x27;s public key?</span></span><br><span class="line">    <span class="keyword">pub</span> is_signer: <span class="type">bool</span>,</span><br><span class="line">    <span class="comment">/// Is the account writable?</span></span><br><span class="line">    <span class="keyword">pub</span> is_writable: <span class="type">bool</span>,</span><br><span class="line">    <span class="comment">/// This account&#x27;s data contains a loaded program (and is now read-only)</span></span><br><span class="line">    <span class="keyword">pub</span> executable: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结构 ：AccountInfo 是一个结构体，包含了以下字段：<ul>
<li><code>key</code>: 账户的公钥（地址）。</li>
<li><code>is_signer</code>: 表示该账户是否是交易的签名者。</li>
<li><code>is_writable</code>: 表示该账户是否可写（即是否可以修改其数据或余额）。</li>
<li><code>lamports</code>: 账户中的 SOL 余额（以 lamports 为单位，1 SOL &#x3D; 10^9 lamports）。</li>
<li><code>data</code>: 账户存储的数据（字节数组）。</li>
<li><code>owner</code>: 账户的所有者程序（即哪个程序有权修改该账户的数据）。</li>
<li><code>用途</code> ：AccountInfo 是 Solana 程序中最基础的账户表示形式，所有的账户操作最终都会涉及到 AccountInfo。开发者可以直接通过 AccountInfo 来访问和修改账户的数据。</li>
</ul>
</li>
</ul>
<h2 id="如何转换-Account-和-AccountInfo？"><a href="#如何转换-Account-和-AccountInfo？" class="headerlink" title="如何转换 Account 和 AccountInfo？"></a>如何转换 Account 和 AccountInfo？</h2><p>在 Anchor 中，<code>Account</code> 实际上是对 <code>AccountInfo</code> 的封装。可以通过以下方式获取底层 <code>AccountInfo</code>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">account_info</span>: &amp;AccountInfo = ctx.accounts.my_account.<span class="title function_ invoke__">to_account_info</span>();</span><br></pre></td></tr></table></figure>

<p>反之，若需将 <code>AccountInfo</code> 转换为 Anchor 的 <code>Account</code>，需手动验证并反序列化数据：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">account</span>: Account&lt;MyData&gt; = Account::<span class="title function_ invoke__">try_from</span>(&amp;account_info)?;</span><br></pre></td></tr></table></figure>


<h1 id="InterfaceAccount"><a href="#InterfaceAccount" class="headerlink" title="InterfaceAccount"></a>InterfaceAccount</h1><p>InterfaceAccount 是一个接口 ，定义了账户必须实现的方法或属性。它的作用类似于面向对象编程中的接口（如 Java 的 Interface 或 Rust 的 Trait），确保不同账户类型遵循统一的行为规范。</p>
<p>在 Solana 的 Anchor 框架中，InterfaceAccount&lt;’info, TokenAccount&gt; 是一种结合了接口（Interface）和具体账户类型（如 TokenAccount）的泛型结构。它用于在智能合约中约束某个账户必须实现特定的接口（即行为规范），同时关联具体的账户类型（如 SPL Token 账户）。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> etf_token_ata: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">InterfaceAccount</span>&lt;<span class="symbol">&#x27;info</span>, T: AccountSerialize + AccountDeserialize + <span class="built_in">Clone</span>&gt; &#123;</span><br><span class="line">    account: Account&lt;<span class="symbol">&#x27;info</span>, T&gt;,</span><br><span class="line">    <span class="comment">// The owner here is used to make sure that changes aren&#x27;t incorrectly propagated</span></span><br><span class="line">    <span class="comment">// to an account with a modified owner</span></span><br><span class="line">    owner: Pubkey,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-泛型参数"><a href="#1-泛型参数" class="headerlink" title="1. 泛型参数"></a>1. <strong>泛型参数</strong></h4><ul>
<li><strong><code>&#39;info</code></strong> ：生命周期参数，确保账户引用的上下文有效性。</li>
<li><strong><code>T</code></strong> ：泛型类型参数，需满足以下约束：<ul>
<li><code>AccountSerialize</code>：账户数据可序列化。</li>
<li><code>AccountDeserialize</code>：账户数据可反序列化。</li>
<li><code>Clone</code>：允许结构体被克隆。</li>
</ul>
</li>
</ul>
<h4 id="2-字段说明"><a href="#2-字段说明" class="headerlink" title="2. 字段说明"></a>2. <strong>字段说明</strong></h4><ul>
<li><strong><code>account: Account&lt;&#39;info, T&gt;</code></strong><br>  封装具体账户数据的 Anchor 账户类型，包含账户的元数据（如地址、权限、数据等）。</li>
<li><strong><code>owner: Pubkey</code></strong><br>  账户的原始所有者公钥，owner 字段保存账户的初始所有者公钥 。在操作账户前，检查当前账户的所有者是否与 owner 一致，确保操作合法性。防止所有者被篡改后引发的安全问题。</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义代币操作接口</span></span><br><span class="line"><span class="meta">#[interface]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">TokenInterface</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">transfer</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, to: &amp;<span class="keyword">mut</span> <span class="keyword">dyn</span> TokenInterface, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> ProgramResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 SPL Token 账户实现接口</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">TokenInterface</span> <span class="keyword">for</span> <span class="title class_">SplTokenAccount</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">transfer</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, to: &amp;<span class="keyword">mut</span> <span class="keyword">dyn</span> TokenInterface, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">        <span class="comment">// 调用 SPL Token 程序的转账逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在指令上下文中使用 InterfaceAccount</span></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Transfer</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> from: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, SplTokenAccount&gt;,</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> to: InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, SplTokenAccount&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行转账</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer</span>(ctx: Context&lt;Transfer&gt;, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> ProgramResult &#123;</span><br><span class="line">    ctx.accounts.from.<span class="title function_ invoke__">transfer</span>(&amp;<span class="keyword">mut</span> ctx.accounts.to, amount)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="AccountLoader"><a href="#AccountLoader" class="headerlink" title="AccountLoader"></a>AccountLoader</h1><p>在Solana中，每个账户的数据是以字节数组的形式存储的。当你在智能合约中处理账户数据时，通常需要将这些字节数组反序列化为 Rust 的结构体或其他高级数据结构，以便进行操作。手动处理字节数组不仅繁琐，而且容易出错。</p>
<h2 id="AccountLoader-的主要作用是："><a href="#AccountLoader-的主要作用是：" class="headerlink" title="AccountLoader 的主要作用是："></a>AccountLoader 的主要作用是：</h2><ul>
<li><code>简化数据加载</code> ：自动将账户的字节数组反序列化为 Rust 结构体。</li>
<li><code>提供线程安全的访问 </code>：通过 load() 和 load_mut() 方法，确保对账户数据的读写操作是线程安全的。</li>
<li><code>支持复杂数据结构</code> ：可以轻松处理复杂的嵌套数据结构，而不需要手动解析字节数组。</li>
</ul>
<h2 id="什么是-zero-copy-unsafe"><a href="#什么是-zero-copy-unsafe" class="headerlink" title="什么是(zero_copy(unsafe))"></a>什么是(zero_copy(unsafe))</h2><p><code>#[account(zero_copy(unsafe))]</code> 是 Anchor 提供的一个属性，用于标记一个账户结构体为“零拷贝”（Zero-Copy）模式。这意味着该结构体的数据不会被反序列化到 Rust 的堆内存中，而是直接从账户的字节数组中读取和写入数据。</p>
<ul>
<li><strong><code>零拷贝</code></strong> ：零拷贝是一种优化技术，避免了将数据从字节数组反序列化为 Rust 结构体的过程。相反，程序直接操作原始字节数组中的数据。</li>
<li><strong><code>unsafe</code></strong> ：由于零拷贝模式绕过了 Rust 的安全检查机制（如边界检查），因此它被认为是不安全的。开发者需要确保手动处理数据时不会出现越界访问等问题。</li>
</ul>
<h2 id="为什么要用零拷贝？"><a href="#为什么要用零拷贝？" class="headerlink" title="为什么要用零拷贝？"></a>为什么要用零拷贝？</h2><p>Solana 的账户数据是以字节数组的形式存储的，通常在智能合约中需要将这些字节数组反序列化为 Rust 结构体进行操作。然而，这种反序列化过程会带来以下问题：</p>
<ul>
<li><strong><code>性能开销</code></strong> ：每次加载账户数据时都需要进行反序列化，这会消耗额外的 CPU 时间。</li>
<li>**<code>内存占用</code>**：反序列化后的数据会被复制到堆内存中，增加了内存使用。</li>
<li>通过使用零拷贝模式，可以避免这些开销，因为程序直接操作原始字节数组中的数据，而不需要额外的反序列化和内存分配。</li>
</ul>
<h2 id="什么是repr-packed-？"><a href="#什么是repr-packed-？" class="headerlink" title="什么是repr(packed)？"></a>什么是repr(packed)？</h2><p>#[repr(packed)] 是 Rust 的一个属性，用于指定结构体的内存布局。具体来说，它告诉编译器不要在结构体字段之间插入任何填充字节（padding），从而使得结构体的内存布局更加紧凑。</p>
<ul>
<li><strong><code>默认行为</code></strong> ：Rust 编译器为了提高内存访问效率，通常会在结构体字段之间插入填充字节，以确保字段的对齐（alignment）。例如，u64 类型通常需要 8 字节对齐。</li>
<li><strong><code>packed 属性</code></strong> ：使用 #[repr(packed)] 后，编译器会移除这些填充字节，使得结构体的大小尽可能小。</li>
</ul>
<p>在 Solana 中，账户数据是以字节数组的形式存储的，且每个账户都有固定的大小。为了最大化利用账户空间并减少浪费，通常会希望结构体的内存布局与账户数据的字节数组布局完全一致。</p>
<p>如果不对结构体使用 #[repr(packed)]，编译器可能会插入填充字节，导致结构体的内存布局与账户数据的字节数组布局不匹配，进而引发数据解析错误。</p>
<p>举个例子</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyData</span> &#123;</span><br><span class="line">    value: <span class="type">u64</span>,  <span class="comment">// 8 bytes</span></span><br><span class="line">    flag: <span class="type">bool</span>,  <span class="comment">// 1 byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在默认情况下，Rust 编译器会对 MyData 进行对齐处理。由于 u64 需要 8 字节对齐，编译器会在 flag 后面插入 7 个填充字节，以确保下一个字段（如果有）也能正确对齐。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| u64 (8 bytes) | bool (1 byte) | padding (7 bytes) |</span><br></pre></td></tr></table></figure>
<p>如果我们使用 #[repr(packed)]，编译器将不会插入任何填充字节，结构体的内存布局将是紧凑的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| u64 (8 bytes) | bool (1 byte) |</span><br></pre></td></tr></table></figure>

<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><ul>
<li><strong><code>填充字节的作用</code></strong> ：Rust 编译器默认会在结构体字段之间插入填充字节，以确保字段的对齐要求。这种行为提高了内存访问效率，但可能导致结构体的内存布局与账户数据的字节数组布局不匹配。</li>
<li><strong><code>问题的原因</code></strong> ：如果不对结构体使用 #[repr(packed)]，编译器可能会插入填充字节，导致结构体的内存布局与账户数据的字节数组布局不一致。这会引发数据解析错误，因为程序会错误地读取或写入数据。</li>
<li><strong><code>解决方案</code></strong> ：使用 #[repr(packed)] 来移除填充字节，确保结构体的内存布局与账户数据的字节数组布局一致。这样可以避免数据解析错误，并高效地利用账户空间。</li>
</ul>
<h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><ul>
<li>虽然 #[repr(packed)] 可以解决数据布局不匹配的问题，但它也有一些潜在的风险：<ul>
<li><strong><code>性能下降</code></strong> ：未对齐的内存访问在某些架构上可能会导致性能下降。</li>
<li><strong><code>安全性风险</code></strong> ：未对齐的内存访问在某些架构上可能会导致崩溃或未定义行为。</li>
</ul>
</li>
</ul>
<h2 id="怎么用："><a href="#怎么用：" class="headerlink" title="怎么用："></a>怎么用：</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Accounts)]</span> 里面使用：</span><br><span class="line">	<span class="meta">#[account(init, payer = user, space = 8 + 8)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">	<span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line">    </span><br><span class="line">------------------------------</span><br><span class="line">结构体：</span><br><span class="line"><span class="meta">#[account(zero_copy(unsafe))]</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="meta">#[derive(Default, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PoolState</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> pool_creator: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_0_vault: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_1_vault: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_0_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_1_mint: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> token_0_vault: <span class="type">u64</span>,</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line">------------------------------</span><br><span class="line">方法使用：</span><br><span class="line"><span class="comment">//load(): 返回一个不可变引用，确保数据不会被修改。</span></span><br><span class="line"><span class="comment">//load_mut(): 返回一个可变引用，允许修改数据，但确保同一时间只有一个指令可以修改该数据。</span></span><br><span class="line"><span class="comment">//load_init() 时，会创建一个新的账户并将其反序列化为 PoolState 结构体。</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pool_state</span> =  ctx.accounts.pool_state.<span class="title function_ invoke__">load_init</span>()?;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/23/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20to_owned()%E4%B8%8Eto_clone()%E7%9A%84%E5%AF%B9%E6%AF%94/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/23/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20to_owned()%E4%B8%8Eto_clone()%E7%9A%84%E5%AF%B9%E6%AF%94/" itemprop="url">Solana 合约开发 - to_owned()与to_clone()的对比</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-23T23:12:59+08:00">
                2025-02-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用to-owned-和使用引用对比："><a href="#使用to-owned-和使用引用对比：" class="headerlink" title="使用to_owned()和使用引用对比："></a>使用to_owned()和使用引用对比：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts</span> = ctx</span><br><span class="line">    .remaining_accounts</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|x| (x.<span class="title function_ invoke__">key</span>(), x.<span class="title function_ invoke__">to_owned</span>()))</span><br><span class="line">    .collect::&lt;HashMap&lt;_, _&gt;&gt;();</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong><code>所有权转移</code></strong> ：<br>x.to_owned() 会创建一个 AccountInfo 的深拷贝（即完全独立的副本），并将这个副本存储到 HashMap 中。<br>这意味着 accounts 拥有这些 AccountInfo 的所有权，而不是借用它们。</p>
</li>
<li><p><strong><code>生命周期</code></strong> ：<br>因为 accounts 存储的是深拷贝的数据，它的生命周期与 ctx.remaining_accounts 无关。<br>它可以独立存在，即使 ctx.remaining_accounts 被释放或超出作用域，accounts 仍然有效。</p>
</li>
<li><p><strong><code>内存开销</code></strong> ：<br>由于每个 AccountInfo 都被深拷贝，这会导致额外的内存分配和性能开销。</p>
</li>
<li><p><strong><code>适用场景</code></strong> ：<br>如果你需要在函数外部返回 accounts(例如<code>fn xxx() -&gt; HashMap&lt;Pubkey, AccountInfo&gt;</code>)，或者长时间持有这些数据，这种方法是合适的。<br>但要注意，Solana 程序中通常不建议频繁深拷贝数据，因为这会增加计算和内存开销。</p>
</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">accounts_map</span>: HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;<span class="symbol">&#x27;info</span>&gt;&gt; = ctx</span><br><span class="line">    .remaining_accounts</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|acc| (acc.key, acc))</span><br><span class="line">    .<span class="title function_ invoke__">collect</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong><code>借用而非拥有</code></strong> ：<br>这里没有调用 to_owned()，而是直接借用 ctx.remaining_accounts 中的 AccountInfo 引用。<br>accounts_map 中存储的是对 ctx.remaining_accounts 中元素的引用（&amp;AccountInfo&lt;’info&gt;），而不是独立的副本。</p>
</li>
<li><p><strong><code>生命周期绑定</code></strong> ：<br>accounts_map 的生命周期与 ctx.remaining_accounts 绑定。<br>如果 ctx.remaining_accounts 被释放或超出作用域，accounts_map 中的引用也会失效。<br>这是因为 accounts_map 中的引用依赖于 ctx.remaining_accounts 的生命周期。</p>
</li>
<li><p><strong><code>内存开销</code></strong> ：<br>由于只是存储引用，不会产生额外的内存分配，性能更高。</p>
</li>
<li><p><strong><code>适用场景</code></strong> ：<br>如果你只需要在当前函数的作用域内使用 accounts_map，并且不需要长期持有这些数据，这种方法更高效。<br>这是 Solana 程序中推荐的方式，因为它避免了不必要的深拷贝。</p>
</li>
</ul>
<h1 id="使用to-owned-和clone-对比："><a href="#使用to-owned-和clone-对比：" class="headerlink" title="使用to_owned()和clone()对比："></a>使用to_owned()和clone()对比：</h1><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">pool_input_vault_info</span> = accounts   <span class="comment">//HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;&#x27;info&gt;&gt;</span></span><br><span class="line">	.<span class="title function_ invoke__">get</span>(&amp;pool_input_vault_key) <span class="comment">//Option&lt;&amp;&amp;AccountInfo&lt;&#x27;info&gt;&gt;</span></span><br><span class="line">    .<span class="title function_ invoke__">ok_or</span>(ErrorCode::InvalidAccounts)? <span class="comment">// &amp;&amp;AccountInfo</span></span><br><span class="line">    .<span class="title function_ invoke__">to_owned</span>(); <span class="comment">// &amp;AccountInfo</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>**<code>定义</code>**：to_owned() 是一个特定于某些类型的方法，通常用于将借用的数据（如引用）转换为拥有所有权的数据。</p>
</li>
<li><p>**<code>行为</code>**：<br><code>to_owned()</code> 通常用于从借用类型（如 &amp;str 或 &amp;AccountInfo）创建拥有所有权的类型（如 String 或 AccountInfo）。<br>它不会递归地复制所有子对象，而是根据具体类型的行为来决定如何复制数据。<br>对于字符串切片 &amp;str，to_owned() 返回一个 String；对于 &amp;AccountInfo，它返回一个 AccountInfo。</p>
</li>
<li><p>**<code>适用场景</code>**：<br>当你有一个借用的数据（如引用），并且你需要拥有该数据的所有权时。<br>当你需要避免双重引用的问题，或者当你需要确保后续代码可以安全地使用该数据时。</p>
</li>
<li><p>**<code>性能考虑</code>**：<br>to_owned() 通常比 clone() 更高效，因为它只复制必要的部分，而不是递归地复制整个对象树。<br>对于简单的类型（如字符串或基本数据结构），to_owned() 的性能开销较小。</p>
</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">pool_input_vault_info</span> = accounts</span><br><span class="line">    .<span class="title function_ invoke__">get</span>(&amp;pool_input_vault_key)</span><br><span class="line">    .<span class="title function_ invoke__">ok_or</span>(ErrorCode::InvalidAccounts)?</span><br><span class="line">    .<span class="title function_ invoke__">clone</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><p>**<code>定义</code>**：clone() 是一个 trait 方法，属于 Clone trait。它用于创建一个类型的新实例，该实例是原始实例的深度副本。</p>
</li>
<li><p>**<code>行为</code>**：<br>clone() 会递归地复制整个对象及其所有子对象。<br>对于实现了 Clone trait 的类型，clone() 可以用于任何类型的对象，包括复杂的数据结构（如 Vec<T>、HashMap&lt;K, V&gt; 等）。<br>如果类型中的字段也实现了 Clone，则这些字段也会被递归复制。</p>
</li>
<li><p>**<code>适用场景</code>**：<br>当你需要完全复制一个复杂的对象，并且不希望两个对象共享任何内部数据时。<br>当你需要确保两个变量拥有独立的状态时。</p>
</li>
<li><p>**<code>性能考虑</code>**：<br>clone() 可能会导致较高的性能开销，因为它需要递归地复制所有子对象。对于大型或复杂的数据结构，这可能会导致显著的性能下降。</p>
</li>
</ul>
<p>在上面两段代码中<br>to_owned()：<br>适用于你只需要将引用转换为拥有所有权的对象，而不需要递归复制整个对象树的情况。<br>在代码中，accounts 是一个 HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;’info&gt;&gt;，因此 to_owned() 可以将 &amp;&amp;AccountInfo&lt;’info&gt; 转换为 &amp;AccountInfo&lt;’info&gt;，从而避免双重引用问题。</p>
<h2 id="双重引用问题："><a href="#双重引用问题：" class="headerlink" title="双重引用问题："></a>双重引用问题：</h2><p>在 Rust 中，双重引用（double reference）是指你有一个指向另一个引用的引用。例如，&amp;AccountInfo&lt;’info&gt; 是一个对 AccountInfo&lt;’info&gt; 的引用。</p>
<h3 id="双重引用问题的背景"><a href="#双重引用问题的背景" class="headerlink" title="双重引用问题的背景"></a>双重引用问题的背景</h3><p>在之前的代码中，accounts 是一个 HashMap&lt;&amp;Pubkey, &amp;AccountInfo&lt;’info&gt;&gt;，即键是 Pubkey 的引用，值是 AccountInfo&lt;’info&gt; 的引用。当你从 accounts 中获取某个账户信息时，返回的是 Option&lt;&amp;&amp;AccountInfo&lt;’info&gt;&gt;，即对 AccountInfo&lt;’info&gt; 的引用的引用。</p>
<p>如果你直接在这个引用上使用 .clone()，它只会复制这个引用，而不是内部的 AccountInfo&lt;’info&gt; 对象。这会导致双重引用的问题，即你最终会得到的还是 &amp;&amp;AccountInfo&lt;’info&gt;，而不是你期望的 &amp;AccountInfo&lt;’info&gt;。</p>
<h2 id="如何避免双重引用问题"><a href="#如何避免双重引用问题" class="headerlink" title="如何避免双重引用问题"></a>如何避免双重引用问题</h2><p>为了避免双重引用问题，你可以使用以下几种方法：</p>
<ul>
<li><p>**<code>使用 .to_owned()</code>**：<br><code>.to_owned()</code> 用于将借用的数据转换为拥有所有权的数据。对于 &amp;AccountInfo&lt;’info&gt;，它会创建一个新的 AccountInfo&lt;’info&gt; 实例，从而避免了双重引用问题。</p>
</li>
<li><p>**<code>解引用并克隆</code>**：<br>你可以先解引用，然后克隆内部的数据。例如，<code>*accounts.get(&amp;key).ok_or(ErrorCode::InvalidAccounts).clone()?</code>，但这通常不如 .to_owned() 简洁和高效。</p>
</li>
<li><p>**<code>直接解引用</code>**：<br>如果你只需要读取数据而不需要修改或复制整个对象，可以直接解引用并使用该数据。例如，<code>*accounts.get(&amp;key).ok_or(ErrorCode::InvalidAccounts)?</code>。</p>
</li>
</ul>
<h2 id="为什么to-owned-更高效？"><a href="#为什么to-owned-更高效？" class="headerlink" title="为什么to_owned()更高效？"></a>为什么to_owned()更高效？</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个包含 Borrowed 数据的 OuterData</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">original</span> = OuterData &#123;</span><br><span class="line">    name: <span class="string">&quot;outer&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    inner: InnerData &#123;</span><br><span class="line">        value: Cow::<span class="title function_ invoke__">Borrowed</span>(<span class="string">&quot;hello&quot;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">此时内存布局：</span><br><span class="line">original.name → <span class="string">&quot;outer&quot;</span> (堆内存)</span><br><span class="line">original.inner.value → <span class="string">&quot;hello&quot;</span> (静态内存，Borrowed)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用<code>clone()</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">cloned</span> = original.<span class="title function_ invoke__">clone</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>clone()</code> 会递归克隆所有字段：<ul>
<li>name: String：深拷贝堆内存中的字符串（分配新堆内存）。</li>
<li>inner: InnerData：调用 InnerData 的 clone()：</li>
<li>value: Cow::Borrowed(“hello”) → 仍然指向原始静态内存。</li>
</ul>
</li>
</ul>
</li>
<li><p>使用<code>to_owned()</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">owned</span> = original.<span class="title function_ invoke__">to_owned</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li><code>to_owned()</code> 会按需复制 ：<ul>
<li>name: String：已经是拥有所有权的类型，直接转移所有权（原堆内存，无需复制）。</li>
<li>inner.value: Cow::Borrowed → 转换为 Cow::Owned，复制数据到堆内存。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>总结：<br><code>clone()</code> 是“傻瓜式”深拷贝 ：不管数据是否已拥有，都会递归复制。<br><code>to_owned()</code> 是“智能”所有权转换 ：仅复制必要的借用数据，最大化复用已有资源。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%E4%B8%80%EF%BC%9ALP%20Token%20Stake&Unstake%EF%BC%88%E5%8D%95%E4%B8%80%E5%A5%96%E5%8A%B1%E6%B1%A0%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%E4%B8%80%EF%BC%9ALP%20Token%20Stake&Unstake%EF%BC%88%E5%8D%95%E4%B8%80%E5%A5%96%E5%8A%B1%E6%B1%A0%EF%BC%89/" itemprop="url">Solana 合约开发 - DeFi - Dex 开发十一：LP Token Stake&Unstake（单一奖励池）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-16T21:20:32+08:00">
                2025-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-DeFi-Dex/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发-DeFi-Dex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是质押？"><a href="#什么是质押？" class="headerlink" title="什么是质押？"></a>什么是质押？</h1><p>质押是指用户将其持有的加密货币或代币锁定在区块链网络中，以支持网络的安全性、验证交易或生成新区块。作为回报，用户可以获得一定比例的奖励，这些奖励通常以原生代币的形式发放。</p>
<h2 id="质押的主要类型"><a href="#质押的主要类型" class="headerlink" title="质押的主要类型"></a>质押的主要类型</h2><p>(1) 原生质押（Native Staking）<br>用户直接将代币质押到区块链网络中，通常是通过官方钱包或节点软件完成。例如：<br>在 Cardano 上使用 Daedalus 钱包质押 ADA。<br>在 Polkadot 上质押 DOT 成为提名者。</p>
<p>(2) 流动性质押（Liquid Staking）<br>流动性质押允许用户在质押的同时保持资金流动性。用户将代币质押到特定协议中，获得代表质押份额的流动性代币（LP Token）。这些流动性代币可以在 DeFi 协议中进一步使用，例如提供流动性或参与收益 farming，例如本章节，这种也称为流动性挖矿，这样用户有收益，也尽量不会取出原先质押的代币，保证池的流动性稳定。</p>
<p>(3) 委托质押（Delegated Staking）<br>用户将代币委托给第三方验证者或质押池，由他们负责维护网络并分享收益。这种方式适合不想亲自运行节点的用户。</p>
<h2 id="什么是单一奖励池Farms奖励机制？"><a href="#什么是单一奖励池Farms奖励机制？" class="headerlink" title="什么是单一奖励池Farms奖励机制？"></a>什么是单一奖励池Farms奖励机制？</h2><p>(1) 单一奖励池<br>在单一奖励池中，用户质押 LP Token 后，只能获得 项目代币 奖励。<br>奖励的分配公式如下： <code>每日奖励 = （用户质押份额 / 总质押份额) * 每日奖励池</code></p>
<p>示例：<br>假设以下场景：<br>用户 Alice 决定参与 DEX 的 EURC-USDC Farm：</p>
<ol>
<li>Alice 将 100 EURC 和 100 USDC 存入 SWAP-USDC 流动性池，获得 100 EURC-USDC LP Token。</li>
<li>Alice 将这 100 LP Token 质押到 EURC-USDC Farm 中。</li>
<li>当前质押池的总质押量为 10,000 LP Token。</li>
<li>用户份额占比为 1%</li>
<li>DEX 每天向该 Farm 分配 1,000 SWAP项目代币。</li>
<li>每日奖励&#x3D;用户份额占比×每日奖励池&#x3D;1%×1,000&#x3D;10 SWAP</li>
<li>假如只质押30天，那么 累计奖励&#x3D;每日奖励×质押时间&#x3D;10×30&#x3D;300 SWAP</li>
<li>解质押后，返还原先的LP Token，并奖励 SWAP项目代币</li>
</ol>
<h1 id="什么是epoch"><a href="#什么是epoch" class="headerlink" title="什么是epoch?"></a>什么是epoch?</h1><p>Solana Epoch（纪元） 是 Solana 区块链网络中的一个时间单位，用于组织和管理区块链的时间周期。每个 Epoch 代表一段时间，通常持续 2 天左右（具体时长取决于网络的出块速度）。期间网络会进行一系列关键操作，例如验证者轮换、奖励分配以及费用调整等。</p>
<h2 id="Epoch-的结构"><a href="#Epoch-的结构" class="headerlink" title="Epoch 的结构"></a>Epoch 的结构</h2><p>(1) Slot（时隙）<br>Solana 使用 Slot 作为基本的时间单位，每个 Slot 代表 400 毫秒 的时间。<br>在每个 Slot 中，验证者有机会生成一个区块。</p>
<p>(2) Epoch 的长度<br>每个 Epoch 包含固定的 Slot 数量，通常约为 432,000 个 Slot（每 Slot 400 毫秒，总时长约 2 天）。<br>随着网络的发展，Epoch 的长度可能会动态调整。</p>
<p>(3) Leader Schedule（领导者时间表）<br>在每个 Epoch 开始时，Solana 网络会生成一个新的 Leader Schedule，指定哪些验证者负责生成区块。<br>这种随机分配机制可以防止恶意行为并增强网络的安全性。</p>
<h1 id="合约代码"><a href="#合约代码" class="headerlink" title="合约代码"></a>合约代码</h1><h2 id="质押"><a href="#质押" class="headerlink" title="质押"></a>质押</h2><p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;accounts_all&#x2F;stake.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::associated_token::AssociatedToken;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::Token;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_2022::Token2022;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::&#123;Mint,  TokenAccount&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::&#123;LpTokenStake, PoolState,token,StakePool&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="meta">#[instruction(index: u16)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LPTokenStake</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//质押信息账户，每创建一个质押订单都创建一个账户记录</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = user,</span></span><br><span class="line"><span class="meta">        space = 8 + LpTokenStake::INIT_SPACE,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            LpTokenStake::SEED_PREFIX.as_bytes(), </span></span><br><span class="line"><span class="meta">            stake_pool.key().as_ref(),</span></span><br><span class="line"><span class="meta">            user.key().as_ref(),</span></span><br><span class="line"><span class="meta">            &amp;index.to_be_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">                            </span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> stake_info: <span class="type">Box</span>&lt;Account&lt;<span class="symbol">&#x27;info</span>, LpTokenStake&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            StakePool::SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            lp_mint.key().as_ref(),</span></span><br><span class="line"><span class="meta">            reward_mint.key().as_ref()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> stake_pool: AccountLoader&lt;<span class="symbol">&#x27;info</span>, StakePool&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lp mint</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            PoolState::POOL_LP_MINT_SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            pool_state.key().as_ref(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> lp_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收质押lp 金库</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = user,</span></span><br><span class="line"><span class="meta">        associated_token::mint = lp_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = stake_pool,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> program_receipt_lp_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 项目原生代币mint,也就是前面章节讲过的SPL Token</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            token::SWAP_TOKEN_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,        </span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> reward_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户持有lp的 ata</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        associated_token::mint = lp_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = user,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> user_lp_token_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: pool vault and lp mint authority</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            crate::AUTH_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> authority: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> user: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program_2022: Program&lt;<span class="symbol">&#x27;info</span>, Token2022&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化质押池</span></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">InitializePool</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AccountLoader space 需自行计算space，不能Init_space</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        payer = payer,</span></span><br><span class="line"><span class="meta">        space =  StakePool::LEN,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            StakePool::SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            lp_mint.key().as_ref(),</span></span><br><span class="line"><span class="meta">            reward_mint.key().as_ref()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> stake_pool: AccountLoader&lt;<span class="symbol">&#x27;info</span>, StakePool&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            PoolState::POOL_LP_MINT_SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            pool_state.key().as_ref(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> lp_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            token::SWAP_TOKEN_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,        </span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> reward_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init,</span></span><br><span class="line"><span class="meta">        payer = payer,</span></span><br><span class="line"><span class="meta">        associated_token::mint = reward_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = stake_pool,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> reward_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: pool vault and lp mint authority</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            crate::AUTH_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> authority: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> payer: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program_2022: Program&lt;<span class="symbol">&#x27;info</span>, Token2022&gt;,</span><br><span class="line">    <span class="keyword">pub</span> rent: Sysvar&lt;<span class="symbol">&#x27;info</span>, Rent&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;states&#x2F;stake.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::&#123;prelude::*, solana_program::stake&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="meta">#[derive(InitSpace, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LpTokenStake</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> index: <span class="type">u16</span>,                 <span class="comment">//索引</span></span><br><span class="line">    <span class="keyword">pub</span> staker: Pubkey,             <span class="comment">//质押人</span></span><br><span class="line">    <span class="keyword">pub</span> token_mint_account: Pubkey, <span class="comment">//质押的token Mint</span></span><br><span class="line">    <span class="keyword">pub</span> staked_at: <span class="type">i64</span>,             <span class="comment">//质押的时间</span></span><br><span class="line">    <span class="keyword">pub</span> staked_amount: <span class="type">u64</span>,         <span class="comment">//质押的数量</span></span><br><span class="line">    <span class="keyword">pub</span> staked_pool: Pubkey,        <span class="comment">//质押的池子</span></span><br><span class="line">    <span class="keyword">pub</span> reward: <span class="type">u64</span>,                <span class="comment">//奖励</span></span><br><span class="line">    <span class="keyword">pub</span> last_update_time: <span class="type">i64</span>,      <span class="comment">//上次更新时间</span></span><br><span class="line">    <span class="keyword">pub</span> status: <span class="type">u8</span>,                 <span class="comment">//状态, 1为opened,2为closed</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">LpTokenStake</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;stake_v1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(</span><br><span class="line">        index: <span class="type">u16</span>,</span><br><span class="line">        staker: Pubkey,</span><br><span class="line">        token_mint_account: Pubkey,</span><br><span class="line">        staked_amount: <span class="type">u64</span>,</span><br><span class="line">        staked_pool: Pubkey,</span><br><span class="line">        status: <span class="type">u8</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">staked_at</span> = Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">reward</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">last_update_time</span> = staked_at;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="keyword">Self</span> &#123;</span><br><span class="line">            index,</span><br><span class="line">            staker,</span><br><span class="line">            token_mint_account,</span><br><span class="line">            staked_at,</span><br><span class="line">            staked_amount,</span><br><span class="line">            staked_pool,</span><br><span class="line">            reward,</span><br><span class="line">            last_update_time,</span><br><span class="line">            status,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_reward_base_single_farm</span>(</span><br><span class="line">        &amp;<span class="keyword">self</span>,</span><br><span class="line">        amount: <span class="type">u64</span>,</span><br><span class="line">        total_staked: <span class="type">u64</span>,</span><br><span class="line">        daily_reward: <span class="type">u64</span>,</span><br><span class="line">        stake_info: &amp;LpTokenStake,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u64</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">current_time</span> = Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">time_elapsed</span> = current_time.<span class="title function_ invoke__">saturating_sub</span>(stake_info.staked_at) <span class="keyword">as</span> <span class="type">u64</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换时间为天数</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">days_passed</span> = time_elapsed.<span class="title function_ invoke__">checked_div</span>(<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>).<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0</span>);</span><br><span class="line">        msg!(<span class="string">&quot;days_passed: &#123;:?&#125;&quot;</span>, days_passed);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> total_staked == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>); <span class="comment">// 避免除以零的情况</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// reward = (amount * daily_ray_reward / total_staked) * days_passed</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">reward</span> = amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_mul</span>(daily_reward)</span><br><span class="line">            .<span class="title function_ invoke__">and_then</span>(|v| v.<span class="title function_ invoke__">checked_div</span>(total_staked))</span><br><span class="line">            .<span class="title function_ invoke__">and_then</span>(|v| v.<span class="title function_ invoke__">checked_mul</span>(days_passed))</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(ProgramError::InvalidArgument)?;</span><br><span class="line">        msg!(<span class="string">&quot;reward: &#123;:?&#125;&quot;</span>, reward);</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(reward)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[account(zero_copy(unsafe))]</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="meta">#[derive(Default, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">StakePool</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> pool_authority: Pubkey, <span class="comment">// 池子管理员</span></span><br><span class="line">    <span class="keyword">pub</span> lp_token_mint: Pubkey,  <span class="comment">// LP token 的 mint 地址</span></span><br><span class="line">    <span class="keyword">pub</span> reward_mint: Pubkey,    <span class="comment">// 奖励代币的 mint 地址</span></span><br><span class="line">    <span class="keyword">pub</span> reward_vault: Pubkey,   <span class="comment">// 奖励代币保管账户</span></span><br><span class="line">    <span class="keyword">pub</span> total_staked: <span class="type">u64</span>,      <span class="comment">// 总质押数量</span></span><br><span class="line">    <span class="keyword">pub</span> reward_rate: <span class="type">u64</span>,       <span class="comment">// 每秒产生的奖励数量</span></span><br><span class="line">    <span class="keyword">pub</span> recent_epoch: <span class="type">u64</span>,      <span class="comment">// 最近更新的 epoch</span></span><br><span class="line">    <span class="keyword">pub</span> reward_per_share: <span class="type">u64</span>,  <span class="comment">// 每股奖励累计值</span></span><br><span class="line">    <span class="keyword">pub</span> apr: <span class="type">u64</span>,               <span class="comment">// 年化收益率</span></span><br><span class="line">    <span class="keyword">pub</span> daily_reward: <span class="type">u64</span>,      <span class="comment">// 每日奖励</span></span><br><span class="line">    <span class="keyword">pub</span> auth_bump: <span class="type">u8</span>,          <span class="comment">// 权限bump</span></span><br><span class="line">    <span class="keyword">pub</span> status: <span class="type">u8</span>,             <span class="comment">// 池子状态</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">StakePool</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> SEED_PREFIX: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;stake_pool_v1&quot;</span>;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> LEN: <span class="type">usize</span> = <span class="number">194</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;instructions&#x2F;stake.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::&#123;transfer, Transfer&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::accounts_all::&#123;InitializePool, LPTokenStake&#125;;</span><br><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> crate::states::&#123;events::StakeEvent, LpTokenStake&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_token_stake</span>(ctx: Context&lt;LPTokenStake&gt;, index: <span class="type">u16</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">staker</span> = &amp;ctx.accounts.user;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lp_mint</span> = &amp;ctx.accounts.lp_mint;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stake_pool</span> = ctx.accounts.stake_pool.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line"></span><br><span class="line">    require!(amount &gt; <span class="number">0</span>, ErrorCode::InvalidAmount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查用户LP token余额</span></span><br><span class="line">    require!(</span><br><span class="line">        ctx.accounts.user_lp_token_account.amount &gt;= amount,</span><br><span class="line">        ErrorCode::InsufficientBalance</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录质押关系</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stake_info</span> = LpTokenStake::<span class="title function_ invoke__">new</span>(</span><br><span class="line">        index,</span><br><span class="line">        staker.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        lp_mint.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount,</span><br><span class="line">        ctx.accounts.stake_pool.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">    )?;</span><br><span class="line">    ctx.accounts.stake_info.<span class="title function_ invoke__">set_inner</span>(stake_info.<span class="title function_ invoke__">clone</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新池总量</span></span><br><span class="line">    stake_pool.total_staked = stake_pool</span><br><span class="line">        .total_staked</span><br><span class="line">        .<span class="title function_ invoke__">checked_add</span>(amount)</span><br><span class="line">        .<span class="title function_ invoke__">ok_or</span>(ErrorCode::InvalidAmount)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//转移LP代币到质押账户</span></span><br><span class="line">    <span class="title function_ invoke__">transfer</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            Transfer &#123;</span><br><span class="line">                from: ctx.accounts.user_lp_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                to: ctx.accounts.program_receipt_lp_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">                authority: ctx.accounts.user.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送事件</span></span><br><span class="line">    emit!(StakeEvent &#123;</span><br><span class="line">        staker: ctx.accounts.authority.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        amount: amount,</span><br><span class="line">        timestamp: Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">initialize_stake_pool</span>(ctx: Context&lt;InitializePool&gt;, daily_reward: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pool</span> = ctx.accounts.stake_pool.<span class="title function_ invoke__">load_init</span>()?;</span><br><span class="line"></span><br><span class="line">    pool.pool_authority = ctx.accounts.authority.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    pool.lp_token_mint = ctx.accounts.lp_mint.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    pool.reward_mint = ctx.accounts.reward_mint.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    pool.reward_vault = ctx.accounts.reward_vault.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    pool.total_staked = <span class="number">0</span>;</span><br><span class="line">    pool.reward_rate = <span class="number">0</span>;</span><br><span class="line">    pool.recent_epoch = Clock::<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">unwrap</span>().epoch;</span><br><span class="line">    pool.reward_per_share = <span class="number">0</span>;</span><br><span class="line">    pool.apr = <span class="number">0</span>;</span><br><span class="line">    pool.daily_reward = daily_reward;</span><br><span class="line">    pool.status = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="解质押"><a href="#解质押" class="headerlink" title="解质押"></a>解质押</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::associated_token::AssociatedToken;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::Token;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_2022::Token2022;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::&#123;Mint,  TokenAccount&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::&#123;LpTokenStake,StakePool, PoolState,token&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="meta">#[instruction(index: u16)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LPTokenUnStake</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//质押信息账户</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            LpTokenStake::SEED_PREFIX.as_bytes(), </span></span><br><span class="line"><span class="meta">            stake_pool.key().as_ref(),</span></span><br><span class="line"><span class="meta">            user.key().as_ref(),</span></span><br><span class="line"><span class="meta">            &amp;index.to_be_bytes()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">            </span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> stake_info: <span class="type">Box</span>&lt;Account&lt;<span class="symbol">&#x27;info</span>, LpTokenStake&gt;&gt;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            StakePool::SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            lp_mint.key().as_ref(),</span></span><br><span class="line"><span class="meta">            reward_mint.key().as_ref()</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> stake_pool: AccountLoader&lt;<span class="symbol">&#x27;info</span>, StakePool&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lp mint</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            PoolState::POOL_LP_MINT_SEED_PREFIX.as_bytes(),</span></span><br><span class="line"><span class="meta">            pool_state.key().as_ref(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> lp_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 池接收质押lp 金库</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        associated_token::mint = lp_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = stake_pool,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> program_receipt_lp_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 项目原生代币mint</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            token::ISWAP_TOKEN_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,        </span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> reward_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户持有项目原生代币的 ata</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = user,</span></span><br><span class="line"><span class="meta">        associated_token::mint = reward_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = user,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> associated_reward_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户持有lp的 ata</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        associated_token::mint = lp_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = user,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> user_lp_token_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: pool vault and lp mint authority</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            crate::AUTH_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> authority: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> user: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program_2022: Program&lt;<span class="symbol">&#x27;info</span>, Token2022&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;instructions&#x2F;unstake.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::accounts_all::LPTokenUnStake;</span><br><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> crate::states::&#123;events::UnStakeEvent, StakePool&#125;;</span><br><span class="line"><span class="keyword">use</span> crate::util::token::*;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_token_unstake_base_single_farm</span>(ctx: Context&lt;LPTokenUnStake&gt;, _index: <span class="type">u16</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stake_pool</span> = ctx.accounts.stake_pool.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">stake_info</span> = &amp;<span class="keyword">mut</span> ctx.accounts.stake_info;</span><br><span class="line"></span><br><span class="line">        stake_pool.recent_epoch = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查质押关系</span></span><br><span class="line">        require!(</span><br><span class="line">            stake_info.token_mint_account == ctx.accounts.lp_mint.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">            ErrorCode::NotAuthority</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        require!(</span><br><span class="line">            stake_info.staker == ctx.accounts.user.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">            ErrorCode::NotAuthority,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算奖励</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">reward_amount</span> = stake_info.<span class="title function_ invoke__">calculate_reward_base_single_farm</span>(</span><br><span class="line">            stake_info.staked_amount.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">            stake_pool.total_staked,</span><br><span class="line">            stake_pool.daily_reward,</span><br><span class="line">            stake_info,</span><br><span class="line">        )?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新质押信息</span></span><br><span class="line">        stake_info.reward = reward_amount;</span><br><span class="line">        stake_info.status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新池子总量</span></span><br><span class="line">        stake_pool.total_staked = stake_pool</span><br><span class="line">            .total_staked</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(stake_info.staked_amount)</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(ErrorCode::InvalidAmount)?;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lp_mint_key</span> = ctx.accounts.lp_mint.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reward_mint_key</span> = ctx.accounts.reward_mint.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stake_pool_signer_seeds</span>: &amp;[&amp;[&amp;[<span class="type">u8</span>]]] = &amp;[&amp;[</span><br><span class="line">        StakePool::SEED_PREFIX.<span class="title function_ invoke__">as_bytes</span>(),</span><br><span class="line">        lp_mint_key.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        reward_mint_key.<span class="title function_ invoke__">as_ref</span>(),</span><br><span class="line">        &amp;[ctx.bumps.stake_pool],</span><br><span class="line">    ]];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转移LP token 到用户账户</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.stake_pool.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.program_receipt_lp_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.user_lp_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.lp_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        <span class="keyword">if</span> ctx.accounts.lp_mint.<span class="title function_ invoke__">to_account_info</span>().owner == ctx.accounts.token_program.key &#123;</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.accounts.token_program_2022.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        ctx.accounts.stake_info.staked_amount,</span><br><span class="line">        ctx.accounts.lp_mint.decimals,</span><br><span class="line">        stake_pool_signer_seeds,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发放奖励</span></span><br><span class="line">    <span class="title function_ invoke__">token_mint_to</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.reward_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.associated_reward_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.stake_info.reward,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[ctx.bumps.authority]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    emit!(UnStakeEvent &#123;</span><br><span class="line">        staker: ctx.accounts.user.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        unstaked_key: ctx.accounts.stake_pool.<span class="title function_ invoke__">key</span>(),</span><br><span class="line">        unstaked_amount: ctx.accounts.stake_info.staked_amount,</span><br><span class="line">        reward_amount: ctx.accounts.stake_info.reward,</span><br><span class="line">        timestamp: Clock::<span class="title function_ invoke__">get</span>()?.unix_timestamp,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;lib.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">initialize_stake_pool</span>(ctx: Context&lt;InitializePool&gt;, daily_reward: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    instructions::<span class="title function_ invoke__">initialize_stake_pool</span>(ctx, daily_reward)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_token_stake</span>(ctx: Context&lt;LPTokenStake&gt;, index: <span class="type">u16</span>, amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    instructions::<span class="title function_ invoke__">lp_token_stake</span>(ctx, index, amount)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_token_unstake_base_single_farm</span>(</span><br><span class="line">    ctx: Context&lt;LPTokenUnStake&gt;,</span><br><span class="line">    index: <span class="type">u16</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    instructions::<span class="title function_ invoke__">lp_token_unstake_base_single_farm</span>(ctx, index)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="前端测试代码："><a href="#前端测试代码：" class="headerlink" title="前端测试代码："></a>前端测试代码：</h1><p>anchor&#x2F;example&#x2F;api&#x2F;stake.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&#x27;./wallet&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">InitStakePool</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">daily_reward</span>: anchor.BN,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [poolStatePda, bump] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">initializeStakePool</span>(daily_reward)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">poolState</span>: poolStatePda,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">lpTokenStake</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">stake_index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">amount</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="attr">pool_index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(pool_index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [poolStatePda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [lpMint] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_lp_token&#x27;</span>), poolStatePda.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [rewardMint] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;Iswap_token_V1&#x27;</span>)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [stakePoolPda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;stake_pool_v1&#x27;</span>), lpMint.<span class="title function_">toBuffer</span>(), rewardMint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [stakeInfoPda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [</span><br><span class="line">      <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;stake_v1&#x27;</span>),</span><br><span class="line">      stakePoolPda.<span class="title function_">toBuffer</span>(),</span><br><span class="line">      wallet.<span class="property">payer</span>.<span class="property">publicKey</span>.<span class="title function_">toBuffer</span>(),</span><br><span class="line">      <span class="title function_">u16ToBytes</span>(stake_index),</span><br><span class="line">    ],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">lpTokenStake</span>(stake_index, amount)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">poolState</span>: poolStatePda,</span><br><span class="line">      <span class="attr">stakeInfo</span>: stakeInfoPda, <span class="comment">//记住这里要强制输入stakeInfo,否则会报种子冲突问题，但其实是正确的</span></span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="built_in">never</span>) <span class="comment">// as never 忽略账户检查，为了强制输入stakeInfo,不忽略输入不了，不确定是否Anchor的bug</span></span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getStakeInfo</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">pool_index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">stake_index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(pool_index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [poolStatePda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [lpMint] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_lp_token&#x27;</span>), poolStatePda.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [rewardMint] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;Iswap_token_V1&#x27;</span>)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [stakePoolPda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;stake_pool_v1&#x27;</span>), lpMint.<span class="title function_">toBuffer</span>(), rewardMint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [stakeInfoPda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [</span><br><span class="line">      <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;stake_v1&#x27;</span>),</span><br><span class="line">      stakePoolPda.<span class="title function_">toBuffer</span>(),</span><br><span class="line">      wallet.<span class="property">payer</span>.<span class="property">publicKey</span>.<span class="title function_">toBuffer</span>(),</span><br><span class="line">      <span class="title function_">u16ToBytes</span>(stake_index),</span><br><span class="line">    ],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">account</span>.<span class="property">lpTokenStake</span>.<span class="title function_">fetch</span>(stakeInfoPda);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">u16ToBytes</span>(<span class="params"><span class="attr">num</span>: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(arr);</span><br><span class="line">  view.<span class="title function_">setUint16</span>(<span class="number">0</span>, num, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;example&#x2F;api&#x2F;unstake.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&#x27;./wallet&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">lpTokenUnStakeBaseSingleFarm</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">stake_index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">pool_index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(pool_index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [poolStatePda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [lpMint] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_lp_token&#x27;</span>), poolStatePda.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> [rewardMint] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;Iswap_token_V1&#x27;</span>)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [stakePoolPda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;stake_pool_v1&#x27;</span>), lpMint.<span class="title function_">toBuffer</span>(), rewardMint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [stakeInfoPda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [</span><br><span class="line">      <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;stake_v1&#x27;</span>),</span><br><span class="line">      stakePoolPda.<span class="title function_">toBuffer</span>(),</span><br><span class="line">      wallet.<span class="property">payer</span>.<span class="property">publicKey</span>.<span class="title function_">toBuffer</span>(),</span><br><span class="line">      <span class="title function_">u16ToBytes</span>(stake_index),</span><br><span class="line">    ],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">lpTokenUnstakeBaseSingleFarm</span>(stake_index)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">poolState</span>: poolStatePda,</span><br><span class="line">      <span class="attr">stakeInfo</span>: stakeInfoPda,</span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="built_in">never</span>)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">u16ToBytes</span>(<span class="params"><span class="attr">num</span>: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(arr);</span><br><span class="line">  view.<span class="title function_">setUint16</span>(<span class="number">0</span>, num, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>anchor&#x2F;example&#x2F;index.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="comment">// 创建质押池</span></span><br><span class="line">  <span class="keyword">const</span> stake_pool = <span class="keyword">await</span> <span class="title class_">InitStakePool</span>(</span><br><span class="line">    defaultWallet,</span><br><span class="line">    <span class="number">7</span>,</span><br><span class="line">    usdcDevTokenMint,</span><br><span class="line">    eurcDevTokenMint,</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">1_000_000_000</span>),</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(stake_pool);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 创建质押</span></span><br><span class="line">  <span class="keyword">const</span> stake_info = <span class="keyword">await</span> <span class="title function_">lpTokenStake</span>(</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    defaultWallet,</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">100_000</span>),</span><br><span class="line">    <span class="number">7</span>,</span><br><span class="line">    usdcDevTokenMint,</span><br><span class="line">    eurcDevTokenMint,</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(stake_info);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取质押信息</span></span><br><span class="line">  <span class="keyword">const</span> get_stake_info = <span class="keyword">await</span> <span class="title function_">getStakeInfo</span>(</span><br><span class="line">    defaultWallet,</span><br><span class="line">    usdcDevTokenMint,</span><br><span class="line">    eurcDevTokenMint,</span><br><span class="line">    <span class="number">7</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;get_stake_info is&#x27;</span>, get_stake_info);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解质押</span></span><br><span class="line">  <span class="keyword">const</span> lpUnStake = <span class="keyword">await</span> <span class="title function_">lpTokenUnStake</span>(<span class="number">2</span>, defaultWallet, <span class="number">7</span>, usdcDevTokenMint, eurcDevTokenMint);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(lpUnStake);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%EF%BC%9AProtocol%20Fee/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%8D%81%EF%BC%9AProtocol%20Fee/" itemprop="url">Solana 合约开发 - DeFi - Dex 开发十：Protocol Fee</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-16T20:52:29+08:00">
                2025-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-DeFi-Dex/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发-DeFi-Dex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在去中心化金融（DeFi）协议中，<strong>Protocol Fee（协议费用）</strong> 是一种机制，用于从交易或流动性池操作中抽取一定比例的费用，以支持协议本身的运营和发展，包括但不限于开发、维护、安全审计等。</p>
<p>本章节提取Protocol Fee 代码与上节<code>fund fee</code>基本差不多</p>
<h1 id="合约代码"><a href="#合约代码" class="headerlink" title="合约代码"></a>合约代码</h1><p>anchor&#x2F;programs&#x2F;iswap&#x2F;src&#x2F;accounts_all&#x2F;protocol_fee.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::states::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::associated_token::AssociatedToken;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::Token;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::Mint;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::Token2022;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::TokenAccount;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">CollectProtocolFee</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = creator,</span></span><br><span class="line"><span class="meta">        associated_token::mint = vault_0_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = authority,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> recipient_token_0_protocol_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = creator,</span></span><br><span class="line"><span class="meta">        associated_token::mint = vault_1_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = authority,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> recipient_token_1_protocol_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: pool vault and lp mint authority</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            crate::AUTH_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> authority: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> creator: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(address = pool_state.load()?.amm_config)]</span></span><br><span class="line">    <span class="keyword">pub</span> amm_config: Account&lt;<span class="symbol">&#x27;info</span>, AmmConfig&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        constraint = token_0_vault.key() == pool_state.load()?.token_0_vault</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> token_0_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        constraint = token_1_vault.key() == pool_state.load()?.token_1_vault</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> token_1_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        address = token_0_vault.mint</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> vault_0_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        address = token_1_vault.mint</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> vault_1_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program_2022: Program&lt;<span class="symbol">&#x27;info</span>, Token2022&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;instructions&#x2F;protocol_fee.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::accounts_all::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::util::*;</span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">collect_protocol_fee</span>(</span><br><span class="line">    ctx: Context&lt;CollectProtocolFee&gt;,</span><br><span class="line">    amount_0_requested: <span class="type">u64</span>,</span><br><span class="line">    amount_1_requested: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">transfer_amount_0</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">transfer_amount_1</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">auth_bump</span>: <span class="type">u8</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pool_state</span> = ctx.accounts.pool_state.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line"></span><br><span class="line">        transfer_amount_0 = amount_0_requested.<span class="title function_ invoke__">min</span>(pool_state.protocol_fees_token_0);</span><br><span class="line">        transfer_amount_1 = amount_1_requested.<span class="title function_ invoke__">min</span>(pool_state.protocol_fees_token_1);</span><br><span class="line"></span><br><span class="line">        auth_bump = pool_state.auth_bump;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 转移token0金库费用到协议账户费用</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.token_0_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts</span><br><span class="line">            .recipient_token_0_protocol_account</span><br><span class="line">            .<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.vault_0_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        <span class="keyword">if</span> ctx.accounts.vault_0_mint.<span class="title function_ invoke__">to_account_info</span>().owner == ctx.accounts.token_program.key &#123;</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.accounts.token_program_2022.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        transfer_amount_0,</span><br><span class="line">        ctx.accounts.vault_0_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line">    <span class="comment">// 转移token1金库费用到协议账户费用</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.token_1_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts</span><br><span class="line">            .recipient_token_1_protocol_account</span><br><span class="line">            .<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.vault_1_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        <span class="keyword">if</span> ctx.accounts.vault_1_mint.<span class="title function_ invoke__">to_account_info</span>().owner == ctx.accounts.token_program.key &#123;</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.accounts.token_program_2022.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        transfer_amount_1,</span><br><span class="line">        ctx.accounts.vault_1_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新流动性池状态</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pool_state</span> = ctx.accounts.pool_state.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line">        pool_state.protocol_fees_token_0 = pool_state</span><br><span class="line">            .protocol_fees_token_0</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(transfer_amount_0)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        pool_state.protocol_fees_token_1 = pool_state</span><br><span class="line">            .protocol_fees_token_1</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(transfer_amount_1)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        pool_state.latest_epoch = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;lib.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">collect_protocol_fee</span>(</span><br><span class="line">        ctx: Context&lt;CollectProtocolFee&gt;,</span><br><span class="line">        amount_0_requested: <span class="type">u64</span>,</span><br><span class="line">        amount_1_requested: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        instructions::<span class="title function_ invoke__">collect_protocol_fee</span>(ctx, amount_0_requested, amount_1_requested)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h1 id="前端测试代码"><a href="#前端测试代码" class="headerlink" title="前端测试代码"></a>前端测试代码</h1><p>anchor&#x2F;example&#x2F;index.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//protocol_fee转移</span></span><br><span class="line">  <span class="keyword">const</span> protocolfee_transfer = <span class="keyword">await</span> <span class="title function_">protocolFeeTransfer</span>(</span><br><span class="line">    defaultWallet,</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">10</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">0</span>),</span><br><span class="line">    usdcDevTokenMint,</span><br><span class="line">    eurcDevTokenMint,</span><br><span class="line">    pool_state.<span class="property">token0Vault</span>,</span><br><span class="line">    pool_state.<span class="property">token1Vault</span>,</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(protocolfee_transfer);</span><br></pre></td></tr></table></figure>


<p>anchor&#x2F;example&#x2F;api&#x2F;protocol_fee.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&#x27;./wallet&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">protocolFeeTransfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">transfer_amount_0</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="attr">transfer_amount_1</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Vault</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Vault</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [poolStatePda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">collectProtocolFee</span>(transfer_amount_0, transfer_amount_1)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">creator</span>: wallet.<span class="property">publicKey</span>,</span><br><span class="line">      <span class="attr">ammConfig</span>: ammConfigPda,</span><br><span class="line">      <span class="attr">poolState</span>: poolStatePda,</span><br><span class="line">      <span class="attr">token0Vault</span>: token0Vault,</span><br><span class="line">      <span class="attr">token1Vault</span>: token1Vault,</span><br><span class="line">      <span class="attr">vault0Mint</span>: token0Mint,</span><br><span class="line">      <span class="attr">vault1Mint</span>: token1Mint,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">u16ToBytes</span>(<span class="params"><span class="attr">num</span>: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(arr);</span><br><span class="line">  view.<span class="title function_">setUint16</span>(<span class="number">0</span>, num, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E4%B9%9D%EF%BC%9AFund%20Fee/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E4%B9%9D%EF%BC%9AFund%20Fee/" itemprop="url">Solana 合约开发 - DeFi - Dex 开发九：Fund Fee</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-16T19:45:08+08:00">
                2025-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-DeFi-Dex/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发-DeFi-Dex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>Fund Fee</code> 是从交易手续费中提取的一部分，通常用于支持项目的长期发展，例如开发新功能、市场推广、技术研究等。而fund fee的产生来源于上一节中Swap 过程中抽取的手续费，本章节讲解如何提取fund fee。</p>
<h1 id="合约代码"><a href="#合约代码" class="headerlink" title="合约代码"></a>合约代码</h1><p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;accounts_all&#x2F;fund_fee.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::states::&#123;AmmConfig, PoolState&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::associated_token::AssociatedToken;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::Token;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::Mint;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::Token2022;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::TokenAccount;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">CollectFundFee</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = creator,</span></span><br><span class="line"><span class="meta">        associated_token::mint = vault_0_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = authority,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> received_token_0_fund_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        init_if_needed,</span></span><br><span class="line"><span class="meta">        payer = creator,</span></span><br><span class="line"><span class="meta">        associated_token::mint = vault_1_mint,</span></span><br><span class="line"><span class="meta">        associated_token::authority = authority,</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> received_token_1_fund_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: pool vault and lp mint authority</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            crate::AUTH_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> authority: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> creator: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(address = pool_state.load()?.amm_config)]</span></span><br><span class="line">    <span class="keyword">pub</span> amm_config: Account&lt;<span class="symbol">&#x27;info</span>, AmmConfig&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        constraint = token_0_vault.key() == pool_state.load()?.token_0_vault</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> token_0_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        constraint = token_1_vault.key() == pool_state.load()?.token_1_vault</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> token_1_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        address = token_0_vault.mint</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> vault_0_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        address = token_1_vault.mint</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> vault_1_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">    <span class="keyword">pub</span> associated_token_program: Program&lt;<span class="symbol">&#x27;info</span>, AssociatedToken&gt;,</span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="keyword">pub</span> token_program_2022: Program&lt;<span class="symbol">&#x27;info</span>, Token2022&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;instructions&#x2F;fund_fee.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::accounts_all::*;</span><br><span class="line"><span class="keyword">use</span> crate::util::token::*;</span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提取 AMM 基金费用</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">collect_fund_fee</span>(</span><br><span class="line">    ctx: Context&lt;CollectFundFee&gt;,</span><br><span class="line">    amount_0_requested: <span class="type">u64</span>,  <span class="comment">//将要提取转移的代币的基金费用数量。</span></span><br><span class="line">    amount_1_requested: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">transfer_amount_0</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">transfer_amount_1</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">auth_bump</span>: <span class="type">u8</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pool_state</span> = ctx.accounts.pool_state.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line"></span><br><span class="line">        transfer_amount_0 = amount_0_requested.<span class="title function_ invoke__">min</span>(pool_state.fund_fees_token_0);</span><br><span class="line">        transfer_amount_1 = amount_1_requested.<span class="title function_ invoke__">min</span>(pool_state.fund_fees_token_1);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//池记录先减去要转移的资金</span></span><br><span class="line">        pool_state.fund_fees_token_0 = pool_state</span><br><span class="line">            .fund_fees_token_0</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(transfer_amount_0)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        pool_state.fund_fees_token_1 = pool_state</span><br><span class="line">            .fund_fees_token_1</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(transfer_amount_1)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        auth_bump = pool_state.auth_bump;</span><br><span class="line">        pool_state.latest_epoch = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转移token0金库的基金费用给对应基金账户</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.token_0_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.received_token_0_fund_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.vault_0_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        <span class="keyword">if</span> ctx.accounts.vault_0_mint.<span class="title function_ invoke__">to_account_info</span>().owner == ctx.accounts.token_program.key &#123;</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.accounts.token_program_2022.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        transfer_amount_0,</span><br><span class="line">        ctx.accounts.vault_0_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转移token0金库的基金费用给对应基金账户</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.token_1_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.received_token_1_fund_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.vault_1_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        <span class="keyword">if</span> ctx.accounts.vault_1_mint.<span class="title function_ invoke__">to_account_info</span>().owner == ctx.accounts.token_program.key &#123;</span><br><span class="line">            ctx.accounts.token_program.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ctx.accounts.token_program_2022.<span class="title function_ invoke__">to_account_info</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">        transfer_amount_1,</span><br><span class="line">        ctx.accounts.vault_1_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;util&#x2F;token.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    token::&#123;Token, TokenAccount&#125;,</span><br><span class="line">    token_2022::&#123;</span><br><span class="line">        <span class="keyword">self</span>,</span><br><span class="line">        spl_token_2022::&#123;</span><br><span class="line">            <span class="keyword">self</span>,</span><br><span class="line">            extension::&#123;</span><br><span class="line">                transfer_fee::&#123;TransferFeeConfig, MAX_FEE_BASIS_POINTS&#125;,</span><br><span class="line">                ExtensionType, StateWithExtensions,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    token_interface::&#123;</span><br><span class="line">        initialize_account3, spl_token_2022::extension::BaseStateWithExtensions,</span><br><span class="line">        InitializeAccount3, Mint,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MINT_WHITELIST: [&amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>; <span class="number">0</span>] = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建token账户</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_token_account</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    payer: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_account: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint_account: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    system_program: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">space</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">mint_info</span> = mint_account.<span class="title function_ invoke__">to_account_info</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> *mint_info.owner == token_2022::Token2022::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">mint_data</span> = mint_info.<span class="title function_ invoke__">try_borrow_data</span>()?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">mint_state</span> =</span><br><span class="line">                StateWithExtensions::&lt;spl_token_2022::state::Mint&gt;::<span class="title function_ invoke__">unpack</span>(&amp;mint_data)?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">mint_extensions</span> = mint_state.<span class="title function_ invoke__">get_extension_types</span>()?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">required_extensions</span> =</span><br><span class="line">                ExtensionType::<span class="title function_ invoke__">get_required_init_account_extensions</span>(&amp;mint_extensions);</span><br><span class="line">            ExtensionType::try_calculate_account_len::&lt;spl_token_2022::state::Account&gt;(</span><br><span class="line">                &amp;required_extensions,</span><br><span class="line">            )?</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            TokenAccount::LEN</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lamports</span> = Rent::<span class="title function_ invoke__">get</span>()?.<span class="title function_ invoke__">minimum_balance</span>(space);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cpi_accounts</span> = anchor_lang::system_program::CreateAccount &#123;</span><br><span class="line">        from: payer.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        to: token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cpi_context</span> = CpiContext::<span class="title function_ invoke__">new</span>(system_program.<span class="title function_ invoke__">to_account_info</span>(), cpi_accounts);</span><br><span class="line">    anchor_lang::system_program::<span class="title function_ invoke__">create_account</span>(</span><br><span class="line">        cpi_context.<span class="title function_ invoke__">with_signer</span>(signer_seeds),</span><br><span class="line">        lamports,</span><br><span class="line">        space <span class="keyword">as</span> <span class="type">u64</span>,</span><br><span class="line">        token_program.key,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">initialize_account3</span>(CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">        token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        InitializeAccount3 &#123;</span><br><span class="line">            account: token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            mint: mint_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            authority: authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        &#125;,</span><br><span class="line">    ))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从用户账户转代币到池子金库</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer_from_user_to_pool_vault</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    to_vault: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    mint_decimals: <span class="type">u8</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">    &#125;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">transfer_checked</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::TransferChecked &#123;</span><br><span class="line">                from,</span><br><span class="line">                to: to_vault,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">        mint_decimals,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从池子金库转代币到用户账户</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer_from_pool_vault_to_user</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from_vault: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    to: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    mint_decimals: <span class="type">u8</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">    &#125;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">transfer_checked</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::TransferChecked &#123;</span><br><span class="line">                from: from_vault,</span><br><span class="line">                to,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">        mint_decimals,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer_from_pool_vault_to_intermediate</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from_vault: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    to: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    mint_decimals: <span class="type">u8</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">    &#125;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">transfer_checked</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::TransferChecked &#123;</span><br><span class="line">                from: from_vault,</span><br><span class="line">                to,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">        mint_decimals,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 计算转账手续费</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_transfer_fee</span>(</span><br><span class="line">    mint_info: &amp;AccountInfo,</span><br><span class="line">    pre_user_input_transfer_amount: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u64</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//SPL Token不需要手续费，SPL Token 2022 需要</span></span><br><span class="line">    <span class="keyword">if</span> *mint_info.owner == Token::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_data</span> = mint_info.<span class="title function_ invoke__">try_borrow_data</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint</span> = StateWithExtensions::&lt;spl_token_2022::state::Mint&gt;::<span class="title function_ invoke__">unpack</span>(&amp;mint_data)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(transfer_fee_config) = mint.get_extension::&lt;TransferFeeConfig&gt;() &#123;</span><br><span class="line">        transfer_fee_config</span><br><span class="line">            .<span class="title function_ invoke__">calculate_epoch_fee</span>(Clock::<span class="title function_ invoke__">get</span>()?.epoch, pre_user_input_transfer_amount)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(fee)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算逆向手续费</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_transfer_inverse_fee</span>(</span><br><span class="line">    mint_info: &amp;AccountInfo,</span><br><span class="line">    post_fee_amount: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u64</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> *mint_info.owner == Token::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> post_fee_amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err!(ErrorCode::InvalidInput);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_data</span> = mint_info.<span class="title function_ invoke__">try_borrow_data</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint</span> = StateWithExtensions::&lt;spl_token_2022::state::Mint&gt;::<span class="title function_ invoke__">unpack</span>(&amp;mint_data)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(transfer_fee_config) = mint.get_extension::&lt;TransferFeeConfig&gt;() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">epoch</span> = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">transfer_fee</span> = transfer_fee_config.<span class="title function_ invoke__">get_epoch_fee</span>(epoch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="type">u16</span>::<span class="title function_ invoke__">from</span>(transfer_fee.transfer_fee_basis_points) == MAX_FEE_BASIS_POINTS &#123;</span><br><span class="line">            <span class="type">u64</span>::<span class="title function_ invoke__">from</span>(transfer_fee.maximum_fee)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            transfer_fee_config</span><br><span class="line">                .<span class="title function_ invoke__">calculate_inverse_epoch_fee</span>(epoch, post_fee_amount)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(fee)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查mint账户是否支持</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_supported_mint_account</span>(mint_account: &amp;InterfaceAccount&lt;Mint&gt;) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">bool</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_info</span> = mint_account.<span class="title function_ invoke__">to_account_info</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *mint_info.owner == Token::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_whitelist</span>: HashSet&lt;&amp;<span class="type">str</span>&gt; = MINT_WHITELIST.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    <span class="keyword">if</span> mint_whitelist.<span class="title function_ invoke__">contains</span>(mint_account.<span class="title function_ invoke__">key</span>().<span class="title function_ invoke__">to_string</span>().<span class="title function_ invoke__">as_str</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//铸造代币给用户</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">token_mint_to</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    destination: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">mint_to</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program,</span><br><span class="line">            token_2022::MintTo &#123;</span><br><span class="line">                to: destination,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//销毁代币</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">token_burn</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">burn</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::Burn &#123;</span><br><span class="line">                from,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;lib.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">collect_fund_fee</span>(</span><br><span class="line">        ctx: Context&lt;CollectFundFee&gt;,</span><br><span class="line">        amount_0_requested: <span class="type">u64</span>,</span><br><span class="line">        amount_1_requested: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        instructions::<span class="title function_ invoke__">collect_fund_fee</span>(ctx, amount_0_requested, amount_1_requested)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h1 id="前端测试代码"><a href="#前端测试代码" class="headerlink" title="前端测试代码"></a>前端测试代码</h1><p>anchor&#x2F;example&#x2F;api&#x2F;fund_fee.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&#x27;./wallet&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fundFeeTransfer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">transfer_amount_0</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="attr">transfer_amount_1</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token0Vault</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Vault</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [poolStatePda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">collectFundFee</span>(transfer_amount_0, transfer_amount_1)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">creator</span>: wallet.<span class="property">publicKey</span>,</span><br><span class="line">      <span class="attr">ammConfig</span>: ammConfigPda,</span><br><span class="line">      <span class="attr">poolState</span>: poolStatePda,</span><br><span class="line">      <span class="attr">token0Vault</span>: token0Vault,</span><br><span class="line">      <span class="attr">token1Vault</span>: token1Vault,</span><br><span class="line">      <span class="attr">vault0Mint</span>: token0Mint,</span><br><span class="line">      <span class="attr">vault1Mint</span>: token1Mint,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">u16ToBytes</span>(<span class="params"><span class="attr">num</span>: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(arr);</span><br><span class="line">  view.<span class="title function_">setUint16</span>(<span class="number">0</span>, num, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;example&#x2F;index.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fund_fee转移</span></span><br><span class="line">  <span class="keyword">const</span> fundfee_transfer = <span class="keyword">await</span> <span class="title function_">fundFeeTransfer</span>(</span><br><span class="line">    defaultWallet,</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">10</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">0</span>),</span><br><span class="line">    usdcDevTokenMint,</span><br><span class="line">    eurcDevTokenMint,</span><br><span class="line">    pool_state.<span class="property">token0Vault</span>,</span><br><span class="line">    pool_state.<span class="property">token1Vault</span>,</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(fundfee_transfer);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%85%AB%EF%BC%9ASwap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2025/02/16/Solana%20%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91%20-%20DeFi%20-%20Dex%20%E5%BC%80%E5%8F%91%E5%85%AB%EF%BC%9ASwap/" itemprop="url">Solana 合约开发 - DeFi - Dex 开发八：Swap</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2025-02-16T15:54:30+08:00">
                2025-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solana%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-DeFi-Dex/" itemprop="url" rel="index">
                    <span itemprop="name">Solana合约开发-DeFi-Dex</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是Swap？"><a href="#什么是Swap？" class="headerlink" title="什么是Swap？"></a>什么是Swap？</h1><p><code>Swap</code> 是指用户通过智能合约或去中心化交易平台，将一种加密货币或代币换成另一种的过程。例如你可以用 USDC换成 EURC，DEX 通常会收取一定比例的交易费（如 0.3%），这笔费用会被分配给流动性提供者。</p>
<h1 id="什么是滑点？"><a href="#什么是滑点？" class="headerlink" title="什么是滑点？"></a>什么是滑点？</h1><p>滑点是指由于市场价格波动或流动性不足，在交易执行过程中实际成交价格与用户最初设定的价格之间产生的偏差。滑点可以是正向的（实际成交价格优于预期价格）或负向的（实际成交价格低于预期价格），但在大多数情况下，滑点通常指负向滑点。<br>例如：<br>用户希望以 1 ETH 换取 2000 USDC。<br>但由于市场条件的变化，最终只换得了 1950 USDC。<br>这种价格差异就是滑点。</p>
<h2 id="滑点的成因："><a href="#滑点的成因：" class="headerlink" title="滑点的成因："></a>滑点的成因：</h2><p>(1) 流动性不足<br>在流动性较低的交易对中，大额交易会显著影响市场价格。<br>例如，在一个小规模的流动性池中，用 1 ETH 换取 USDC 可能会导致 USDC 的价格大幅上升，从而减少用户实际获得的 USDC 数量。</p>
<p>(2) 市场波动<br>如果市场价格在交易执行期间发生快速变化，也可能导致滑点。<br>例如，在高波动性市场中，用户可能无法以预期的价格完成交易。</p>
<p>(3) 大额交易<br>大额交易会对市场价格产生更大的影响，尤其是在流动性有限的情况下。<br>即使在流动性较高的池中，大额交易也可能导致显著的滑点。</p>
<p>(4) 网络延迟<br>在区块链网络中，交易需要经过打包和确认。如果市场价格在这段时间内发生变化，可能导致滑点。</p>
<h2 id="滑点容忍度（Slippage-Tolerance）"><a href="#滑点容忍度（Slippage-Tolerance）" class="headerlink" title="滑点容忍度（Slippage Tolerance）"></a>滑点容忍度（Slippage Tolerance）</h2><p>在 DEX 上进行 Swap 时，用户通常需要设置一个 滑点容忍度，这是用户愿意接受的最大滑点百分比。如果实际滑点超过这个值，交易将被取消。</p>
<p>(1) 设置滑点容忍度的意义<br>防止因市场价格剧烈波动而导致过大的损失。<br>确保交易在用户可接受的价格范围内执行。</p>
<p>(2) 默认滑点容忍度<br>大多数 DEX 的默认滑点容忍度为 0.5%，但用户可以根据实际情况调整。</p>
<p>(3) 如何设置滑点容忍度？<br>对于流动性较高的交易对，可以设置较低的滑点容忍度（如 0.1%）。<br>对于流动性较低的交易对，可能需要设置较高的滑点容忍度（如 1%-5%）。</p>
<h2 id="如何计算滑点？"><a href="#如何计算滑点？" class="headerlink" title="如何计算滑点？"></a>如何计算滑点？</h2><p>滑点 &#x3D; （预期价格 - 实际成交价格）&#x2F; 预期价格 * 100%</p>
<h1 id="合约代码："><a href="#合约代码：" class="headerlink" title="合约代码："></a>合约代码：</h1><p>anchor&#x2F;programs&#x2F;iswap&#x2F;src&#x2F;accounts_all&#x2F;swap.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token::Token;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::token_interface::&#123;Mint, TokenAccount, TokenInterface&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::*;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Accounts)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Swap</span>&lt;<span class="symbol">&#x27;info</span>&gt; &#123;</span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> payer: Signer&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// CHECK: pool vault  authority</span></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        seeds = [</span></span><br><span class="line"><span class="meta">            crate::AUTH_SEED.as_bytes(),</span></span><br><span class="line"><span class="meta">        ]</span>,</span><br><span class="line">        bump,</span><br><span class="line">    )]</span><br><span class="line">    <span class="keyword">pub</span> authority: UncheckedAccount&lt;<span class="symbol">&#x27;info</span>&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, PoolState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(address = pool_state.load()?.amm_config)]</span></span><br><span class="line">    <span class="keyword">pub</span> amm_config: Account&lt;<span class="symbol">&#x27;info</span>, AmmConfig&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> user_input_token_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut)]</span></span><br><span class="line">    <span class="keyword">pub</span> user_output_token_account: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        constraint = pool_input_vault.key() == pool_state.load()?.token_0_vault || pool_input_vault.key() == pool_state.load()?.token_1_vault</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_input_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        mut,</span></span><br><span class="line"><span class="meta">        constraint = pool_output_vault.key() == pool_state.load()?.token_0_vault || pool_output_vault.key() == pool_state.load()?.token_1_vault</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_output_vault: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, TokenAccount&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> input_token_program: Interface&lt;<span class="symbol">&#x27;info</span>, TokenInterface&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> output_token_program: Interface&lt;<span class="symbol">&#x27;info</span>, TokenInterface&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        address = pool_input_vault.mint</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> input_token_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(</span></span><br><span class="line"><span class="meta">        address = pool_output_vault.mint</span></span><br><span class="line"><span class="meta">    )]</span></span><br><span class="line">    <span class="keyword">pub</span> output_token_mint: <span class="type">Box</span>&lt;InterfaceAccount&lt;<span class="symbol">&#x27;info</span>, Mint&gt;&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[account(mut, address = pool_state.load()?.observation_key)]</span></span><br><span class="line">    <span class="keyword">pub</span> observation_state: AccountLoader&lt;<span class="symbol">&#x27;info</span>, ObservationState&gt;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> system_program: Program&lt;<span class="symbol">&#x27;info</span>, System&gt;,</span><br><span class="line">    <span class="comment">//pub token_program_2022: Program&lt;&#x27;info, Token2022&gt;,</span></span><br><span class="line">    <span class="keyword">pub</span> token_program: Program&lt;<span class="symbol">&#x27;info</span>, Token&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;calculate&#x2F;calculator.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::calculate::fee::*;</span><br><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> crate::util::math::*;</span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">//价格阈值</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PRICE_THRESHOLD: <span class="type">u128</span> = <span class="number">100_000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// ConstantProductCurve struct implementing CurveCalculator</span></span><br><span class="line"><span class="meta">#[derive(Clone, Debug, Default, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ConstantProductCurve</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">SwapDirection</span> &#123;</span><br><span class="line">    <span class="comment">/// Input token 0, output token 1</span></span><br><span class="line">    ZeroForOne,</span><br><span class="line">    <span class="comment">/// Input token 1, output token 0</span></span><br><span class="line">    OneForZero,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Direction</span> &#123;</span><br><span class="line">    <span class="comment">//向下取整</span></span><br><span class="line">    Floor,</span><br><span class="line">    <span class="comment">//向上取整</span></span><br><span class="line">    Ceiling,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Calculator</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TradingTokenResult</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> ouput_token_0_amount: <span class="type">u128</span>,</span><br><span class="line">    <span class="keyword">pub</span> ouput_token_1_amount: <span class="type">u128</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//swap后各代币数量</span></span><br><span class="line"><span class="meta">#[derive(Debug, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SwapResult</span> &#123;</span><br><span class="line">    <span class="comment">//交换后池中源代币数量</span></span><br><span class="line">    <span class="keyword">pub</span> new_swap_source_amount: <span class="type">u128</span>,</span><br><span class="line">    <span class="comment">//交换后池中目标代币数量</span></span><br><span class="line">    <span class="keyword">pub</span> new_swap_destination_amount: <span class="type">u128</span>,</span><br><span class="line">    <span class="comment">//实际交换的源代币数量</span></span><br><span class="line">    <span class="keyword">pub</span> source_amount_swapped: <span class="type">u128</span>,</span><br><span class="line">    <span class="comment">//用户从池中获得的目标代币数量</span></span><br><span class="line">    <span class="keyword">pub</span> destination_amount_swapped: <span class="type">u128</span>,</span><br><span class="line">    <span class="comment">//手续费</span></span><br><span class="line">    <span class="keyword">pub</span> trade_fee: <span class="type">u128</span>,</span><br><span class="line">    <span class="comment">//协议费用</span></span><br><span class="line">    <span class="keyword">pub</span> protocol_fee: <span class="type">u128</span>,</span><br><span class="line">    <span class="comment">//基金费用</span></span><br><span class="line">    <span class="keyword">pub</span> fund_fee: <span class="type">u128</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Calculator</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validate_supply</span>(token_0_amount: <span class="type">u64</span>, token_1_amount: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> token_0_amount == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ErrorCode::EmptySupply.<span class="title function_ invoke__">into</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> token_1_amount == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ErrorCode::EmptySupply.<span class="title function_ invoke__">into</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lp_tokens_to_trading_tokens</span>(</span><br><span class="line">        lp_token_swap_amount: <span class="type">u128</span>, <span class="comment">//用户期望转换的LP代币数量。</span></span><br><span class="line">        lp_token_pool_supply: <span class="type">u128</span>, <span class="comment">//当前池中的总LP代币供应量。</span></span><br><span class="line">        pool_token_0_amount: <span class="type">u128</span>,  <span class="comment">//池中代币A的数量。</span></span><br><span class="line">        pool_token_1_amount: <span class="type">u128</span>,  <span class="comment">//池中代币B的数量。</span></span><br><span class="line">        direction: Direction,       <span class="comment">//取整方向</span></span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;TradingTokenResult&gt; &#123;</span><br><span class="line">        <span class="comment">// LP代币数量 = (存入代币量 * 总LP供应量) / 池中代币总量</span></span><br><span class="line">        <span class="comment">// 池中有 1000 个 LP 代币。</span></span><br><span class="line">        <span class="comment">// 池中有 10000 个代币 A 和 20000 个代币 B。</span></span><br><span class="line">        <span class="comment">// 用户希望获得 100 个 LP 代币。</span></span><br><span class="line">        <span class="comment">// output_token_0_amount = (100 * 10000) / 1000 = 1000</span></span><br><span class="line">        <span class="comment">// output_token_1_amount = (100 * 20000) / 1000 = 2000</span></span><br><span class="line">        <span class="comment">// 用户需要存入 1000 个代币 A 和 2000 个代币 B，才能获得 100 个 LP 代币。</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ouput_token_0_amount</span> = lp_token_swap_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_mul</span>(pool_token_0_amount)?</span><br><span class="line">            .<span class="title function_ invoke__">checked_div</span>(lp_token_pool_supply)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ouput_token_1_amount</span> = lp_token_swap_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_mul</span>(pool_token_1_amount)?</span><br><span class="line">            .<span class="title function_ invoke__">checked_div</span>(lp_token_pool_supply)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> (ouput_token_0_amount, ouput_token_1_amount) = <span class="keyword">match</span> direction &#123;</span><br><span class="line">            Direction::Floor =&gt; (ouput_token_0_amount, ouput_token_1_amount),</span><br><span class="line"></span><br><span class="line">            Direction::Ceiling =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">token_0_remainder</span> = lp_token_swap_amount</span><br><span class="line">                    .<span class="title function_ invoke__">checked_mul</span>(pool_token_0_amount)?</span><br><span class="line">                    .<span class="title function_ invoke__">checked_rem</span>(lp_token_pool_supply)?;</span><br><span class="line">                <span class="keyword">if</span> token_0_remainder &gt; <span class="number">0</span> &amp;&amp; ouput_token_0_amount &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    ouput_token_0_amount += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">token_1_remainder</span> = lp_token_swap_amount</span><br><span class="line">                    .<span class="title function_ invoke__">checked_mul</span>(pool_token_1_amount)?</span><br><span class="line">                    .<span class="title function_ invoke__">checked_rem</span>(lp_token_pool_supply)?;</span><br><span class="line">                <span class="keyword">if</span> token_1_remainder &gt; <span class="number">0</span> &amp;&amp; ouput_token_1_amount &gt; <span class="number">0</span> &#123;</span><br><span class="line">                    ouput_token_1_amount += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                (ouput_token_0_amount, ouput_token_1_amount)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(TradingTokenResult &#123;</span><br><span class="line">            ouput_token_0_amount,</span><br><span class="line">            ouput_token_1_amount,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检验乘积价格和预言机价格差异</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">verify_curve_and_oracle_price</span>(oracle_price: <span class="type">u64</span>, amount_received: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">bool</span>&gt; &#123;</span><br><span class="line">        msg!(<span class="string">&quot;AMM Price: &#123;&#125;&quot;</span>, amount_received);</span><br><span class="line">        msg!(<span class="string">&quot;Oracle Price: &#123;&#125;&quot;</span>, oracle_price);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 比较两者的差异</span></span><br><span class="line">        <span class="keyword">if</span> (amount_received <span class="keyword">as</span> <span class="type">i128</span> - oracle_price <span class="keyword">as</span> <span class="type">i128</span>).<span class="title function_ invoke__">abs</span>() <span class="keyword">as</span> <span class="type">u128</span> &gt; PRICE_THRESHOLD &#123;</span><br><span class="line">            msg!(<span class="string">&quot;Price deviation is too large, stopping trade&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_base_input_without_fees</span>(</span><br><span class="line">        source_amount: <span class="type">u128</span>,</span><br><span class="line">        swap_source_amount: <span class="type">u128</span>,</span><br><span class="line">        swap_destination_amount: <span class="type">u128</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">u128</span> &#123;</span><br><span class="line">        <span class="comment">//计算分子，用户希望交换的源代币数量 * 池中目标代币的总数量</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">numerator</span> = source_amount.<span class="title function_ invoke__">checked_mul</span>(swap_destination_amount).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算分母，池中源代币的总数量 + 用户希望交换的源代币数量</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">denominator</span> = swap_source_amount.<span class="title function_ invoke__">checked_add</span>(source_amount).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算输出的代币数量, numerator/denominator</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">destinsation_amount_swapped</span> = numerator.<span class="title function_ invoke__">checked_div</span>(denominator).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        destinsation_amount_swapped</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_base_output_without_fees</span>(</span><br><span class="line">        destinsation_amount: <span class="type">u128</span>,</span><br><span class="line">        swap_source_amount: <span class="type">u128</span>,</span><br><span class="line">        swap_destination_amount: <span class="type">u128</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">u128</span> &#123;</span><br><span class="line">        <span class="comment">// (x + delta_x) * (y - delta_y) = x * y</span></span><br><span class="line">        <span class="comment">// delta_x = (x * delta_y) / (y - delta_y)</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">numerator</span> = swap_source_amount.<span class="title function_ invoke__">checked_mul</span>(destinsation_amount).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">denominator</span> = swap_destination_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(destinsation_amount)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> (source_amount_swapped, _) = numerator.<span class="title function_ invoke__">checked_ceil_div</span>(denominator).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        source_amount_swapped</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据输入计算输出</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_input</span>(</span><br><span class="line">        source_amount: <span class="type">u128</span>,           <span class="comment">//输入的源代币数量（用户希望交换的数量）。</span></span><br><span class="line">        swap_source_amount: <span class="type">u128</span>,      <span class="comment">//当前池中源代币的总数量。</span></span><br><span class="line">        swap_destination_amount: <span class="type">u128</span>, <span class="comment">//当前池中目标代币的总数量。</span></span><br><span class="line">        trade_fee_rate: <span class="type">u64</span>,           <span class="comment">//交易费用率。</span></span><br><span class="line">        protocol_fee_rate: <span class="type">u64</span>,        <span class="comment">//协议费用率。</span></span><br><span class="line">        fund_fee_rate: <span class="type">u64</span>,            <span class="comment">//基金费用率。</span></span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;SwapResult&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">trade_fee</span> = Fee::<span class="title function_ invoke__">trading_fee</span>(source_amount, trade_fee_rate)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">protocol_fee</span> = Fee::<span class="title function_ invoke__">protocol_fee</span>(trade_fee, protocol_fee_rate)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">fund_fee</span> = Fee::<span class="title function_ invoke__">fund_fee</span>(trade_fee, fund_fee_rate)?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算扣除手续费后的源代币数量,输入的源代币数量（用户希望交换的数量）- 交易费用</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">source_amount_less_fees</span> = source_amount.<span class="title function_ invoke__">checked_sub</span>(trade_fee)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">destination_amount_swapped</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">swap_base_input_without_fees</span>(</span><br><span class="line">            source_amount_less_fees,</span><br><span class="line">            swap_source_amount,</span><br><span class="line">            swap_destination_amount,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(SwapResult &#123;</span><br><span class="line">            new_swap_source_amount: swap_source_amount.<span class="title function_ invoke__">checked_add</span>(source_amount)?,</span><br><span class="line">            new_swap_destination_amount: swap_destination_amount</span><br><span class="line">                .<span class="title function_ invoke__">checked_sub</span>(destination_amount_swapped)?,</span><br><span class="line">            source_amount_swapped: source_amount,</span><br><span class="line">            destination_amount_swapped,</span><br><span class="line">            trade_fee,</span><br><span class="line">            protocol_fee,</span><br><span class="line">            fund_fee,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_output</span>(</span><br><span class="line">        destinsation_amount: <span class="type">u128</span>,</span><br><span class="line">        swap_source_amount: <span class="type">u128</span>,</span><br><span class="line">        swap_destination_amount: <span class="type">u128</span>,</span><br><span class="line">        trade_fee_rate: <span class="type">u64</span>,</span><br><span class="line">        protocol_fee_rate: <span class="type">u64</span>,</span><br><span class="line">        fund_fee_rate: <span class="type">u64</span>,</span><br><span class="line">    ) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;SwapResult&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">source_amount_swapped</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">swap_base_output_without_fees</span>(</span><br><span class="line">            destinsation_amount,</span><br><span class="line">            swap_source_amount,</span><br><span class="line">            swap_destination_amount,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">source_amount</span> =</span><br><span class="line">            Fee::<span class="title function_ invoke__">calculate_pre_fee_amount</span>(source_amount_swapped, trade_fee_rate).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">trade_fee</span> = Fee::<span class="title function_ invoke__">trading_fee</span>(source_amount, trade_fee_rate)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">protocol_fee</span> = Fee::<span class="title function_ invoke__">protocol_fee</span>(trade_fee, protocol_fee_rate)?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">fund_fee</span> = Fee::<span class="title function_ invoke__">fund_fee</span>(trade_fee, fund_fee_rate)?;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Some</span>(SwapResult &#123;</span><br><span class="line">            new_swap_source_amount: swap_source_amount.<span class="title function_ invoke__">checked_add</span>(source_amount)?,</span><br><span class="line">            new_swap_destination_amount: swap_destination_amount</span><br><span class="line">                .<span class="title function_ invoke__">checked_sub</span>(destinsation_amount)?,</span><br><span class="line">            source_amount_swapped: source_amount,</span><br><span class="line">            destination_amount_swapped: destinsation_amount,</span><br><span class="line">            trade_fee,</span><br><span class="line">            protocol_fee,</span><br><span class="line">            fund_fee,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;util&#x2F;math.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// U128 比 u128更高效</span></span><br><span class="line"><span class="comment">/// https://github.com/solana-labs/solana/issues/19549</span></span><br><span class="line"><span class="keyword">use</span> uint::construct_uint;</span><br><span class="line">construct_uint! &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">U128</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">construct_uint! &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">U256</span>(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">CheckedCeilDiv</span>: <span class="built_in">Sized</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">checked_ceil_div</span>(&amp;<span class="keyword">self</span>, rhs: <span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;(<span class="keyword">Self</span>, <span class="keyword">Self</span>)&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">CheckedCeilDiv</span> <span class="keyword">for</span> <span class="title class_">u128</span> &#123;</span><br><span class="line">    <span class="comment">//实现一种安全且精确的向上取整除法操作</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">checked_ceil_div</span>(&amp;<span class="keyword">self</span>, <span class="keyword">mut</span> rhs: <span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;(<span class="keyword">Self</span>, <span class="keyword">Self</span>)&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">quotient</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">checked_div</span>(rhs)?;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> quotient == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="comment">// return None;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">checked_mul</span>(<span class="number">2</span> <span class="keyword">as</span> <span class="type">u128</span>)? &gt;= rhs &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>((<span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>((<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">remainder</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">checked_rem</span>(rhs)?;</span><br><span class="line">        <span class="keyword">if</span> remainder &gt; <span class="number">0</span> &#123;</span><br><span class="line">            quotient = quotient.<span class="title function_ invoke__">checked_add</span>(<span class="number">1</span>)?;</span><br><span class="line"></span><br><span class="line">            rhs = <span class="keyword">self</span>.<span class="title function_ invoke__">checked_div</span>(quotient)?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">remainder</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">checked_rem</span>(quotient)?;</span><br><span class="line">            <span class="keyword">if</span> remainder &gt; <span class="number">0</span> &#123;</span><br><span class="line">                rhs = rhs.<span class="title function_ invoke__">checked_add</span>(<span class="number">1</span>)?;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>((quotient, rhs))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;iswap&#x2F;src&#x2F;calculate&#x2F;fee.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::states::AmmConfig;</span><br><span class="line"><span class="comment">//向上取整</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">ceil_div</span>(token_amount: <span class="type">u128</span>, fee_numerator: <span class="type">u128</span>, fee_denominator: <span class="type">u128</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u128</span>&gt; &#123;</span><br><span class="line">    token_amount</span><br><span class="line">        .<span class="title function_ invoke__">checked_mul</span>(<span class="type">u128</span>::<span class="title function_ invoke__">from</span>(fee_numerator))</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        .<span class="title function_ invoke__">checked_add</span>(fee_denominator)?</span><br><span class="line">        .<span class="title function_ invoke__">checked_sub</span>(<span class="number">1</span>)?</span><br><span class="line">        .<span class="title function_ invoke__">checked_div</span>(fee_denominator)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//向下取整</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">floor_div</span>(token_amount: <span class="type">u128</span>, fee_numerator: <span class="type">u128</span>, fee_denominator: <span class="type">u128</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u128</span>&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(</span><br><span class="line">        token_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_mul</span>(fee_numerator)?</span><br><span class="line">            .<span class="title function_ invoke__">checked_div</span>(fee_denominator)?,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Fee</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Fee</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">trading_fee</span>(amount: <span class="type">u128</span>, trade_fee_rate: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u128</span>&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">ceil_div</span>(</span><br><span class="line">            amount,</span><br><span class="line">            <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(trade_fee_rate),</span><br><span class="line">            <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(AmmConfig::FEE_RATE_VALUE),</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">protocol_fee</span>(amount: <span class="type">u128</span>, protocol_fee_rate: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u128</span>&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">floor_div</span>(</span><br><span class="line">            amount,</span><br><span class="line">            <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(protocol_fee_rate),</span><br><span class="line">            <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(AmmConfig::FEE_RATE_VALUE),</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">fund_fee</span>(amount: <span class="type">u128</span>, fund_fee_rate: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u128</span>&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">floor_div</span>(</span><br><span class="line">            amount,</span><br><span class="line">            <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(fund_fee_rate),</span><br><span class="line">            <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(AmmConfig::FEE_RATE_VALUE),</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_pre_fee_amount</span>(post_fee_amount: <span class="type">u128</span>, trade_fee_rate: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u128</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> trade_fee_rate == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(post_fee_amount)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">numerator</span> = post_fee_amount.<span class="title function_ invoke__">checked_mul</span>(<span class="type">u128</span>::<span class="title function_ invoke__">from</span>(AmmConfig::FEE_RATE_VALUE))?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">denominator</span> =</span><br><span class="line">                <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(AmmConfig::FEE_RATE_VALUE).<span class="title function_ invoke__">checked_sub</span>(<span class="type">u128</span>::<span class="title function_ invoke__">from</span>(trade_fee_rate))?;</span><br><span class="line"></span><br><span class="line">            numerator</span><br><span class="line">                .<span class="title function_ invoke__">checked_add</span>(denominator)?</span><br><span class="line">                .<span class="title function_ invoke__">checked_sub</span>(<span class="number">1</span>)?</span><br><span class="line">                .<span class="title function_ invoke__">checked_div</span>(denominator)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;iswap&#x2F;src&#x2F;states&#x2F;events.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[event]</span></span><br><span class="line"><span class="meta">#[cfg_attr(feature = <span class="string">&quot;client&quot;</span>, derive(Debug))]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LpChangeEvent</span> &#123;</span><br><span class="line">    <span class="meta">#[index]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_id: Pubkey,</span><br><span class="line">    <span class="keyword">pub</span> lp_amount_before: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">/// pool vault sub trade fees</span></span><br><span class="line">    <span class="keyword">pub</span> token_0_vault_before: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">/// pool vault sub trade fees</span></span><br><span class="line">    <span class="keyword">pub</span> token_1_vault_before: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">/// cacluate result without transfer fee</span></span><br><span class="line">    <span class="keyword">pub</span> token_0_amount: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">/// cacluate result without transfer fee</span></span><br><span class="line">    <span class="keyword">pub</span> token_1_amount: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> token_0_transfer_fee: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> token_1_transfer_fee: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">// 0: deposit, 1: withdraw</span></span><br><span class="line">    <span class="keyword">pub</span> change_type: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[event]</span></span><br><span class="line"><span class="meta">#[cfg_attr(feature = <span class="string">&quot;client&quot;</span>, derive(Debug))]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SwapEvent</span> &#123;</span><br><span class="line">    <span class="meta">#[index]</span></span><br><span class="line">    <span class="keyword">pub</span> pool_id: Pubkey,</span><br><span class="line">    <span class="comment">/// pool vault sub trade fees</span></span><br><span class="line">    <span class="keyword">pub</span> input_vault_before: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">/// pool vault sub trade fees</span></span><br><span class="line">    <span class="keyword">pub</span> output_vault_before: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">/// cacluate result without transfer fee</span></span><br><span class="line">    <span class="keyword">pub</span> input_amount: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">/// cacluate result without transfer fee</span></span><br><span class="line">    <span class="keyword">pub</span> output_amount: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> input_transfer_fee: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> output_transfer_fee: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> base_input: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PriceResult</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> price_0: <span class="type">u128</span>,</span><br><span class="line">    <span class="keyword">pub</span> price_1: <span class="type">u128</span>,</span><br><span class="line">    <span class="keyword">pub</span> timestamp: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> confidence: <span class="type">u64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> OBSERVATION_SEED: &amp;<span class="type">str</span> = <span class="string">&quot;observation&quot;</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> OBSERVATION_NUM: <span class="type">usize</span> = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> OBSERVATION_UPDATE_DURATION_DEFAULT: <span class="type">u64</span> = <span class="number">15</span>;</span><br><span class="line"><span class="meta">#[account]</span></span><br><span class="line"><span class="meta">#[derive(InitSpace, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PriceAccount</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> price: <span class="type">i64</span>,</span><br><span class="line">    <span class="keyword">pub</span> conf: <span class="type">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> exponent: <span class="type">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> last_updated: <span class="type">i64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[zero_copy(unsafe)]</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="meta">#[derive(Default, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Observation</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> block_timestamp: <span class="type">u64</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> cumulative_token_0_price_x32: <span class="type">u128</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> cumulative_token_1_price_x32: <span class="type">u128</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Observation</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> LEN: <span class="type">usize</span> = <span class="number">8</span> + <span class="number">16</span> + <span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[account(zero_copy(unsafe))]</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="meta">#[cfg_attr(feature = <span class="string">&quot;client&quot;</span>, derive(Debug))]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ObservationState</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> initialized: <span class="type">bool</span>,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> observation_index: <span class="type">u16</span>,</span><br><span class="line">    <span class="keyword">pub</span> pool_id: Pubkey,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> observations: [Observation; OBSERVATION_NUM],</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> padding: [<span class="type">u64</span>; <span class="number">4</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Default</span> <span class="keyword">for</span> <span class="title class_">ObservationState</span> &#123;</span><br><span class="line">    <span class="meta">#[inline]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">default</span>() <span class="punctuation">-&gt;</span> ObservationState &#123;</span><br><span class="line">        ObservationState &#123;</span><br><span class="line">            initialized: <span class="literal">false</span>,</span><br><span class="line">            observation_index: <span class="number">0</span>,</span><br><span class="line">            pool_id: Pubkey::<span class="title function_ invoke__">default</span>(),</span><br><span class="line">            observations: [Observation::<span class="title function_ invoke__">default</span>(); OBSERVATION_NUM],</span><br><span class="line">            padding: [<span class="number">0u64</span>; <span class="number">4</span>],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ObservationState</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> LEN: <span class="type">usize</span> = <span class="number">8</span> + <span class="number">1</span> + <span class="number">2</span> + <span class="number">32</span> + (Observation::LEN * OBSERVATION_NUM) + <span class="number">8</span> * <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">update</span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        block_timestamp: <span class="type">u64</span>,</span><br><span class="line">        token_0_price_x32: <span class="type">u128</span>,</span><br><span class="line">        token_1_price_x32: <span class="type">u128</span>,</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">observation_index</span> = <span class="keyword">self</span>.observation_index;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.initialized &#123;</span><br><span class="line">            <span class="comment">// skip the pool init price</span></span><br><span class="line">            <span class="keyword">self</span>.initialized = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">self</span>.observations[observation_index <span class="keyword">as</span> <span class="type">usize</span>].block_timestamp = block_timestamp;</span><br><span class="line">            <span class="keyword">self</span>.observations[observation_index <span class="keyword">as</span> <span class="type">usize</span>].cumulative_token_0_price_x32 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">self</span>.observations[observation_index <span class="keyword">as</span> <span class="type">usize</span>].cumulative_token_1_price_x32 = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">last_observation</span> = <span class="keyword">self</span>.observations[observation_index <span class="keyword">as</span> <span class="type">usize</span>];</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">delta_time</span> = block_timestamp.<span class="title function_ invoke__">saturating_sub</span>(last_observation.block_timestamp);</span><br><span class="line">            <span class="keyword">if</span> delta_time &lt; OBSERVATION_UPDATE_DURATION_DEFAULT &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">delta_token_0_price_x32</span> = token_0_price_x32.<span class="title function_ invoke__">checked_mul</span>(delta_time.<span class="title function_ invoke__">into</span>()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">delta_token_1_price_x32</span> = token_1_price_x32.<span class="title function_ invoke__">checked_mul</span>(delta_time.<span class="title function_ invoke__">into</span>()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">next_observation_index</span> = <span class="keyword">if</span> observation_index <span class="keyword">as</span> <span class="type">usize</span> == OBSERVATION_NUM - <span class="number">1</span> &#123;</span><br><span class="line">                <span class="number">0</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                observation_index + <span class="number">1</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">self</span>.observations[next_observation_index <span class="keyword">as</span> <span class="type">usize</span>].block_timestamp = block_timestamp;</span><br><span class="line">            <span class="comment">// cumulative_token_price_x32 only occupies the first 64 bits, and the remaining 64 bits are used to store overflow data</span></span><br><span class="line">            <span class="keyword">self</span>.observations[next_observation_index <span class="keyword">as</span> <span class="type">usize</span>].cumulative_token_0_price_x32 =</span><br><span class="line">                last_observation</span><br><span class="line">                    .cumulative_token_0_price_x32</span><br><span class="line">                    .<span class="title function_ invoke__">wrapping_add</span>(delta_token_0_price_x32);</span><br><span class="line">            <span class="keyword">self</span>.observations[next_observation_index <span class="keyword">as</span> <span class="type">usize</span>].cumulative_token_1_price_x32 =</span><br><span class="line">                last_observation</span><br><span class="line">                    .cumulative_token_1_price_x32</span><br><span class="line">                    .<span class="title function_ invoke__">wrapping_add</span>(delta_token_1_price_x32);</span><br><span class="line">            <span class="keyword">self</span>.observation_index = next_observation_index;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_price</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;PriceResult&gt; &#123;</span><br><span class="line">        <span class="comment">// 获取最新和上一次观测数据的索引</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">latest_index</span> = <span class="keyword">self</span>.observation_index <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">previous_index</span> = <span class="keyword">if</span> latest_index == <span class="number">0</span> &#123;</span><br><span class="line">            OBSERVATION_NUM - <span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            latest_index - <span class="number">1</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取观测数据</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">latest_observation</span> = &amp;<span class="keyword">self</span>.observations[latest_index];</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">previous_observation</span> = &amp;<span class="keyword">self</span>.observations[previous_index];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算时间差</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">delta_time</span> = latest_observation</span><br><span class="line">            .block_timestamp</span><br><span class="line">            .<span class="title function_ invoke__">saturating_sub</span>(previous_observation.block_timestamp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> delta_time == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ErrorCode::NoPriceAvailable.<span class="title function_ invoke__">into</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算token0价格</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">price_0</span> = latest_observation</span><br><span class="line">            .cumulative_token_0_price_x32</span><br><span class="line">            .<span class="title function_ invoke__">wrapping_sub</span>(previous_observation.cumulative_token_0_price_x32)</span><br><span class="line">            .<span class="title function_ invoke__">checked_div</span>(delta_time <span class="keyword">as</span> <span class="type">u128</span>)</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(ErrorCode::CalculationOverflow)?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算token1价格</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">price_1</span> = latest_observation</span><br><span class="line">            .cumulative_token_1_price_x32</span><br><span class="line">            .<span class="title function_ invoke__">wrapping_sub</span>(previous_observation.cumulative_token_1_price_x32)</span><br><span class="line">            .<span class="title function_ invoke__">checked_div</span>(delta_time <span class="keyword">as</span> <span class="type">u128</span>)</span><br><span class="line">            .<span class="title function_ invoke__">ok_or</span>(ErrorCode::CalculationOverflow)?;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(PriceResult &#123;</span><br><span class="line">            price_0,</span><br><span class="line">            price_1,</span><br><span class="line">            timestamp: latest_observation.block_timestamp,</span><br><span class="line">            confidence: delta_time, <span class="comment">// 使用时间差作为置信度指标</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">block_timestamp</span>() <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    Clock::<span class="title function_ invoke__">get</span>().<span class="title function_ invoke__">unwrap</span>().unix_timestamp <span class="keyword">as</span> <span class="type">u64</span> <span class="comment">// truncation is desired</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;util&#x2F;token.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"><span class="keyword">use</span> anchor_spl::&#123;</span><br><span class="line">    token::&#123;Token, TokenAccount&#125;,</span><br><span class="line">    token_2022::&#123;</span><br><span class="line">        <span class="keyword">self</span>,</span><br><span class="line">        spl_token_2022::&#123;</span><br><span class="line">            <span class="keyword">self</span>,</span><br><span class="line">            extension::&#123;</span><br><span class="line">                transfer_fee::&#123;TransferFeeConfig, MAX_FEE_BASIS_POINTS&#125;,</span><br><span class="line">                ExtensionType, StateWithExtensions,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    token_interface::&#123;</span><br><span class="line">        initialize_account3, spl_token_2022::extension::BaseStateWithExtensions,</span><br><span class="line">        InitializeAccount3, Mint,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MINT_WHITELIST: [&amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>; <span class="number">0</span>] = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建token账户</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_token_account</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    payer: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_account: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint_account: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    system_program: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: &amp;AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">space</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">mint_info</span> = mint_account.<span class="title function_ invoke__">to_account_info</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> *mint_info.owner == token_2022::Token2022::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">mint_data</span> = mint_info.<span class="title function_ invoke__">try_borrow_data</span>()?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">mint_state</span> =</span><br><span class="line">                StateWithExtensions::&lt;spl_token_2022::state::Mint&gt;::<span class="title function_ invoke__">unpack</span>(&amp;mint_data)?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">mint_extensions</span> = mint_state.<span class="title function_ invoke__">get_extension_types</span>()?;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">required_extensions</span> =</span><br><span class="line">                ExtensionType::<span class="title function_ invoke__">get_required_init_account_extensions</span>(&amp;mint_extensions);</span><br><span class="line">            ExtensionType::try_calculate_account_len::&lt;spl_token_2022::state::Account&gt;(</span><br><span class="line">                &amp;required_extensions,</span><br><span class="line">            )?</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            TokenAccount::LEN</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">lamports</span> = Rent::<span class="title function_ invoke__">get</span>()?.<span class="title function_ invoke__">minimum_balance</span>(space);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cpi_accounts</span> = anchor_lang::system_program::CreateAccount &#123;</span><br><span class="line">        from: payer.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        to: token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cpi_context</span> = CpiContext::<span class="title function_ invoke__">new</span>(system_program.<span class="title function_ invoke__">to_account_info</span>(), cpi_accounts);</span><br><span class="line">    anchor_lang::system_program::<span class="title function_ invoke__">create_account</span>(</span><br><span class="line">        cpi_context.<span class="title function_ invoke__">with_signer</span>(signer_seeds),</span><br><span class="line">        lamports,</span><br><span class="line">        space <span class="keyword">as</span> <span class="type">u64</span>,</span><br><span class="line">        token_program.key,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">initialize_account3</span>(CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">        token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        InitializeAccount3 &#123;</span><br><span class="line">            account: token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            mint: mint_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            authority: authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        &#125;,</span><br><span class="line">    ))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从用户账户转代币到池子金库</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer_from_user_to_pool_vault</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    to_vault: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    mint_decimals: <span class="type">u8</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">    &#125;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">transfer_checked</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::TransferChecked &#123;</span><br><span class="line">                from,</span><br><span class="line">                to: to_vault,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">        mint_decimals,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从池子金库转代币到用户账户</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer_from_pool_vault_to_user</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from_vault: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    to: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    mint_decimals: <span class="type">u8</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">    &#125;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">transfer_checked</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::TransferChecked &#123;</span><br><span class="line">                from: from_vault,</span><br><span class="line">                to,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">        mint_decimals,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">transfer_from_pool_vault_to_intermediate</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from_vault: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    to: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    mint_decimals: <span class="type">u8</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(());</span><br><span class="line">    &#125;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">transfer_checked</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::TransferChecked &#123;</span><br><span class="line">                from: from_vault,</span><br><span class="line">                to,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">        mint_decimals,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 计算转账手续费</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_transfer_fee</span>(</span><br><span class="line">    mint_info: &amp;AccountInfo,</span><br><span class="line">    pre_user_input_transfer_amount: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u64</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//SPL Token不需要手续费，SPL Token 2022 需要</span></span><br><span class="line">    <span class="keyword">if</span> *mint_info.owner == Token::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_data</span> = mint_info.<span class="title function_ invoke__">try_borrow_data</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint</span> = StateWithExtensions::&lt;spl_token_2022::state::Mint&gt;::<span class="title function_ invoke__">unpack</span>(&amp;mint_data)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(transfer_fee_config) = mint.get_extension::&lt;TransferFeeConfig&gt;() &#123;</span><br><span class="line">        transfer_fee_config</span><br><span class="line">            .<span class="title function_ invoke__">calculate_epoch_fee</span>(Clock::<span class="title function_ invoke__">get</span>()?.epoch, pre_user_input_transfer_amount)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(fee)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算逆向手续费</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">calculate_transfer_inverse_fee</span>(</span><br><span class="line">    mint_info: &amp;AccountInfo,</span><br><span class="line">    post_fee_amount: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u64</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> *mint_info.owner == Token::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> post_fee_amount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err!(ErrorCode::InvalidInput);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_data</span> = mint_info.<span class="title function_ invoke__">try_borrow_data</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint</span> = StateWithExtensions::&lt;spl_token_2022::state::Mint&gt;::<span class="title function_ invoke__">unpack</span>(&amp;mint_data)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fee</span> = <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(transfer_fee_config) = mint.get_extension::&lt;TransferFeeConfig&gt;() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">epoch</span> = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">transfer_fee</span> = transfer_fee_config.<span class="title function_ invoke__">get_epoch_fee</span>(epoch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="type">u16</span>::<span class="title function_ invoke__">from</span>(transfer_fee.transfer_fee_basis_points) == MAX_FEE_BASIS_POINTS &#123;</span><br><span class="line">            <span class="type">u64</span>::<span class="title function_ invoke__">from</span>(transfer_fee.maximum_fee)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            transfer_fee_config</span><br><span class="line">                .<span class="title function_ invoke__">calculate_inverse_epoch_fee</span>(epoch, post_fee_amount)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(fee)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查mint账户是否支持</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">is_supported_mint_account</span>(mint_account: &amp;InterfaceAccount&lt;Mint&gt;) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">bool</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_info</span> = mint_account.<span class="title function_ invoke__">to_account_info</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> *mint_info.owner == Token::<span class="title function_ invoke__">id</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mint_whitelist</span>: HashSet&lt;&amp;<span class="type">str</span>&gt; = MINT_WHITELIST.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    <span class="keyword">if</span> mint_whitelist.<span class="title function_ invoke__">contains</span>(mint_account.<span class="title function_ invoke__">key</span>().<span class="title function_ invoke__">to_string</span>().<span class="title function_ invoke__">as_str</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//铸造代币给用户</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">token_mint_to</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    destination: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">mint_to</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program,</span><br><span class="line">            token_2022::MintTo &#123;</span><br><span class="line">                to: destination,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//销毁代币</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">token_burn</span>&lt;<span class="symbol">&#x27;a</span>&gt;(</span><br><span class="line">    authority: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    token_program: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    mint: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    from: AccountInfo&lt;<span class="symbol">&#x27;a</span>&gt;,</span><br><span class="line">    amount: <span class="type">u64</span>,</span><br><span class="line">    signer_seeds: &amp;[&amp;[&amp;[<span class="type">u8</span>]]],</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    token_2022::<span class="title function_ invoke__">burn</span>(</span><br><span class="line">        CpiContext::<span class="title function_ invoke__">new_with_signer</span>(</span><br><span class="line">            token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            token_2022::Burn &#123;</span><br><span class="line">                from,</span><br><span class="line">                authority,</span><br><span class="line">                mint,</span><br><span class="line">            &#125;,</span><br><span class="line">            signer_seeds,</span><br><span class="line">        ),</span><br><span class="line">        amount,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;instructions&#x2F;swap.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> anchor_lang::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::accounts_all::swap::*;</span><br><span class="line"><span class="keyword">use</span> crate::calculate::calculator::*;</span><br><span class="line"><span class="keyword">use</span> crate::error::ErrorCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::states::&#123;events::*, oracle::*&#125;;</span><br><span class="line"><span class="keyword">use</span> crate::util::token::*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_base_input</span>(</span><br><span class="line">    ctx: Context&lt;Swap&gt;,</span><br><span class="line">    input_amount: <span class="type">u64</span>,</span><br><span class="line">    minimun_ouput_amount: <span class="type">u64</span>,</span><br><span class="line">    <span class="comment">//min_pyth_price: u64,  可以选择性结合pyth_network价格，用于滑点控制</span></span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool_id</span> = ctx.accounts.pool_state.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool_state</span> = &amp;<span class="keyword">mut</span> ctx.accounts.pool_state.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">amm_config</span> = &amp;ctx.accounts.amm_config;</span><br><span class="line">    <span class="comment">//let token_min_price = &amp;min_pyth_price;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算基础转账费用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">transfer_fee</span> = <span class="title function_ invoke__">calculate_transfer_fee</span>(</span><br><span class="line">        &amp;ctx.accounts.input_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        input_amount,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查输入初始金额是否足够扣除基础手续费</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">actual_amount_in</span> = input_amount.<span class="title function_ invoke__">saturating_sub</span>(transfer_fee);</span><br><span class="line">    require_gt!(actual_amount_in, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算交换前实际交易金额</span></span><br><span class="line">    <span class="comment">// 从 token_0 兑换到 token_1</span></span><br><span class="line">    <span class="comment">// 从 token_1 兑换到 token_0</span></span><br><span class="line">    <span class="keyword">let</span> (</span><br><span class="line">        trade_direction,</span><br><span class="line">        total_input_token_amount,</span><br><span class="line">        total_output_token_amount,</span><br><span class="line">        token_0_price_x64,</span><br><span class="line">        token_1_price_x64,</span><br><span class="line">    ) = <span class="keyword">if</span> ctx.accounts.pool_input_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_0_vault</span><br><span class="line">        &amp;&amp; ctx.accounts.pool_output_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_1_vault</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//两个代币库的余额，减去协议+基金费用后的结果,获取实际可用数量</span></span><br><span class="line">        <span class="keyword">let</span> (total_input_token_amount, total_output_token_amount) = pool_state</span><br><span class="line">            .<span class="title function_ invoke__">vault_amount_without_fee</span>(</span><br><span class="line">                ctx.accounts.pool_input_vault.amount,</span><br><span class="line">                ctx.accounts.pool_output_vault.amount,</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取两个代币的当前价格</span></span><br><span class="line">        <span class="keyword">let</span> (token_0_price_x64, token_1_price_x64) = pool_state.<span class="title function_ invoke__">token_price_x32</span>(</span><br><span class="line">            ctx.accounts.pool_input_vault.amount,</span><br><span class="line">            ctx.accounts.pool_output_vault.amount,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        (</span><br><span class="line">            SwapDirection::ZeroForOne,</span><br><span class="line">            total_input_token_amount,</span><br><span class="line">            total_output_token_amount,</span><br><span class="line">            token_0_price_x64,</span><br><span class="line">            token_1_price_x64,</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ctx.accounts.pool_input_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_1_vault</span><br><span class="line">        &amp;&amp; ctx.accounts.pool_output_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_0_vault</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> (total_output_token_amount, total_input_token_amount) = pool_state</span><br><span class="line">            .<span class="title function_ invoke__">vault_amount_without_fee</span>(</span><br><span class="line">                ctx.accounts.pool_output_vault.amount,</span><br><span class="line">                ctx.accounts.pool_input_vault.amount,</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> (token_0_price_x64, token_1_price_x64) = pool_state.<span class="title function_ invoke__">token_price_x32</span>(</span><br><span class="line">            ctx.accounts.pool_input_vault.amount,</span><br><span class="line">            ctx.accounts.pool_output_vault.amount,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        (</span><br><span class="line">            SwapDirection::OneForZero,</span><br><span class="line">            total_input_token_amount,</span><br><span class="line">            total_output_token_amount,</span><br><span class="line">            token_0_price_x64,</span><br><span class="line">            token_1_price_x64,</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err!(ErrorCode::InvalidVault);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算交换前池内两种代币恒定乘积</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">const_before</span> = <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_input_token_amount)</span><br><span class="line">        .<span class="title function_ invoke__">checked_mul</span>(<span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_output_token_amount))</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算swap费用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = Calculator::<span class="title function_ invoke__">swap_input</span>(</span><br><span class="line">        <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(actual_amount_in),</span><br><span class="line">        <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_input_token_amount),</span><br><span class="line">        <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_output_token_amount),</span><br><span class="line">        amm_config.trade_fee_rate,</span><br><span class="line">        amm_config.protocol_fee_rate,</span><br><span class="line">        amm_config.fund_fee_rate,</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">ok_or</span>(ErrorCode::ZeroTradingTokens)?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算交易后的恒定乘积。</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">const_after</span> = <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(</span><br><span class="line">        result</span><br><span class="line">            .new_swap_source_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(result.trade_fee)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">checked_mul</span>(<span class="type">u128</span>::<span class="title function_ invoke__">from</span>(result.new_swap_destination_amount))</span><br><span class="line">    .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    require_eq!(</span><br><span class="line">        <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.source_amount_swapped).<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">        actual_amount_in</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> (input_transfer_amount, input_transfer_fee) = (input_amount, transfer_fee);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> (output_transfer_amount, output_transfer_fee) = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amount_out</span> = <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.destination_amount_swapped).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算输出代币的转账费用。</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">transfer_fee</span> = <span class="title function_ invoke__">calculate_transfer_fee</span>(</span><br><span class="line">            &amp;ctx.accounts.output_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            amount_out,</span><br><span class="line">        )?;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算用户实际收到的代币数量，即输出金额减去转账费用。</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">amount_received</span> = amount_out.<span class="title function_ invoke__">checked_sub</span>(transfer_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非零检查：确保用户实际收到的代币数量大于零。</span></span><br><span class="line">        require_gt!(amount_received, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查与预言机价格偏差</span></span><br><span class="line">        <span class="comment">// let is_valid_price =</span></span><br><span class="line">        <span class="comment">//     Calculator::verify_curve_and_oracle_price(*token_min_price, amount_received)?;</span></span><br><span class="line">        <span class="comment">// if !is_valid_price &#123;</span></span><br><span class="line">        <span class="comment">//     return Err(ErrorCode::InvalidArgument.into()); // 如果价格验证失败，返回错误</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//滑点检查</span></span><br><span class="line">        require_gte!(</span><br><span class="line">            amount_received,</span><br><span class="line">            minimun_ouput_amount,</span><br><span class="line">            ErrorCode::ExceededSlippage</span><br><span class="line">        );</span><br><span class="line">        (amount_out, transfer_fee)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">protocol_fee</span> = <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.protocol_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fund_fee</span> = <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.fund_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据交易方向更新协议费用</span></span><br><span class="line">    <span class="keyword">match</span> trade_direction &#123;</span><br><span class="line">        SwapDirection::ZeroForOne =&gt; &#123;</span><br><span class="line">            pool_state.protocol_fees_token_0 = pool_state</span><br><span class="line">                .protocol_fees_token_0</span><br><span class="line">                .<span class="title function_ invoke__">checked_add</span>(protocol_fee)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            pool_state.fund_fees_token_0 =</span><br><span class="line">                pool_state.fund_fees_token_0.<span class="title function_ invoke__">checked_add</span>(fund_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        SwapDirection::OneForZero =&gt; &#123;</span><br><span class="line">            pool_state.protocol_fees_token_1 = pool_state</span><br><span class="line">                .protocol_fees_token_1</span><br><span class="line">                .<span class="title function_ invoke__">checked_add</span>(protocol_fee)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">            pool_state.fund_fees_token_1 =</span><br><span class="line">                pool_state.fund_fees_token_1.<span class="title function_ invoke__">checked_add</span>(fund_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    emit!(SwapEvent &#123;</span><br><span class="line">        pool_id,</span><br><span class="line">        input_vault_before: total_input_token_amount,</span><br><span class="line">        output_vault_before: total_output_token_amount,</span><br><span class="line">        input_amount: <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.source_amount_swapped).<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">        output_amount: <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.destination_amount_swapped).<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">        input_transfer_fee,</span><br><span class="line">        output_transfer_fee,</span><br><span class="line">        base_input: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//确保交换后的常数大于等于交换前的常数。</span></span><br><span class="line">    require_gte!(const_after, const_before);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从用户账户将代币转移到池子的金库中。</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_user_to_pool_vault</span>(</span><br><span class="line">        ctx.accounts.payer.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.user_input_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.pool_input_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.input_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.input_token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        input_transfer_amount,</span><br><span class="line">        ctx.accounts.input_token_mint.decimals,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从池子金库转代币到用户账户</span></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.pool_output_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.user_output_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.output_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.output_token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        output_transfer_amount,</span><br><span class="line">        ctx.accounts.output_token_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[pool_state.auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新监视器价格</span></span><br><span class="line">    ctx.accounts.observation_state.<span class="title function_ invoke__">load_mut</span>()?.<span class="title function_ invoke__">update</span>(</span><br><span class="line">        <span class="title function_ invoke__">block_timestamp</span>(),</span><br><span class="line">        token_0_price_x64,</span><br><span class="line">        token_1_price_x64,</span><br><span class="line">    );</span><br><span class="line">    pool_state.recent_epoch = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//与上面代码类似</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_base_output</span>(</span><br><span class="line">    ctx: Context&lt;Swap&gt;,</span><br><span class="line">    max_amount_in: <span class="type">u64</span>,</span><br><span class="line">    amount_out_less_fee: <span class="type">u64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool_id</span> = ctx.accounts.pool_state.<span class="title function_ invoke__">key</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool_state</span> = &amp;<span class="keyword">mut</span> ctx.accounts.pool_state.<span class="title function_ invoke__">load_mut</span>()?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">out_transfer_fee</span> = <span class="title function_ invoke__">calculate_transfer_fee</span>(</span><br><span class="line">        &amp;ctx.accounts.output_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        amount_out_less_fee,</span><br><span class="line">    )?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">actual_amount_out</span> = amount_out_less_fee.<span class="title function_ invoke__">checked_add</span>(out_transfer_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> (</span><br><span class="line">        trade_direction,</span><br><span class="line">        total_input_token_amount,</span><br><span class="line">        total_output_token_amount,</span><br><span class="line">        token_0_price_x64,</span><br><span class="line">        token_1_price_x64,</span><br><span class="line">    ) = <span class="keyword">if</span> ctx.accounts.pool_input_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_0_vault</span><br><span class="line">        &amp;&amp; ctx.accounts.pool_output_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_1_vault</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> (total_input_token_amount, total_output_token_amount) = pool_state</span><br><span class="line">            .<span class="title function_ invoke__">vault_amount_without_fee</span>(</span><br><span class="line">                ctx.accounts.pool_input_vault.amount,</span><br><span class="line">                ctx.accounts.pool_output_vault.amount,</span><br><span class="line">            );</span><br><span class="line">        <span class="keyword">let</span> (token_0_price_x64, token_1_price_x64) = pool_state.<span class="title function_ invoke__">token_price_x32</span>(</span><br><span class="line">            ctx.accounts.pool_input_vault.amount,</span><br><span class="line">            ctx.accounts.pool_output_vault.amount,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        (</span><br><span class="line">            SwapDirection::ZeroForOne,</span><br><span class="line">            total_input_token_amount,</span><br><span class="line">            total_output_token_amount,</span><br><span class="line">            token_0_price_x64,</span><br><span class="line">            token_1_price_x64,</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ctx.accounts.pool_input_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_1_vault</span><br><span class="line">        &amp;&amp; ctx.accounts.pool_output_vault.<span class="title function_ invoke__">key</span>() == pool_state.token_0_vault</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> (total_output_token_amount, total_input_token_amount) = pool_state</span><br><span class="line">            .<span class="title function_ invoke__">vault_amount_without_fee</span>(</span><br><span class="line">                ctx.accounts.pool_output_vault.amount,</span><br><span class="line">                ctx.accounts.pool_input_vault.amount,</span><br><span class="line">            );</span><br><span class="line">        <span class="keyword">let</span> (token_0_price_x64, token_1_price_x64) = pool_state.<span class="title function_ invoke__">token_price_x32</span>(</span><br><span class="line">            ctx.accounts.pool_output_vault.amount,</span><br><span class="line">            ctx.accounts.pool_input_vault.amount,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        (</span><br><span class="line">            SwapDirection::OneForZero,</span><br><span class="line">            total_input_token_amount,</span><br><span class="line">            total_output_token_amount,</span><br><span class="line">            token_0_price_x64,</span><br><span class="line">            token_1_price_x64,</span><br><span class="line">        )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err!(ErrorCode::InvalidVault);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">constant_before</span> = <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_input_token_amount)</span><br><span class="line">        .<span class="title function_ invoke__">checked_mul</span>(<span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_output_token_amount))</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = Calculator::<span class="title function_ invoke__">swap_output</span>(</span><br><span class="line">        <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(actual_amount_out),</span><br><span class="line">        <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_input_token_amount),</span><br><span class="line">        <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(total_output_token_amount),</span><br><span class="line">        ctx.accounts.amm_config.trade_fee_rate,</span><br><span class="line">        ctx.accounts.amm_config.protocol_fee_rate,</span><br><span class="line">        ctx.accounts.amm_config.fund_fee_rate,</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">ok_or</span>(ErrorCode::ZeroTradingTokens)?;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">constant_after</span> = <span class="type">u128</span>::<span class="title function_ invoke__">from</span>(</span><br><span class="line">        result</span><br><span class="line">            .new_swap_source_amount</span><br><span class="line">            .<span class="title function_ invoke__">checked_sub</span>(result.trade_fee)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">checked_mul</span>(<span class="type">u128</span>::<span class="title function_ invoke__">from</span>(result.new_swap_destination_amount))</span><br><span class="line">    .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="string">&quot;enable-log&quot;</span>)]</span></span><br><span class="line">    msg!(</span><br><span class="line">        <span class="string">&quot;source_amount_swapped:&#123;&#125;, destination_amount_swapped:&#123;&#125;, trade_fee:&#123;&#125;, constant_before:&#123;&#125;,constant_after:&#123;&#125;&quot;</span>,</span><br><span class="line">        result.source_amount_swapped,</span><br><span class="line">        result.destination_amount_swapped,</span><br><span class="line">        result.trade_fee,</span><br><span class="line">        constant_before,</span><br><span class="line">        constant_after</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> (input_transfer_amount, input_transfer_fee) = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">source_amount_swapped</span> = <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.source_amount_swapped).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        require_gt!(source_amount_swapped, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">transfer_fee</span> = <span class="title function_ invoke__">calculate_transfer_inverse_fee</span>(</span><br><span class="line">            &amp;ctx.accounts.input_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">            source_amount_swapped,</span><br><span class="line">        )?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">input_transfer_amount</span> = source_amount_swapped.<span class="title function_ invoke__">checked_add</span>(transfer_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        require_gte!(</span><br><span class="line">            max_amount_in,</span><br><span class="line">            input_transfer_amount,</span><br><span class="line">            ErrorCode::ExceededSlippage</span><br><span class="line">        );</span><br><span class="line">        (input_transfer_amount, transfer_fee)</span><br><span class="line">    &#125;;</span><br><span class="line">    require_eq!(</span><br><span class="line">        <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.destination_amount_swapped).<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">        actual_amount_out</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">let</span> (output_transfer_amount, output_transfer_fee) = (actual_amount_out, out_transfer_fee);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">protocol_fee</span> = <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.protocol_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fund_fee</span> = <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.fund_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> trade_direction &#123;</span><br><span class="line">        SwapDirection::ZeroForOne =&gt; &#123;</span><br><span class="line">            pool_state.protocol_fees_token_0 = pool_state</span><br><span class="line">                .protocol_fees_token_0</span><br><span class="line">                .<span class="title function_ invoke__">checked_add</span>(protocol_fee)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            pool_state.fund_fees_token_0 =</span><br><span class="line">                pool_state.fund_fees_token_0.<span class="title function_ invoke__">checked_add</span>(fund_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        SwapDirection::OneForZero =&gt; &#123;</span><br><span class="line">            pool_state.protocol_fees_token_1 = pool_state</span><br><span class="line">                .protocol_fees_token_1</span><br><span class="line">                .<span class="title function_ invoke__">checked_add</span>(protocol_fee)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            pool_state.fund_fees_token_1 =</span><br><span class="line">                pool_state.fund_fees_token_1.<span class="title function_ invoke__">checked_add</span>(fund_fee).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    emit!(SwapEvent &#123;</span><br><span class="line">        pool_id,</span><br><span class="line">        input_vault_before: total_input_token_amount,</span><br><span class="line">        output_vault_before: total_output_token_amount,</span><br><span class="line">        input_amount: <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.source_amount_swapped).<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">        output_amount: <span class="type">u64</span>::<span class="title function_ invoke__">try_from</span>(result.destination_amount_swapped).<span class="title function_ invoke__">unwrap</span>(),</span><br><span class="line">        input_transfer_fee,</span><br><span class="line">        output_transfer_fee,</span><br><span class="line">        base_input: <span class="literal">false</span></span><br><span class="line">    &#125;);</span><br><span class="line">    require_gte!(constant_after, constant_before);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_user_to_pool_vault</span>(</span><br><span class="line">        ctx.accounts.payer.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.user_input_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.pool_input_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.input_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.input_token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        input_transfer_amount,</span><br><span class="line">        ctx.accounts.input_token_mint.decimals,</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">transfer_from_pool_vault_to_user</span>(</span><br><span class="line">        ctx.accounts.authority.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.pool_output_vault.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.user_output_token_account.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.output_token_mint.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        ctx.accounts.output_token_program.<span class="title function_ invoke__">to_account_info</span>(),</span><br><span class="line">        output_transfer_amount,</span><br><span class="line">        ctx.accounts.output_token_mint.decimals,</span><br><span class="line">        &amp;[&amp;[crate::AUTH_SEED.<span class="title function_ invoke__">as_bytes</span>(), &amp;[pool_state.auth_bump]]],</span><br><span class="line">    )?;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the previous price to the observation</span></span><br><span class="line">    ctx.accounts.observation_state.<span class="title function_ invoke__">load_mut</span>()?.<span class="title function_ invoke__">update</span>(</span><br><span class="line">        <span class="title function_ invoke__">block_timestamp</span>(),</span><br><span class="line">        token_0_price_x64,</span><br><span class="line">        token_1_price_x64,</span><br><span class="line">    );</span><br><span class="line">    pool_state.recent_epoch = Clock::<span class="title function_ invoke__">get</span>()?.epoch;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>anchor&#x2F;programs&#x2F;swap&#x2F;src&#x2F;lib.rs</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_base_input</span>(</span><br><span class="line">       ctx: Context&lt;Swap&gt;,</span><br><span class="line">       amount_in: <span class="type">u64</span>,</span><br><span class="line">       minimum_amount_out: <span class="type">u64</span>,</span><br><span class="line">       <span class="comment">//min_pyth_price: u64,</span></span><br><span class="line">   ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">       instructions::<span class="title function_ invoke__">swap_base_input</span>(ctx, amount_in, minimum_amount_out)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swap_base_output</span>(</span><br><span class="line">       ctx: Context&lt;Swap&gt;,</span><br><span class="line">       amount_in: <span class="type">u64</span>,</span><br><span class="line">       minimum_amount_out: <span class="type">u64</span>,</span><br><span class="line">       <span class="comment">//min_pyth_price: u64,</span></span><br><span class="line">   ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">       instructions::<span class="title function_ invoke__">swap_base_output</span>(ctx, amount_in, minimum_amount_out)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>


<h1 id="前端测试代码："><a href="#前端测试代码：" class="headerlink" title="前端测试代码："></a>前端测试代码：</h1><p>anchor&#x2F;example&#x2F;api&#x2F;swap.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> anchor <span class="keyword">from</span> <span class="string">&#x27;@coral-xyz/anchor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; program, provider &#125; <span class="keyword">from</span> <span class="string">&#x27;./wallet&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PublicKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@solana/web3.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">SwapBaseInput</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">amount_In</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="attr">minimumAmountOut</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="comment">//minPythPrice: anchor.BN,  //可根据之前Pyth章节获取价格数据，前端进行处理后传进来</span></span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">userInputTokenAccount</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">userOutputTokenAccount</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [poolStatePda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> poolState = program.<span class="property">account</span>.<span class="property">poolState</span>.<span class="title function_">fetch</span>(poolStatePda);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">swapBaseInput</span>(amount_In, minimumAmountOut)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">ammConfig</span>: ammConfigPda,</span><br><span class="line">      <span class="attr">observationState</span>: (<span class="keyword">await</span> poolState).<span class="property">observationKey</span>,</span><br><span class="line">      <span class="attr">poolState</span>: poolStatePda,</span><br><span class="line">      <span class="attr">userInputTokenAccount</span>: userInputTokenAccount,</span><br><span class="line">      <span class="attr">userOutputTokenAccount</span>: userOutputTokenAccount,</span><br><span class="line">      <span class="attr">poolInputVault</span>: (<span class="keyword">await</span> poolState).<span class="property">token0Vault</span>,</span><br><span class="line">      <span class="attr">poolOutputVault</span>: (<span class="keyword">await</span> poolState).<span class="property">token1Vault</span>,</span><br><span class="line">      <span class="attr">inputTokenProgram</span>: (<span class="keyword">await</span> poolState).<span class="property">token0Program</span>,</span><br><span class="line">      <span class="attr">outputTokenProgram</span>: (<span class="keyword">await</span> poolState).<span class="property">token1Program</span>,</span><br><span class="line">      <span class="attr">inputTokenMint</span>: token0Mint,</span><br><span class="line">      <span class="attr">outputTokenMint</span>: token1Mint,</span><br><span class="line">      <span class="attr">payer</span>: wallet.<span class="property">publicKey</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">SwapBaseOutput</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">wallet</span>: anchor.<span class="title class_">Wallet</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">amount_In</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="attr">minimumAmountOut</span>: anchor.BN,</span></span><br><span class="line"><span class="params">  <span class="comment">//minPythPrice: anchor.BN,</span></span></span><br><span class="line"><span class="params">  <span class="attr">token0Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">token1Mint</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">userInputTokenAccount</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">userOutputTokenAccount</span>: anchor.web3.<span class="title class_">PublicKey</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">index</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [ammConfigPda] = <span class="keyword">await</span> <span class="title class_">PublicKey</span>.<span class="title function_">findProgramAddress</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;AMM_Config&#x27;</span>), <span class="title function_">u16ToBytes</span>(index)],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [poolStatePda] = anchor.<span class="property">web3</span>.<span class="property">PublicKey</span>.<span class="title function_">findProgramAddressSync</span>(</span><br><span class="line">    [<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&#x27;pool_v1&#x27;</span>), ammConfigPda.<span class="title function_">toBuffer</span>(), token0Mint.<span class="title function_">toBuffer</span>(), token1Mint.<span class="title function_">toBuffer</span>()],</span><br><span class="line">    program.<span class="property">programId</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> poolState = program.<span class="property">account</span>.<span class="property">poolState</span>.<span class="title function_">fetch</span>(poolStatePda);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> program.<span class="property">methods</span></span><br><span class="line">    .<span class="title function_">swapBaseInput</span>(amount_In, minimumAmountOut)</span><br><span class="line">    .<span class="title function_">accounts</span>(&#123;</span><br><span class="line">      <span class="attr">ammConfig</span>: ammConfigPda,</span><br><span class="line">      <span class="attr">observationState</span>: (<span class="keyword">await</span> poolState).<span class="property">observationKey</span>,</span><br><span class="line">      <span class="attr">poolState</span>: poolStatePda,</span><br><span class="line">      <span class="attr">userInputTokenAccount</span>: userInputTokenAccount,</span><br><span class="line">      <span class="attr">userOutputTokenAccount</span>: userOutputTokenAccount,</span><br><span class="line">      <span class="attr">poolInputVault</span>: (<span class="keyword">await</span> poolState).<span class="property">token0Vault</span>,</span><br><span class="line">      <span class="attr">poolOutputVault</span>: (<span class="keyword">await</span> poolState).<span class="property">token1Vault</span>,</span><br><span class="line">      <span class="attr">inputTokenProgram</span>: (<span class="keyword">await</span> poolState).<span class="property">token0Program</span>,</span><br><span class="line">      <span class="attr">outputTokenProgram</span>: (<span class="keyword">await</span> poolState).<span class="property">token1Program</span>,</span><br><span class="line">      <span class="attr">inputTokenMint</span>: token0Mint,</span><br><span class="line">      <span class="attr">outputTokenMint</span>: token1Mint,</span><br><span class="line">      <span class="attr">payer</span>: wallet.<span class="property">publicKey</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">signers</span>([wallet.<span class="property">payer</span>])</span><br><span class="line">    .<span class="title function_">rpc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">u16ToBytes</span>(<span class="params"><span class="attr">num</span>: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(arr);</span><br><span class="line">  view.<span class="title function_">setUint16</span>(<span class="number">0</span>, num, <span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">const</span> <span class="variable constant_">TOKEN_DEV_PROGRAM_ID</span> = <span class="keyword">new</span> <span class="title class_">PublicKey</span>(<span class="string">&#x27;TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> usdcDevTokenMint = <span class="keyword">new</span> <span class="title class_">PublicKey</span>(<span class="string">&#x27;4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> eurcDevTokenMint = <span class="keyword">new</span> <span class="title class_">PublicKey</span>(<span class="string">&#x27;HzwqbKZw8HxMN6bF2yFZNrht3c2iXXzpKcFu7uBEDKtr&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取钱包的 USDC 和 EURC 的TokenAccount代币地址，是接收代币时候钱包自动创建的</span></span><br><span class="line">  <span class="keyword">const</span> usdcTokenAccounts = <span class="keyword">await</span> connection.<span class="title function_">getTokenAccountsByOwner</span>(provider.<span class="property">wallet</span>.<span class="property">publicKey</span>, &#123;</span><br><span class="line">    <span class="attr">programId</span>: <span class="variable constant_">TOKEN_DEV_PROGRAM_ID</span>,</span><br><span class="line">    <span class="attr">mint</span>: usdcDevTokenMint,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;usdcTokenAccounts is&#x27;</span>, usdcTokenAccounts.<span class="property">value</span>[<span class="number">0</span>].<span class="property">pubkey</span>);</span><br><span class="line">  <span class="keyword">const</span> eurcTokenAccounts = <span class="keyword">await</span> connection.<span class="title function_">getTokenAccountsByOwner</span>(provider.<span class="property">wallet</span>.<span class="property">publicKey</span>, &#123;</span><br><span class="line">    <span class="attr">programId</span>: <span class="variable constant_">TOKEN_DEV_PROGRAM_ID</span>,</span><br><span class="line">    <span class="attr">mint</span>: eurcDevTokenMint,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;eurcTokenAccounts is&#x27;</span>, eurcTokenAccounts.<span class="property">value</span>[<span class="number">0</span>].<span class="property">pubkey</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//根据输入进行交换</span></span><br><span class="line">  <span class="keyword">const</span> swap_in_result = <span class="keyword">await</span> <span class="title class_">SwapBaseInput</span>(</span><br><span class="line">    defaultWallet,</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">1_500_000</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">640_000</span>),</span><br><span class="line">    usdcDevTokenMint,</span><br><span class="line">    eurcDevTokenMint,</span><br><span class="line">    usdcTokenAccounts.<span class="property">value</span>[<span class="number">0</span>].<span class="property">pubkey</span>,</span><br><span class="line">    eurcTokenAccounts.<span class="property">value</span>[<span class="number">0</span>].<span class="property">pubkey</span>,</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(swap_in_result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//根据输出进行交换</span></span><br><span class="line">  <span class="keyword">const</span> swap_out_result = <span class="keyword">await</span> <span class="title class_">SwapBaseOutput</span>(</span><br><span class="line">    defaultWallet,</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">1_500_000</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title function_">BN</span>(<span class="number">640_000</span>),</span><br><span class="line">    usdcDevTokenMint,</span><br><span class="line">    eurcDevTokenMint,</span><br><span class="line">    usdcTokenAccounts.<span class="property">value</span>[<span class="number">0</span>].<span class="property">pubkey</span>,</span><br><span class="line">    eurcTokenAccounts.<span class="property">value</span>[<span class="number">0</span>].<span class="property">pubkey</span>,</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(swap_out_result);  <span class="comment">// 可上solscan查看交易</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">//获取池对象信息</span></span><br><span class="line">  <span class="keyword">const</span> pool_state = <span class="keyword">await</span> <span class="title function_">getPoolStateInfo</span>(defaultWallet, usdcDevTokenMint, eurcDevTokenMint, <span class="number">6</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pool_state is&#x27;</span>, pool_state);  <span class="comment">//还可以留意下 protocol_fee和fund_fee，均发生变化</span></span><br></pre></td></tr></table></figure>



          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="qsunou@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">QsunOu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
